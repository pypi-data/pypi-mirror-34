

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Quickstart &mdash; Inmanta 2017.4dev documentation</title>
  

  
  
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="Inmanta 2017.4dev documentation" href="index.html"/>
        <link rel="next" title="Install Inmanta" href="install.html"/>
        <link rel="prev" title="Inmanta Documentation" href="index.html"/>
<style>
.version a:visited {
  color: rgba(255,255,255,0.3);
}
</style>


  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          


    <a href="index.html">



  
    <img src="_static/inmanta-logo.png" class="logo" />

    </a>
    <div class="version">
      <a href="/" class="icon icon-home"> Documentation home</a>
    </div>
    <div class="version">
      2017.4dev
    </div>

    
  
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>


        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Quickstart</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#setting-up-the-tutorial">Setting up the tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="#automatically-deploying-drupal">Automatically deploying Drupal</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#single-machine-deployment-using-the-cli">Single machine deployment using the CLI</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#reuse-existing-modules">Reuse existing modules</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-configuration-model">The configuration model</a></li>
<li class="toctree-l4"><a class="reference internal" href="#deploy-the-configuration-model">Deploy the configuration model</a></li>
<li class="toctree-l4"><a class="reference internal" href="#accessing-your-new-drupal-server">Accessing your new Drupal server</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#multi-machine-deployment-using-the-cli">Multi-machine deployment using the CLI</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#update-the-configuration-model">Update the configuration model</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id1">Deploy the configuration model</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#using-the-dashboard">Using the dashboard</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#create-your-own-modules">Create your own modules</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#module-layout">Module layout</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuration-model">Configuration model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-composition">The composition</a></li>
<li class="toctree-l3"><a class="reference internal" href="#deploy-the-changes">Deploy the changes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#next-steps">Next steps</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="install.html">Install Inmanta</a></li>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="language.html">Language Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="guides.html">Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="moduleguides.html">Module guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="developers.html">Developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="reference/index.html">Inmanta Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Inmanta</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Quickstart</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="quickstart">
<h1>Quickstart<a class="headerlink" href="#quickstart" title="Permalink to this headline">¶</a></h1>
<p>This tutorial gets you started with the Inmanta orchestration tool.</p>
<p>Inmanta is intended to manage complex infrastructures, often in the cloud or other virtualized environments.
In this guide, we go for a less complex setup: install the Drupal CMS on two VMs.
First, we use vagrant to setup a basic environment with two empty VMs and an Inmanta server.
Then, we use Inmanta to install Drupal on these VMs.</p>
<div class="section" id="setting-up-the-tutorial">
<h2>Setting up the tutorial<a class="headerlink" href="#setting-up-the-tutorial" title="Permalink to this headline">¶</a></h2>
<p>To quickly get started with Inmanta, use Vagrant to set up an environment to host the Inmanta server and some machines to be
managed. Before starting this tutorial, first <a class="reference external" href="https://www.vagrantup.com/docs/installation/">install vagrant on your machine</a>.</p>
<p>Next, grab the Vagrant box from our Git repo and let Vagrant do the setup of the Inmanta server.</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>git clone https://github.com/inmanta/quickstart-vagrant.git
<span class="nb">cd</span> quickstart-vagrant
./make_keys.sh
vagrant up
</pre></div>
</div>
<p>Vagrant will set up the Inmanta server and two VMs to experiment on.
When Vagrant is ready, you should be able to open the dashboard at <a class="reference external" href="http://127.0.0.1:8888">http://127.0.0.1:8888</a>.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>When using Vagrant in combination with VirtualBox, there is a known issue with SSH keys.
If this problem occurs to you, add the following lines to the Vagrantfile:</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>config.ssh.insert_key <span class="o">=</span> <span class="nb">false</span>
</pre></div>
</div>
<p class="last">Notice that you are using a default key, this is insecure.</p>
</div>
<p>To get a shell on the Inmanta server:</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>vagrant ssh server
</pre></div>
</div>
</div>
<div class="section" id="automatically-deploying-drupal">
<h2>Automatically deploying Drupal<a class="headerlink" href="#automatically-deploying-drupal" title="Permalink to this headline">¶</a></h2>
<p>At this point, you can go through the quickstart guide in two ways: via the dashboard or via the command line interface.
For the CLI, go to the next section. For the Dashboard, go to <a class="reference internal" href="#qsdashboard"><span class="std std-ref">Using the dashboard</span></a>.</p>
<div class="section" id="single-machine-deployment-using-the-cli">
<span id="cli"></span><h3>Single machine deployment using the CLI<a class="headerlink" href="#single-machine-deployment-using-the-cli" title="Permalink to this headline">¶</a></h3>
<p>An Inmanta project bundles modules that contain configuration information. A project is nothing more
than a directory with a project.yml file, which contains parameters such as the location to search for
modules and where to find the server.</p>
<p>Here we will get a project from github.</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>git clone https://github.com/inmanta/quickstart.git
<span class="nb">cd</span> quickstart
</pre></div>
</div>
<p>The configuration file <code class="docutils literal"><span class="pre">project.yml</span></code> defines that reusable modules are stored in <code class="docutils literal"><span class="pre">libs</span></code>.</p>
<p>In the next section we will use existing modules to deploy our LAMP stack.</p>
<div class="section" id="reuse-existing-modules">
<h4>Reuse existing modules<a class="headerlink" href="#reuse-existing-modules" title="Permalink to this headline">¶</a></h4>
<p>At GitHub, we host modules to setup and manage many systems. Our modules are available in the <a class="reference external" href="https://github.com/inmanta/">https://github.com/inmanta/</a> repositories.</p>
<p>When you use an import statement in your model, Inmanta downloads these modules and their dependencies automatically.</p>
</div>
<div class="section" id="the-configuration-model">
<span id="qsconfigmodel"></span><h4>The configuration model<a class="headerlink" href="#the-configuration-model" title="Permalink to this headline">¶</a></h4>
<p>In this section we will use the configuration concepts defined in the existing modules to set up Drupal on the host named <code class="docutils literal"><span class="pre">vm1</span></code>.</p>
<p>First, create a new <code class="docutils literal"><span class="pre">main.cf</span></code> file or execute <code class="docutils literal"><span class="pre">git</span> <span class="pre">checkout</span> <span class="pre">single_machine</span></code>:</p>
<div class="highlight-inmanta"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="n">ip</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="n">redhat</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="n">redhat</span><span class="o">::</span><span class="n">epel</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="n">apache</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="n">mysql</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="n">web</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="n">drupal</span><span class="w"></span>

<span class="c1"># define the machine we want to deploy Drupal on</span>
<span class="n">vm1</span><span class="o">=</span><span class="nc">ip::Host</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;vm1&quot;</span><span class="o">,</span><span class="w"> </span><span class="n">os</span><span class="o">=</span><span class="n">redhat</span><span class="o">::</span><span class="n">centos7</span><span class="o">,</span><span class="w"> </span><span class="n">ip</span><span class="o">=</span><span class="s">&quot;192.168.33.101&quot;</span><span class="o">,</span><span class="w"> </span><span class="n">remote_agent</span><span class="o">=</span><span class="k">true</span><span class="o">,</span><span class="w"></span>
<span class="w">             </span><span class="n">remote_user</span><span class="o">=</span><span class="s">&quot;vagrant&quot;</span><span class="o">)</span><span class="w"></span>

<span class="c1"># add a mysql and apache http server</span>
<span class="n">web_server</span><span class="o">=</span><span class="nc">apache::Server</span><span class="o">(</span><span class="n">host</span><span class="o">=</span><span class="n">vm1</span><span class="o">)</span><span class="w"></span>
<span class="n">mysql_server</span><span class="o">=</span><span class="nc">mysql::Server</span><span class="o">(</span><span class="n">host</span><span class="o">=</span><span class="n">vm1</span><span class="o">)</span><span class="w"></span>

<span class="c1"># deploy drupal in that virtual host</span>
<span class="n">name</span><span class="o">=</span><span class="nc">web::Alias</span><span class="o">(</span><span class="n">hostname</span><span class="o">=</span><span class="s">&quot;localhost&quot;</span><span class="o">)</span><span class="w"></span>
<span class="n">db</span><span class="o">=</span><span class="nc">mysql::Database</span><span class="o">(</span><span class="n">server</span><span class="o">=</span><span class="n">mysql_server</span><span class="o">,</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s">&quot;drupal_test&quot;</span><span class="o">,</span><span class="w"> </span><span class="n">user</span><span class="o">=</span><span class="s">&quot;drupal_test&quot;</span><span class="o">,</span><span class="w"></span>
<span class="w">                   </span><span class="n">password</span><span class="o">=</span><span class="s">&quot;Str0ng-P433w0rd&quot;</span><span class="o">)</span><span class="w"></span>
<span class="nc">drupal::Application</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">,</span><span class="w"> </span><span class="n">container</span><span class="o">=</span><span class="n">web_server</span><span class="o">,</span><span class="w"> </span><span class="n">database</span><span class="o">=</span><span class="n">db</span><span class="o">,</span><span class="w"> </span><span class="n">admin_user</span><span class="o">=</span><span class="s">&quot;admin&quot;</span><span class="o">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">admin_password</span><span class="o">=</span><span class="s">&quot;test&quot;</span><span class="o">,</span><span class="w"> </span><span class="n">admin_email</span><span class="o">=</span><span class="s">&quot;admin@example.com&quot;</span><span class="o">,</span><span class="w"> </span><span class="n">site_name</span><span class="o">=</span><span class="s">&quot;localhost&quot;</span><span class="o">)</span><span class="w"></span>
</pre></div>
</td></tr></table></div>
<ul class="simple">
<li>Lines 1-6 import all required packages.</li>
<li>Line 9 defines on which machine we want to deploy Drupal.</li>
</ul>
<blockquote>
<div><ul class="simple">
<li>The <em>name</em> attribute is the host name of the machine, which is later used to determine what configuration needs to be deployed on which machine.</li>
<li>The <em>os</em> attribute defines which operating system this server runs. This is used to select the right tools (yum or dnf or apt).</li>
<li>The <em>ip</em> attribute is the IP address of this host. At this moment we define this attribute manually, later in the tutorial we let Inmanta discover this automatically.</li>
</ul>
</div></blockquote>
<ul class="simple">
<li>Lines 12 and 13 deploy an Apache server and MySQL server on our host.</li>
<li>Line 16 defines the name (host name) of the web application.</li>
<li>Lines 17-18 define a database for our Drupal website.</li>
<li>Lines 19-20 define the actual Drupal application.</li>
</ul>
</div>
<div class="section" id="deploy-the-configuration-model">
<h4>Deploy the configuration model<a class="headerlink" href="#deploy-the-configuration-model" title="Permalink to this headline">¶</a></h4>
<p>To deploy the project, we must first register it with the management server, by creating a project and an environment. A project is a collection of related environments. (e.g. development, testing, production, qa,…)
An environment is associated with a branch in a git repository. This allows the server to recompile the model when the environment changes.</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>inmanta-cli project create -n <span class="nb">test</span>
inmanta-cli environment create -n quickstart-env -p <span class="nb">test</span> -r https://github.com/inmanta/quickstart.git -b master --save
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <code class="docutils literal"><span class="pre">--save</span></code> option tells <code class="docutils literal"><span class="pre">inmanta-cli</span></code> to store the environment config in the <code class="docutils literal"><span class="pre">.inmanta</span></code> file. The compiler uses this file to find the server and to export to the right environment.</p>
</div>
<p>Then compile the project and send it to the server:</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>inmanta -vvv  <span class="nb">export</span> -d
</pre></div>
</div>
<p>The first time you run this command may take a while, as all dependencies are downloaded.</p>
<p>When the model is sent to the server, it will start deploying the configuration.
To track progress, you can go to the <a class="reference external" href="http://127.0.0.1:8888">dashboard</a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <code class="docutils literal"><span class="pre">-vvv</span></code> option sets the output of the compiler to very verbose.
The <code class="docutils literal"><span class="pre">-d</span></code> option instructs the server to immediately start the deploy.</p>
</div>
</div>
<div class="section" id="accessing-your-new-drupal-server">
<h4>Accessing your new Drupal server<a class="headerlink" href="#accessing-your-new-drupal-server" title="Permalink to this headline">¶</a></h4>
<p>When the installation is done, you can access your new Drupal server at <a class="reference external" href="http://localhost:8080/">http://localhost:8080/</a>.</p>
</div>
</div>
<div class="section" id="multi-machine-deployment-using-the-cli">
<h3>Multi-machine deployment using the CLI<a class="headerlink" href="#multi-machine-deployment-using-the-cli" title="Permalink to this headline">¶</a></h3>
<p>The real power of Inmanta appears when you want to manage more than one machine. In this section we will
move the MySQL server from <code class="docutils literal"><span class="pre">vm1</span></code> to a second virtual machine called <code class="docutils literal"><span class="pre">vm2</span></code>.</p>
<div class="section" id="update-the-configuration-model">
<h4>Update the configuration model<a class="headerlink" href="#update-the-configuration-model" title="Permalink to this headline">¶</a></h4>
<p>A second virtual machine is easily added to the system by adding the definition
of the virtual machine to the configuration model and assigning the MySQL server
to the new virtual machine. Update <code class="docutils literal"><span class="pre">main.cf</span></code> to the following:</p>
<div class="highlight-inmanta"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># define the machine we want to deploy Drupal on</span>
<span class="n">vm1</span><span class="o">=</span><span class="nc">ip::Host</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;vm1&quot;</span><span class="o">,</span><span class="w"> </span><span class="n">os</span><span class="o">=</span><span class="n">redhat</span><span class="o">::</span><span class="n">centos7</span><span class="o">,</span><span class="w"> </span><span class="n">ip</span><span class="o">=</span><span class="s">&quot;192.168.33.101&quot;</span><span class="o">,</span><span class="w"> </span><span class="n">remote_agent</span><span class="o">=</span><span class="k">true</span><span class="o">,</span><span class="w"></span>
<span class="w">             </span><span class="n">remote_user</span><span class="o">=</span><span class="s">&quot;vagrant&quot;</span><span class="o">)</span><span class="w"></span>
<span class="n">vm2</span><span class="o">=</span><span class="nc">ip::Host</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;vm2&quot;</span><span class="o">,</span><span class="w"> </span><span class="n">os</span><span class="o">=</span><span class="n">redhat</span><span class="o">::</span><span class="n">centos7</span><span class="o">,</span><span class="w"> </span><span class="n">ip</span><span class="o">=</span><span class="s">&quot;192.168.33.102&quot;</span><span class="o">,</span><span class="w"> </span><span class="n">remote_agent</span><span class="o">=</span><span class="k">true</span><span class="o">,</span><span class="w"></span>
<span class="w">             </span><span class="n">remote_user</span><span class="o">=</span><span class="s">&quot;vagrant&quot;</span><span class="o">)</span><span class="w"></span>

<span class="c1"># add a mysql and apache http server</span>
<span class="n">web_server</span><span class="o">=</span><span class="nc">apache::Server</span><span class="o">(</span><span class="n">host</span><span class="o">=</span><span class="n">vm1</span><span class="o">)</span><span class="w"></span>
<span class="n">mysql_server</span><span class="o">=</span><span class="nc">mysql::Server</span><span class="o">(</span><span class="n">host</span><span class="o">=</span><span class="n">vm2</span><span class="o">)</span><span class="w"></span>

<span class="c1"># deploy drupal in that virtual host</span>
<span class="n">name</span><span class="o">=</span><span class="nc">web::Alias</span><span class="o">(</span><span class="n">hostname</span><span class="o">=</span><span class="s">&quot;localhost&quot;</span><span class="o">)</span><span class="w"></span>
<span class="n">db</span><span class="o">=</span><span class="nc">mysql::Database</span><span class="o">(</span><span class="n">server</span><span class="o">=</span><span class="n">mysql_server</span><span class="o">,</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s">&quot;drupal_test&quot;</span><span class="o">,</span><span class="w"> </span><span class="n">user</span><span class="o">=</span><span class="s">&quot;drupal_test&quot;</span><span class="o">,</span><span class="w"></span>
<span class="w">                   </span><span class="n">password</span><span class="o">=</span><span class="s">&quot;Str0ng-P433w0rd&quot;</span><span class="o">)</span><span class="w"></span>
<span class="nc">drupal::Application</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">,</span><span class="w"> </span><span class="n">container</span><span class="o">=</span><span class="n">web_server</span><span class="o">,</span><span class="w"> </span><span class="n">database</span><span class="o">=</span><span class="n">db</span><span class="o">,</span><span class="w"> </span><span class="n">admin_user</span><span class="o">=</span><span class="s">&quot;admin&quot;</span><span class="o">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">admin_password</span><span class="o">=</span><span class="s">&quot;test&quot;</span><span class="o">,</span><span class="w"> </span><span class="n">admin_email</span><span class="o">=</span><span class="s">&quot;admin@example.com&quot;</span><span class="o">,</span><span class="w"> </span><span class="n">site_name</span><span class="o">=</span><span class="s">&quot;localhost&quot;</span><span class="o">)</span><span class="w"></span>
</pre></div>
</td></tr></table></div>
<p>On line 3 the definition of the new virtual machine is added. On line 7 the
MySQL server is assigned to vm2.</p>
</div>
<div class="section" id="id1">
<h4>Deploy the configuration model<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>To deploy the configuration model, compile the project and send it to the server:</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>inmanta -vvv <span class="nb">export</span> -d
</pre></div>
</div>
<p>If you browse to the Drupal site again, the database should be empty once more.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When moving the database, a new database is created, thus the content of the old database is not migrated automatically.</p>
</div>
</div>
</div>
<div class="section" id="using-the-dashboard">
<span id="qsdashboard"></span><h3>Using the dashboard<a class="headerlink" href="#using-the-dashboard" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">Go to the <a class="reference external" href="http://127.0.0.1:8888">dashboard</a>.</p>
</li>
<li><p class="first">Create a new project with the name <code class="docutils literal"><span class="pre">test</span></code> by clicking <em>Add new project</em>.</p>
</li>
<li><p class="first">Go into the new project and create a new environment by clicking <em>Add new environment</em>:</p>
<blockquote>
<div><ul class="simple">
<li>Select the <code class="docutils literal"><span class="pre">test</span></code> project.</li>
<li>Give the environment a name, e.g. <code class="docutils literal"><span class="pre">env-quickstart</span></code>.</li>
<li>Specify the repo: <code class="docutils literal"><span class="pre">https://github.com/inmanta/quickstart</span></code>.</li>
<li>Specify the branch: <code class="docutils literal"><span class="pre">master</span></code>.</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">Go into your new environment.</p>
</li>
<li><p class="first">Press <em>Update &amp; Recompile</em> (this may take a while, as all dependencies are downloaded).</p>
<blockquote>
<div><ul class="simple">
<li>Now the Inmanta server downloads the configuration model from GitHub. It also downloads all required modules (i.e. dependencies). These modules contain the instructions to install specific parts of the setup such as for example <cite>mysql</cite> or <cite>drupal</cite> itself. To see the source go <a class="reference external" href="https://github.com/inmanta/quickstart">here</a>, for a more in-depth explanation <a class="reference internal" href="#qsconfigmodel"><span class="std std-ref">see above</span></a>.</li>
<li>When this is done, it compiles all modules and integrates them into a new deployment plan.</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">When the compilation is done, a new version appears. This contains the new deployment plan. Click on this version to open it. This shows a list of all configuration items in this configuration.</p>
</li>
<li><p class="first">Press <em>Deploy</em> to start rolling out this version.</p>
<blockquote>
<div><ul class="simple">
<li>An agent is now started that remotely logs in into the virtual machines (via SSH) and starts deploying the Drupal server.</li>
<li>It will automatically install the required software and configure it properly.</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">When the deployment is done, you can find your freshly deployed Drupal instance at <a class="reference external" href="http://localhost:8080/">http://localhost:8080/</a>.</p>
</li>
</ol>
</div>
</div>
<div class="section" id="create-your-own-modules">
<h2>Create your own modules<a class="headerlink" href="#create-your-own-modules" title="Permalink to this headline">¶</a></h2>
<p>Inmanta enables developers of a configuration model to make it modular and
reusable. In this section we create a configuration module that defines how to
deploy a LAMP stack with a Drupal site in a two- or three-tiered deployment.</p>
<div class="section" id="module-layout">
<h3>Module layout<a class="headerlink" href="#module-layout" title="Permalink to this headline">¶</a></h3>
<p>A configuration module requires a specific layout:</p>
<blockquote>
<div><ul class="simple">
<li>The name of the module is determined by the top-level directory. Within this
module directory, a <code class="docutils literal"><span class="pre">module.yml</span></code> file has to be specified.</li>
<li>The only mandatory subdirectory is the <code class="docutils literal"><span class="pre">model</span></code> directory containing a file
called <code class="docutils literal"><span class="pre">_init.cf</span></code>. What is defined in the <code class="docutils literal"><span class="pre">_init.cf</span></code> file is available in the namespace linked with
the name of the module. Other files in the model directory create subnamespaces.</li>
<li>The <code class="docutils literal"><span class="pre">files</span></code> directory contains files that are deployed verbatim to managed
machines.</li>
<li>The <code class="docutils literal"><span class="pre">templates</span></code> directory contains templates that use parameters from the
configuration model to generate configuration files.</li>
<li>The <code class="docutils literal"><span class="pre">plugins</span></code> directory contains Python files that are loaded by the platform and can
extend it using the Inmanta API.</li>
</ul>
</div></blockquote>
<div class="highlight-sh"><div class="highlight"><pre><span></span>module
<span class="p">|</span>
<span class="p">|</span>__ module.yml
<span class="p">|</span>
<span class="p">|</span>__ files
<span class="p">|</span>    <span class="p">|</span>__ file1.txt
<span class="p">|</span>
<span class="p">|</span>__ model
<span class="p">|</span>    <span class="p">|</span>__ _init.cf
<span class="p">|</span>    <span class="p">|</span>__ services.cf
<span class="p">|</span>
<span class="p">|</span>__ plugins
<span class="p">|</span>    <span class="p">|</span>__ functions.py
<span class="p">|</span>
<span class="p">|</span>__ templates
     <span class="p">|</span>__ conf_file.conf.tmpl
</pre></div>
</div>
<p>We will create our custom module in the <code class="docutils literal"><span class="pre">libs</span></code> directory of the quickstart project. Our new module
will be called <em>lamp</em>, and we require the <code class="docutils literal"><span class="pre">_init.cf</span></code> file (in the <code class="docutils literal"><span class="pre">model</span></code> subdirectory) and
the <code class="docutils literal"><span class="pre">module.yml</span></code> file to have a valid Inmanta module.
The following commands create all directories and files to develop a full-featured module:</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="nb">cd</span> ~/quickstart/libs
mkdir <span class="o">{</span>lamp,lamp/model<span class="o">}</span>
touch lamp/model/_init.cf
touch lamp/module.yml
</pre></div>
</div>
<p>Next, edit the <code class="docutils literal"><span class="pre">lamp/module.yml</span></code> file and add meta-data to it:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">lamp</span>
<span class="l l-Scalar l-Scalar-Plain">license</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Apache 2.0</span>
<span class="l l-Scalar l-Scalar-Plain">version</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0.1</span>
</pre></div>
</div>
</div>
<div class="section" id="configuration-model">
<h3>Configuration model<a class="headerlink" href="#configuration-model" title="Permalink to this headline">¶</a></h3>
<p>In <code class="docutils literal"><span class="pre">lamp/model/_init.cf</span></code> we define the configuration model that defines the <em>lamp</em>
configuration module.</p>
<div class="highlight-inmanta"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="n">ip</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="n">apache</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="n">mysql</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="n">web</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="n">drupal</span><span class="w"></span>

<span class="k">entity</span><span class="w"> </span><span class="nc">DrupalStack</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="nb">string</span><span class="w"> </span><span class="n">hostname</span><span class="w"></span>
<span class="w">    </span><span class="nb">string</span><span class="w"> </span><span class="n">admin_user</span><span class="w"></span>
<span class="w">    </span><span class="nb">string</span><span class="w"> </span><span class="n">admin_password</span><span class="w"></span>
<span class="w">    </span><span class="nb">string</span><span class="w"> </span><span class="n">admin_email</span><span class="w"></span>
<span class="w">    </span><span class="nb">string</span><span class="w"> </span><span class="n">site_name</span><span class="w"></span>
<span class="k">end</span><span class="w"></span>

<span class="k">index</span><span class="w"> </span><span class="nc">DrupalStack</span><span class="o">(</span><span class="n">hostname</span><span class="o">)</span><span class="w"></span>

<span class="nc">ip::Host</span><span class="w"> </span><span class="nf">webhost</span><span class="w"> </span><span class="o">[1] -- [0:1]</span><span class="w"> </span><span class="nc">DrupalStack</span><span class="w"> </span><span class="nf">drupal_stack_webhost</span><span class="w"></span>
<span class="nc">ip::Host</span><span class="w"> </span><span class="nf">mysqlhost</span><span class="w"> </span><span class="o">[1] -- [0:1]</span><span class="w"> </span><span class="nc">DrupalStack</span><span class="w"> </span><span class="nf">drupal_stack_mysqlhost</span><span class="w"></span>

<span class="k">implementation</span><span class="w"> </span><span class="n">drupalStackImplementation</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nc">DrupalStack</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="c1"># add a mysql and apache http server</span>
<span class="w">    </span><span class="n">web_server</span><span class="o">=</span><span class="nc">apache::Server</span><span class="o">(</span><span class="n">host</span><span class="o">=</span><span class="n">webhost</span><span class="o">)</span><span class="w"></span>
<span class="w">    </span><span class="n">mysql_server</span><span class="o">=</span><span class="nc">mysql::Server</span><span class="o">(</span><span class="n">host</span><span class="o">=</span><span class="n">mysqlhost</span><span class="o">)</span><span class="w"></span>

<span class="w">    </span><span class="c1"># deploy drupal in that virtual host</span>
<span class="w">    </span><span class="n">name</span><span class="o">=</span><span class="nc">web::Alias</span><span class="o">(</span><span class="n">hostname</span><span class="o">=</span><span class="n">hostname</span><span class="o">)</span><span class="w"></span>
<span class="w">    </span><span class="n">db</span><span class="o">=</span><span class="nc">mysql::Database</span><span class="o">(</span><span class="n">server</span><span class="o">=</span><span class="n">mysql_server</span><span class="o">,</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s">&quot;drupal_test&quot;</span><span class="o">,</span><span class="w"> </span><span class="n">user</span><span class="o">=</span><span class="s">&quot;drupal_test&quot;</span><span class="o">,</span><span class="w"></span>
<span class="w">                       </span><span class="n">password</span><span class="o">=</span><span class="s">&quot;Str0ng-P433w0rd&quot;</span><span class="o">)</span><span class="w"></span>
<span class="w">    </span><span class="nc">drupal::Application</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">,</span><span class="w"> </span><span class="n">container</span><span class="o">=</span><span class="n">web_server</span><span class="o">,</span><span class="w"> </span><span class="n">database</span><span class="o">=</span><span class="n">db</span><span class="o">,</span><span class="w"> </span><span class="n">admin_user</span><span class="o">=</span><span class="n">admin_user</span><span class="o">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">admin_password</span><span class="o">=</span><span class="n">admin_password</span><span class="o">,</span><span class="w"> </span><span class="n">admin_email</span><span class="o">=</span><span class="n">admin_email</span><span class="o">,</span><span class="w"> </span><span class="n">site_name</span><span class="o">=</span><span class="n">site_name</span><span class="o">)</span><span class="w"></span>
<span class="k">end</span><span class="w"></span>

<span class="k">implement</span><span class="w"> </span><span class="nc">DrupalStack</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">drupalStackImplementation</span><span class="w"></span>
</pre></div>
</td></tr></table></div>
<ul>
<li><p class="first">Lines 7 to 13 define an entity which is the definition of a <em>concept</em> in the configuration model. On lines 8 to 12, typed attributes are defined which we can later on use in the implementation of an entity instance.</p>
</li>
<li><p class="first">Line 9 defines that <em>hostname</em> is an identifying attribute for instances of the DrupalStack entity. This also means that all instances of DrupalStack need to have a unique <em>hostname</em> attribute.</p>
</li>
<li><p class="first">Lines 17 and 18 define a relation between a Host and our DrupalStack entity. The first relation reads as follows:</p>
<blockquote>
<div><ul class="simple">
<li>Each DrupalStack instance has exactly one ip::Host instance that is available
in the webhost attribute.</li>
<li>Each ip::Host has zero or one DrupalStack instances that use the host as a
webserver. The DrupalStack instance is available in the drupal_stack_webhost attribute.</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">On lines 20 to 31 an implementation is defined that provides a refinement of the DrupalStack entity. It encapsulates the configuration of a LAMP stack behind the interface of the entity by defining DrupalStack in function of other entities, which on their turn do the same. Inside the implementation the attributes and relations of the entity are available as variables.</p>
</li>
<li><p class="first">On line 33, the <em>implement</em> statement links the implementation to the entity.</p>
</li>
</ul>
</div>
<div class="section" id="the-composition">
<h3>The composition<a class="headerlink" href="#the-composition" title="Permalink to this headline">¶</a></h3>
<p>With our new LAMP module we can reduce the amount of required configuration code in the <code class="docutils literal"><span class="pre">main.cf</span></code> file
by using more <em>reusable</em> configuration code. Only three lines of site-specific configuration code are
required.</p>
<div class="highlight-inmanta"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="n">ip</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="n">redhat</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="n">redhat</span><span class="o">::</span><span class="n">epel</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="n">lamp</span><span class="w"></span>

<span class="c1"># define the machine we want to deploy Drupal on</span>
<span class="n">vm1</span><span class="o">=</span><span class="nc">ip::Host</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;vm1&quot;</span><span class="o">,</span><span class="w"> </span><span class="n">os</span><span class="o">=</span><span class="n">redhat</span><span class="o">::</span><span class="n">centos7</span><span class="o">,</span><span class="w"> </span><span class="n">ip</span><span class="o">=</span><span class="s">&quot;192.168.33.101&quot;</span><span class="o">,</span><span class="w"> </span><span class="n">remote_agent</span><span class="o">=</span><span class="k">true</span><span class="o">,</span><span class="w"></span>
<span class="w">             </span><span class="n">remote_user</span><span class="o">=</span><span class="s">&quot;vagrant&quot;</span><span class="o">)</span><span class="w"></span>
<span class="n">vm2</span><span class="o">=</span><span class="nc">ip::Host</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;vm2&quot;</span><span class="o">,</span><span class="w"> </span><span class="n">os</span><span class="o">=</span><span class="n">redhat</span><span class="o">::</span><span class="n">centos7</span><span class="o">,</span><span class="w"> </span><span class="n">ip</span><span class="o">=</span><span class="s">&quot;192.168.33.102&quot;</span><span class="o">,</span><span class="w"> </span><span class="n">remote_agent</span><span class="o">=</span><span class="k">true</span><span class="o">,</span><span class="w"></span>
<span class="w">             </span><span class="n">remote_user</span><span class="o">=</span><span class="s">&quot;vagrant&quot;</span><span class="o">)</span><span class="w"></span>

<span class="nc">lamp::DrupalStack</span><span class="o">(</span><span class="n">webhost</span><span class="o">=</span><span class="n">vm1</span><span class="o">,</span><span class="w"> </span><span class="n">mysqlhost</span><span class="o">=</span><span class="n">vm2</span><span class="o">,</span><span class="w"> </span><span class="n">hostname</span><span class="o">=</span><span class="s">&quot;localhost&quot;</span><span class="o">,</span><span class="w"> </span><span class="n">admin_user</span><span class="o">=</span><span class="s">&quot;admin&quot;</span><span class="o">,</span><span class="w"></span>
<span class="w">                  </span><span class="n">admin_password</span><span class="o">=</span><span class="s">&quot;test&quot;</span><span class="o">,</span><span class="w"> </span><span class="n">admin_email</span><span class="o">=</span><span class="s">&quot;admin@example.com&quot;</span><span class="o">,</span><span class="w"> </span><span class="n">site_name</span><span class="o">=</span><span class="s">&quot;localhost&quot;</span><span class="o">)</span><span class="w"></span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="deploy-the-changes">
<h3>Deploy the changes<a class="headerlink" href="#deploy-the-changes" title="Permalink to this headline">¶</a></h3>
<p>Deploy the changes as before and nothing should change because it generates exactly the same
configuration.</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>inmanta -vvv <span class="nb">export</span> -d
</pre></div>
</div>
</div>
</div>
<div class="section" id="next-steps">
<h2>Next steps<a class="headerlink" href="#next-steps" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="guides.html"><span class="doc">Guides</span></a></p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="install.html" class="btn btn-neutral float-right" title="Install Inmanta" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral" title="Inmanta Documentation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017 Inmanta NV.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'2017.4dev',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>