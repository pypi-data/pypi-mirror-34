
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>16.4. Design notes &#8212; CamCOPS 2.2.5 documentation</title>
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/css/camcops_docs.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="16.5. Development command-line tools" href="development_command_line.html" />
    <link rel="prev" title="16.3. C++ code style used" href="cpp_code_style.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="development_command_line.html" title="16.5. Development command-line tools"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="cpp_code_style.html" title="16.3. C++ code style used"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">CamCOPS 2.2.5 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">16. Developer notes</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="design-notes">
<h1>16.4. Design notes<a class="headerlink" href="#design-notes" title="Permalink to this headline">¶</a></h1>
<p>A few design decisions are documented here. See also:</p>
<ul class="simple">
<li><a class="reference internal" href="../introduction/patient_identification.html#patient-identification"><span class="std std-ref">Patient/subject identification</span></a></li>
<li><a class="reference internal" href="../introduction/security_design.html#security-design"><span class="std std-ref">Security design</span></a></li>
</ul>
<div class="section" id="client-sqlcipher-databases">
<h2>16.4.1. Client SQLCipher databases<a class="headerlink" href="#client-sqlcipher-databases" title="Permalink to this headline">¶</a></h2>
<p>The CamCOPS client uses two databases (typically called <cite>camcops_data.sqlite</cite>
and <cite>camcops_sys.sqlite</cite>), stored in the device’s user-specific private area
(e.g. <cite>~/local/share/camcops under Linux</cite>). Note that some operating systems
(e.g. Android, iOS) are designed for single-user use and don’t have the concept
of a per-user private area. The ‘data’ database holds user data (patients,
patient data) and the ‘sys’ database contains configuration information, stored
strings, and the like. Both are encrypted with AES-256 via SQLCipher. They use
the same passphrase for user convenience, but different encryption keys
<a class="footnote-reference" href="#sqlcipher" id="id1">[1]</a>.</p>
<p>The decision to use two databases rather than one is so that, in emergencies,
the ‘data’ database can be processed (viewed, rescued) without the need to
share the ‘sys’ database and its information. It also simplifies the upload
process a little (as the client can simply upload everything from the ‘data’
database and nothing from the ‘sys’ database).</p>
</div>
<div class="section" id="inline-css">
<h2>16.4.2. Inline CSS<a class="headerlink" href="#inline-css" title="Permalink to this headline">¶</a></h2>
<p>The server currently provides CSS inline. It could refer to CSS as files, so
that browsers cache them better. However, inline CSS is still required for PDF
creation, and it’s not clear this is an important performance constraint.</p>
</div>
<div class="section" id="sftp-export">
<h2>16.4.3. SFTP export<a class="headerlink" href="#sftp-export" title="Permalink to this headline">¶</a></h2>
<p>Not necessary, as one can mount an SFTP directory via NFS, then just export as a
plain file.</p>
</div>
<div class="section" id="anonymisation">
<h2>16.4.4. Anonymisation<a class="headerlink" href="#anonymisation" title="Permalink to this headline">¶</a></h2>
<p>Proper anonymisation is Somebody Else’s Business; CamCOPS supports convenient
export for subsequent anonymisation (see, for example, CRATE;
<a class="reference external" href="https://github.com/RudolfCardinal/crate">https://github.com/RudolfCardinal/crate</a>).</p>
</div>
<div class="section" id="blob-handling">
<h2>16.4.5. BLOB handling<a class="headerlink" href="#blob-handling" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p class="first">It’s clearly preferable to have BLOBs in the database (rather than on the
filesystem), both on the server and the client (server: easier to manage;
client: within secure encrypted database).</p>
</li>
<li><p class="first">It’s also clearly preferable to have BLOBs in their own table (server:
doesn’t slow down all other tables; client: can upload record-by-record for
BLOBs and table-by-table for other things).</p>
</li>
<li><p class="first">Then, regarding storage/access within the client…</p>
<ul class="simple">
<li>Writing images to a BLOB is a slow operation: it’s the QImage to QByteArray
conversion (and reverse conversion) that’s relatively slow. This slows down
rotation. The rotation operation itself, on a QImage, is fast.</li>
</ul>
</li>
<li><p class="first">Possible client strategies, then:</p>
<ul>
<li><p class="first">Blob/Field handle QByteArray only; QuImage deals with all the rotation.
Slow for the client but simple.</p>
</li>
<li><p class="first">Blob/Field deal with a combination of a QByteArray (written as PNG to the
database) and a “rotation” field, and client/server rotate on the fly.</p>
<ul>
<li><p class="first">Should make the client rotation operation fast.</p>
</li>
<li><p class="first">Could store rotation field in the task table, as before, but that is
particularly inelegant.</p>
</li>
<li><p class="first">Could make Blob and/or Field objects image-aware, and have them store
rotation as an extra field in the blob table.</p>
</li>
<li><p class="first">Also allows the potential to preserve more source information, e.g. EXIF,
because no image manipulations are stored.</p>
</li>
<li><p class="first">… for example:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">new</span> <span class="n">integer</span> <span class="nl">field</span><span class="p">:</span> <span class="n">blob</span><span class="p">.</span><span class="n">image_rotation_deg_ccw</span>
<span class="k">new</span> <span class="n">text</span> <span class="nl">field</span><span class="p">:</span> <span class="n">blob</span><span class="p">.</span><span class="n">filetype</span>   <span class="c1">// e.g. &quot;png&quot;</span>

<span class="n">QImage</span> <span class="n">Blob</span><span class="o">::</span><span class="n">image</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>  <span class="c1">// and cache it</span>
<span class="kt">void</span> <span class="n">Blob</span><span class="o">::</span><span class="n">rotateImage</span><span class="p">(</span><span class="kt">int</span> <span class="n">angle</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">Blob</span><span class="o">::</span><span class="n">setImage</span><span class="p">(</span><span class="k">const</span> <span class="n">QImage</span><span class="o">&amp;</span> <span class="n">image</span><span class="p">);</span>

<span class="n">QImage</span> <span class="n">FieldRef</span><span class="o">::</span><span class="n">image</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>
<span class="kt">void</span> <span class="n">FieldRef</span><span class="o">::</span><span class="n">rotateImage</span><span class="p">(</span><span class="kt">int</span> <span class="n">angle</span><span class="p">);</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p class="first">Store only final rotated images and do the rotation in the background.</p>
</li>
</ul>
</li>
<li><p class="first">I tried the Blob method (with rotation as a field in the Blob table) –
massively faster than before. Makes the difference between dire and
respectable performance.</p>
</li>
</ul>
</div>
<div class="section" id="why-not-code-it-all-in-java">
<h2>16.4.6. Why not code it all in Java?<a class="headerlink" href="#why-not-code-it-all-in-java" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>The default Java UI is Swing:
<a class="reference external" href="https://www.reddit.com/r/java/comments/383e2c/whats_the_actual_modern_way_to_make_a_gui_with/">https://www.reddit.com/r/java/comments/383e2c/whats_the_actual_modern_way_to_make_a_gui_with/</a></li>
<li>Swing is not portable to iOS:
<a class="reference external" href="http://creamtec.com/products/ajaxswing/solutions/java_swing_ui_on_ipad.html">http://creamtec.com/products/ajaxswing/solutions/java_swing_ui_on_ipad.html</a></li>
<li>JavaFX is another GUI standard, which is newer. It’s not supported on all
operating systems (though it does support iOS):
<a class="reference external" href="http://stackoverflow.com/questions/20860931/is-it-possible-to-run-javafx-applications-on-ios-android-or-windows-phone-8">http://stackoverflow.com/questions/20860931/is-it-possible-to-run-javafx-applications-on-ios-android-or-windows-phone-8</a>
<a class="reference external" href="https://www.youtube.com/watch?v=a3dAteWr40k&amp;feature=youtu.be">https://www.youtube.com/watch?v=a3dAteWr40k&amp;feature=youtu.be</a></li>
<li>SQLite would be via JDBC or similar
<a class="reference external" href="http://stackoverflow.com/questions/41233/java-and-sqlite">http://stackoverflow.com/questions/41233/java-and-sqlite</a></li>
<li>Also, <a class="reference external" href="http://tech.jonathangardner.net/wiki/Why_Java_Sucks">http://tech.jonathangardner.net/wiki/Why_Java_Sucks</a>;
<a class="reference external" href="http://steve-yegge.blogspot.com/2006/03/execution-in-kingdom-of-nouns.html">http://steve-yegge.blogspot.com/2006/03/execution-in-kingdom-of-nouns.html</a></li>
</ul>
<p class="rubric">Footnotes</p>
<table class="docutils footnote" frame="void" id="sqlcipher" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>See <a class="reference external" href="https://www.zetetic.net/sqlcipher/design/">https://www.zetetic.net/sqlcipher/design/</a></td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../index.html">Table Of Contents</a></h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction/introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/download.html">2. Downloading CamCOPS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../client/client_installation.html">3. Installing and configuring the client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../client/client_using.html">4. Using the client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../server/server_front_end_general.html">5. Web site: general use</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tasks/_tasks_by_category.html">6. Tasks in CamCOPS by category</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tasks/_tasks_all.html">7. All tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../client/client_troubleshooting.html">8. Troubleshooting client problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../server/server_installation.html">9. Installing CamCOPS on the server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../server/server_configuration.html">10. Configuring the server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../server/server_config_file.html">11. The CamCOPS server configuration file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../server/server_front_end_admin.html">12. Web site: admin functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../server/server_command_line.html">13. CamCOPS command-line tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../server/server_troubleshooting.html">14. Troubleshooting server problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../licences/licences.html">15. Licences</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">16. Developer notes</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../client/creating_tasks.html">16.1. Creating tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="building_client.html">16.2. Building the CamCOPS client</a></li>
<li class="toctree-l2"><a class="reference internal" href="cpp_code_style.html">16.3. C++ code style used</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">16.4. Design notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="development_command_line.html">16.5. Development command-line tools</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../misc/tcpip_ports.html">17. Common relevant TCP/IP ports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/linux_flavours.html">18. Linux flavours</a></li>
<li class="toctree-l1"><a class="reference internal" href="../autodoc/_index.html">19. Automatic documentation of core server source code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">20. Change log/history</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq_known_problems.html">21. FAQ and known problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../to_do.html">22. Things to do</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wishlist.html">23. Wishlist and blue-sky thoughts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/local_info.html">24. Local configuration information</a></li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="cpp_code_style.html"
                        title="previous chapter">16.3. C++ code style used</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="development_command_line.html"
                        title="next chapter">16.5. Development command-line tools</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/developer/design_notes.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="development_command_line.html" title="16.5. Development command-line tools"
             >next</a> |</li>
        <li class="right" >
          <a href="cpp_code_style.html" title="16.3. C++ code style used"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">CamCOPS 2.2.5 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >16. Developer notes</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2012-2018, Rudolf Cardinal.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.5.
    </div>
  </body>
</html>