
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>camcops_server.cc_modules.cc_sqla_coltypes &#8212; CamCOPS 2.2.4 documentation</title>
    <link rel="stylesheet" href="../../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/css/camcops_docs.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">CamCOPS 2.2.4 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for camcops_server.cc_modules.cc_sqla_coltypes</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># camcops_server/cc_modules/cc_sqla_coltypes.py</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">===============================================================================</span>

<span class="sd">    Copyright (C) 2012-2018 Rudolf Cardinal (rudolf@pobox.com).</span>

<span class="sd">    This file is part of CamCOPS.</span>

<span class="sd">    CamCOPS is free software: you can redistribute it and/or modify</span>
<span class="sd">    it under the terms of the GNU General Public License as published by</span>
<span class="sd">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">    (at your option) any later version.</span>

<span class="sd">    CamCOPS is distributed in the hope that it will be useful,</span>
<span class="sd">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="sd">    GNU General Public License for more details.</span>

<span class="sd">    You should have received a copy of the GNU General Public License</span>
<span class="sd">    along with CamCOPS. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="sd">===============================================================================</span>

<span class="sd">Note these built-in SQLAlchemy types:</span>
<span class="sd">http://docs.sqlalchemy.org/en/latest/core/type_basics.html#generic-types</span>

<span class="sd">    =============== ===========================================================</span>
<span class="sd">    SQLAlchemy type Comment</span>
<span class="sd">    =============== ===========================================================</span>
<span class="sd">    BigInteger      MySQL: -9,223,372,036,854,775,808 to </span>
<span class="sd">                    9,223,372,036,854,775,807 (64-bit)</span>
<span class="sd">                    (compare NHS number: up to 9,999,999,999)</span>
<span class="sd">    Boolean</span>
<span class="sd">    Date</span>
<span class="sd">    DateTime</span>
<span class="sd">    Enum</span>
<span class="sd">    Float</span>
<span class="sd">    Integer         MySQL: -2,147,483,648 to 2,147,483,647 (32-bit)</span>
<span class="sd">    Interval        for datetime.timedelta</span>
<span class="sd">    LargeBinary     under MySQL, maps to BLOB</span>
<span class="sd">    MatchType       for the return type of the MATCH operator</span>
<span class="sd">    Numeric         for fixed-precision numbers like NUMERIC or DECIMAL</span>
<span class="sd">    PickleType</span>
<span class="sd">    SchemaType</span>
<span class="sd">    SmallInteger</span>
<span class="sd">    String          VARCHAR</span>
<span class="sd">    Text            variably sized string type</span>
<span class="sd">                    ... under MySQL, renders as TEXT</span>
<span class="sd">    Time</span>
<span class="sd">    Unicode         implies that the underlying column explicitly supports </span>
<span class="sd">                    Unicode</span>
<span class="sd">    UnicodeText     variably sized version of Unicode</span>
<span class="sd">                    ... under MySQL, renders as TEXT too</span>
<span class="sd">    =============== ===========================================================</span>
<span class="sd">    </span>
<span class="sd">Not supported across all platforms:</span>

<span class="sd">    =============== ===========================================================</span>
<span class="sd">    SQL type        Comment</span>
<span class="sd">    =============== ===========================================================</span>
<span class="sd">    BIGINT UNSIGNED MySQL: 0 to 18,446,744,073,709,551,615 (64-bit)</span>
<span class="sd">                    ... use sqlalchemy.dialects.mysql.BIGINT(unsigned=True)</span>
<span class="sd">    INT UNSIGNED    MySQL: 0 to 4,294,967,295 (32-bit)</span>
<span class="sd">                    ... use sqlalchemy.dialects.mysql.INTEGER(unsigned=True)</span>
<span class="sd">    =============== ===========================================================</span>

<span class="sd">Other MySQL sizes:</span>

<span class="sd">    =============== ===========================================================</span>
<span class="sd">    MySQL type      Comment</span>
<span class="sd">    =============== ===========================================================</span>
<span class="sd">    TINYBLOB        2^8 bytes = 256 bytes</span>
<span class="sd">    BLOB            2^16 bytes = 64 KiB</span>
<span class="sd">    MEDIUMBLOB      2^24 bytes = 16 MiB</span>
<span class="sd">    LONGBLOB        2^32 bytes = 4 GiB </span>
<span class="sd">    TINYTEXT        255 (2^8 - 1) bytes</span>
<span class="sd">    TEXT            65,535 bytes (2^16 - 1) = 64 KiB</span>
<span class="sd">    MEDIUMTEXT      16,777,215 (2^24 - 1) bytes = 16 MiB</span>
<span class="sd">    LONGTEXT        4,294,967,295 (2^32 - 1) bytes = 4 GiB</span>
<span class="sd">    =============== ===========================================================</span>

<span class="sd">See https://stackoverflow.com/questions/13932750/tinytext-text-mediumtext-and-longtext-maximum-storage-sizes</span>

<span class="sd">Also:</span>

<span class="sd">    - Columns may need their character set specified explicitly under MySQL:</span>
<span class="sd">      https://stackoverflow.com/questions/2108824/mysql-incorrect-string-value-error-when-save-unicode-string-in-django</span>

<span class="sd">&quot;&quot;&quot;</span>  <span class="c1"># noqa</span>

<span class="c1"># =============================================================================</span>
<span class="c1"># Imports</span>
<span class="c1"># =============================================================================</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">Generator</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span>
                    <span class="n">Union</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">unittest</span>

<span class="kn">from</span> <span class="nn">cardinal_pythonlib.datetimefunc</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">coerce_to_pendulum</span><span class="p">,</span>
    <span class="n">convert_datetime_to_utc</span><span class="p">,</span>
    <span class="n">PotentialDatetimeType</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.lists</span> <span class="k">import</span> <span class="n">chunks</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.logs</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">BraceStyleAdapter</span><span class="p">,</span>
    <span class="n">main_only_quicksetup_rootlogger</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.randomness</span> <span class="k">import</span> <span class="n">create_base64encoded_randomness</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.reprfunc</span> <span class="k">import</span> <span class="n">auto_repr</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.sqlalchemy.dialect</span> <span class="k">import</span> <span class="n">SqlaDialectName</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.sqlalchemy.orm_inspect</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">gen_columns</span><span class="p">,</span>
    <span class="n">gen_relationships</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.sqlalchemy.session</span> <span class="k">import</span> <span class="n">SQLITE_MEMORY_URL</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.sqlalchemy.sqlfunc</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">fail_unknown_dialect</span><span class="p">,</span>
    <span class="n">fetch_processed_single_clause</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">pendulum</span> <span class="k">import</span> <span class="n">DateTime</span> <span class="k">as</span> <span class="n">Pendulum</span>
<span class="kn">from</span> <span class="nn">pendulum.parsing.exceptions</span> <span class="k">import</span> <span class="n">ParserError</span>
<span class="kn">from</span> <span class="nn">semantic_version</span> <span class="k">import</span> <span class="n">Version</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">util</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.engine.interfaces</span> <span class="k">import</span> <span class="n">Dialect</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.compiler</span> <span class="k">import</span> <span class="n">compiles</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm.relationships</span> <span class="k">import</span> <span class="n">RelationshipProperty</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.expression</span> <span class="k">import</span> <span class="n">text</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.functions</span> <span class="k">import</span> <span class="n">func</span><span class="p">,</span> <span class="n">FunctionElement</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.schema</span> <span class="k">import</span> <span class="n">Column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.sqltypes</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">Boolean</span><span class="p">,</span>
    <span class="n">DateTime</span><span class="p">,</span>
    <span class="n">Integer</span><span class="p">,</span>
    <span class="n">LargeBinary</span><span class="p">,</span>
    <span class="n">String</span><span class="p">,</span>
    <span class="n">Text</span><span class="p">,</span>
    <span class="n">Unicode</span><span class="p">,</span>
    <span class="n">UnicodeText</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.type_api</span> <span class="k">import</span> <span class="n">TypeDecorator</span>

<span class="kn">from</span> <span class="nn">.cc_constants</span> <span class="k">import</span> <span class="n">PV</span>
<span class="kn">from</span> <span class="nn">.cc_simpleobjects</span> <span class="k">import</span> <span class="n">IdNumReference</span>
<span class="kn">from</span> <span class="nn">.cc_version</span> <span class="k">import</span> <span class="n">make_version</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">sqlalchemy.sql.elements</span> <span class="k">import</span> <span class="n">ClauseElement</span>
    <span class="kn">from</span> <span class="nn">sqlalchemy.sql.compiler</span> <span class="k">import</span> <span class="n">SQLCompiler</span>
    <span class="kn">from</span> <span class="nn">.cc_db</span> <span class="k">import</span> <span class="n">GenericTabletRecordMixin</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">BraceStyleAdapter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">))</span>

<span class="c1"># =============================================================================</span>
<span class="c1"># Debugging options</span>
<span class="c1"># =============================================================================</span>

<span class="n">DEBUG_DATETIME_AS_ISO_TEXT</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">DEBUG_IDNUMDEF_LIST</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">DEBUG_INT_LIST_COLTYPE</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">DEBUG_SEMANTIC_VERSION</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">DEBUG_STRING_LIST_COLTYPE</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">DEBUG_DATETIME_AS_ISO_TEXT</span><span class="p">,</span>
        <span class="n">DEBUG_SEMANTIC_VERSION</span><span class="p">,</span>
        <span class="n">DEBUG_IDNUMDEF_LIST</span><span class="p">,</span>
        <span class="n">DEBUG_INT_LIST_COLTYPE</span><span class="p">,</span>
        <span class="n">DEBUG_STRING_LIST_COLTYPE</span><span class="p">]):</span>
    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Debugging options enabled!&quot;</span><span class="p">)</span>

<span class="c1"># =============================================================================</span>
<span class="c1"># Constants</span>
<span class="c1"># =============================================================================</span>

<span class="n">AUDIT_SOURCE_MAX_LEN</span> <span class="o">=</span> <span class="mi">20</span>  <span class="c1"># our choice based on use in CamCOPS code</span>

<span class="n">DATABASE_TITLE_MAX_LEN</span> <span class="o">=</span> <span class="mi">255</span>  <span class="c1"># our choice</span>
<span class="n">DEVICE_NAME_MAX_LEN</span> <span class="o">=</span> <span class="mi">255</span>  <span class="c1"># our choice; must be compatible with tablet</span>

<span class="n">EMAIL_ADDRESS_MAX_LEN</span> <span class="o">=</span> <span class="mi">255</span>  <span class="c1"># https://en.wikipedia.org/wiki/Email_address</span>

<span class="n">FILTER_TEXT_MAX_LEN</span> <span class="o">=</span> <span class="mi">255</span>  <span class="c1"># our choice</span>
<span class="n">FULLNAME_MAX_LEN</span> <span class="o">=</span> <span class="mi">255</span>  <span class="c1"># our choice; used for user full names on the server</span>

<span class="n">GROUP_DESCRIPTION_MAX_LEN</span> <span class="o">=</span> <span class="mi">255</span>  <span class="c1"># our choice</span>
<span class="n">GROUP_NAME_MAX_LEN</span> <span class="o">=</span> <span class="mi">255</span>  <span class="c1"># our choice</span>

<span class="n">HASHED_PW_MAX_LEN</span> <span class="o">=</span> <span class="mi">60</span>  <span class="c1"># for bcrypt</span>
<span class="c1"># ... empirically; we use bcrypt; its length is:</span>
<span class="c1">#       &quot;$2a$&quot; (4)</span>
<span class="c1">#       cost parameter, e.g. &quot;$09&quot; for 9 rounds (3)</span>
<span class="c1">#       b64-enc 128-bit salt (22)</span>
<span class="c1">#       b64enc 184-bit hash (31)</span>
<span class="c1"># ... total 60</span>
<span class="c1"># https://stackoverflow.com/questions/5881169/what-column-type-length-should-i-use-for-storing-a-bcrypt-hashed-password-in-a-d  # noqa</span>
<span class="n">HOSTNAME_MAX_LEN</span> <span class="o">=</span> <span class="mi">255</span>
<span class="c1"># ... FQDN; https://stackoverflow.com/questions/8724954/what-is-the-maximum-number-of-characters-for-a-host-name-in-unix  # noqa</span>

<span class="n">ICD9_CODE_MAX_LEN</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># longest is &quot;xxx.xx&quot;; thus, 6; see</span>
<span class="c1"># https://www.cms.gov/Medicare/Quality-Initiatives-Patient-Assessment-Instruments/HospitalQualityInits/Downloads/HospitalAppendix_F.pdf  # noqa</span>
<span class="n">ICD10_CODE_MAX_LEN</span> <span class="o">=</span> <span class="mi">7</span>  <span class="c1"># longest is e.g. &quot;F00.000&quot;; &quot;F10.202&quot;; thus, 7</span>

<span class="n">DIAGNOSTIC_CODE_MAX_LEN</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ICD9_CODE_MAX_LEN</span><span class="p">,</span> <span class="n">ICD10_CODE_MAX_LEN</span><span class="p">)</span>

<span class="n">HL7_AA_MAX_LEN</span> <span class="o">=</span> <span class="mi">20</span>
<span class="c1"># ... the AA appears in Table 4.6 &quot;Extended composite ID&quot;, p46-47 of</span>
<span class="c1">#     hl7guide-1-4-2012-08.pdf</span>
<span class="c1"># ... but is defined in Table 4.9 &quot;Entity Identifier&quot;, p50, in which:</span>
<span class="c1">#     - component 2 is the Assigning Authority (see component 1)</span>
<span class="c1">#     - component 2 is also a Namespace ID with a length of 20</span>
<span class="c1"># ... and multiple other examples of an Assigning Authority being one example</span>
<span class="c1">#     of a Namespace ID</span>
<span class="c1"># ... and examples are in Table 0363 (p229 of the PDF), which are all 3-char.</span>
<span class="c1"># ... and several other examples of &quot;Namespace ID&quot; being of length 1..20</span>
<span class="c1">#     meaning 1-20.</span>
<span class="n">HL7_ID_TYPE_MAX_LEN</span> <span class="o">=</span> <span class="mi">5</span>
<span class="c1"># ... Table 4.6 &quot;Extended composite ID&quot;, p46-47 of hl7guide-1-4-2012-08.pdf</span>
<span class="c1"># ... and Table 0203 &quot;Identifier type&quot;, p204 of that PDF, in Appendix B</span>

<span class="n">ID_DESCRIPTOR_MAX_LEN</span> <span class="o">=</span> <span class="mi">255</span>  <span class="c1"># our choice</span>
<span class="n">ID_POLICY_MAX_LEN</span> <span class="o">=</span> <span class="mi">255</span>  <span class="c1"># our choice</span>
<span class="n">IP_ADDRESS_MAX_LEN</span> <span class="o">=</span> <span class="mi">45</span>  <span class="c1"># http://stackoverflow.com/questions/166132  # noqa</span>
<span class="n">ISO8601_STRING_MAX_LEN</span> <span class="o">=</span> <span class="mi">32</span>
<span class="c1"># ... max length e.g. 2013-07-24T20:04:07.123456+01:00</span>
<span class="c1">#                     1234567890123456789012345678901234567890</span>
<span class="c1">#     (with punctuation, T, microseconds, colon in timezone).</span>

<span class="n">LONGBLOB_LONGTEXT_MAX_LEN</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">32</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

<span class="n">MIMETYPE_MAX_LEN</span> <span class="o">=</span> <span class="mi">255</span>  <span class="c1"># https://stackoverflow.com/questions/643690</span>

<span class="n">PATIENT_NAME_MAX_LEN</span> <span class="o">=</span> <span class="mi">255</span>  <span class="c1"># for forename and surname, each; our choice but must match tablet  # noqa</span>

<span class="n">SENDING_FORMAT_MAX_LEN</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># for HL7; our choice based on use in CamCOPS code</span>
<span class="n">SESSION_TOKEN_MAX_BYTES</span> <span class="o">=</span> <span class="mi">64</span>  <span class="c1"># our choice; 64 bytes =&gt; 512 bits, which is a lot in 2017  # noqa</span>
<span class="n">SESSION_TOKEN_MAX_LEN</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
    <span class="n">create_base64encoded_randomness</span><span class="p">(</span><span class="n">SESSION_TOKEN_MAX_BYTES</span><span class="p">))</span>

<span class="n">TABLENAME_MAX_LEN</span> <span class="o">=</span> <span class="mi">128</span>
<span class="c1"># MySQL: 64 -- https://dev.mysql.com/doc/refman/5.7/en/identifiers.html</span>
<span class="c1"># SQL Server: 128  -- https://msdn.microsoft.com/en-us/library/ms191240.aspx</span>
<span class="c1"># Oracle: 32, then 128 from v12.2 (2017)</span>

<span class="n">TASK_SUMMARY_TEXT_FIELD_DEFAULT_MAX_LEN</span> <span class="o">=</span> <span class="mi">50</span>
<span class="c1"># ... our choice, contains short strings like &quot;normal&quot;, &quot;abnormal&quot;, &quot;severe&quot;.</span>
<span class="c1"># Easy to change, since it&#39;s only used when exporting summaries, and not in</span>
<span class="c1"># the core database.</span>

<span class="n">USERNAME_MAX_LEN</span> <span class="o">=</span> <span class="mi">255</span>  <span class="c1"># our choice</span>


<div class="viewcode-block" id="RelationshipInfo"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.RelationshipInfo">[docs]</a><span class="k">class</span> <span class="nc">RelationshipInfo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used for the &quot;info&quot; parameter to SQLAlchemy &quot;relationship&quot; calls.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">IS_ANCILLARY</span> <span class="o">=</span> <span class="s2">&quot;is_ancillary&quot;</span>
    <span class="n">IS_BLOB</span> <span class="o">=</span> <span class="s2">&quot;is_blob&quot;</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Simple derivative column types</span>
<span class="c1"># =============================================================================</span>
<span class="c1"># If you insert something too long into a VARCHAR, it just gets truncated.</span>

<span class="n">AuditSourceColType</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">AUDIT_SOURCE_MAX_LEN</span><span class="p">)</span>

<span class="c1"># BigIntUnsigned = Integer().with_variant(mysql.BIGINT(unsigned=True), &#39;mysql&#39;)</span>
<span class="c1"># ... partly because Alembic breaks on variants (Aug 2017), and partly because</span>
<span class="c1">#     it&#39;s nonstandard and unnecessary, changed all BigIntUnsigned to</span>
<span class="c1">#     BigInteger (2017-08-25).</span>

<span class="n">CharColType</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">DatabaseTitleColType</span> <span class="o">=</span> <span class="n">Unicode</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">DATABASE_TITLE_MAX_LEN</span><span class="p">)</span>
<span class="n">DeviceNameColType</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">DEVICE_NAME_MAX_LEN</span><span class="p">)</span>
<span class="n">DiagnosticCodeColType</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">DIAGNOSTIC_CODE_MAX_LEN</span><span class="p">)</span>

<span class="n">EmailAddressColType</span> <span class="o">=</span> <span class="n">Unicode</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">EMAIL_ADDRESS_MAX_LEN</span><span class="p">)</span>
<span class="n">EraColType</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">ISO8601_STRING_MAX_LEN</span><span class="p">)</span>  <span class="c1"># underlying SQL type</span>

<span class="n">FilterTextColType</span> <span class="o">=</span> <span class="n">Unicode</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">FILTER_TEXT_MAX_LEN</span><span class="p">)</span>
<span class="n">FullNameColType</span> <span class="o">=</span> <span class="n">Unicode</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">FULLNAME_MAX_LEN</span><span class="p">)</span>

<span class="n">GroupDescriptionColType</span> <span class="o">=</span> <span class="n">Unicode</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">GROUP_DESCRIPTION_MAX_LEN</span><span class="p">)</span>
<span class="n">GroupNameColType</span> <span class="o">=</span> <span class="n">Unicode</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">GROUP_NAME_MAX_LEN</span><span class="p">)</span>

<span class="n">HashedPasswordColType</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">HASHED_PW_MAX_LEN</span><span class="p">)</span>
<span class="c1"># ... You might think that we must ensure case-SENSITIVE comparison on this</span>
<span class="c1"># field. That would require the option collation=&#39;utf8mb4_bin&#39; to String(),</span>
<span class="c1"># for MySQL. However, that is MySQL-specific, and SQLAlchemy currently (Oct</span>
<span class="c1"># 2017) doesn&#39;t support database-specific *per-column* collations. SQLite</span>
<span class="c1"># accepts COLLATE commands but chokes on &#39;utf8mb4_bin&#39;. Now, the hashed</span>
<span class="c1"># password from bcrypt() is case-sensitive. HOWEVER, the important thing is</span>
<span class="c1"># that we always retrieve the string from the database and do a case-sensitive</span>
<span class="c1"># comparison in Python (see calls to is_password_valid()). So the database</span>
<span class="c1"># collation doesn&#39;t matter. So we don&#39;t set it.</span>
<span class="c1"># See further notes in cc_sqlalchemy.py</span>
<span class="n">HL7AssigningAuthorityType</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">HL7_AA_MAX_LEN</span><span class="p">)</span>
<span class="n">HL7IdTypeType</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">HL7_ID_TYPE_MAX_LEN</span><span class="p">)</span>
<span class="n">HostnameColType</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">HOSTNAME_MAX_LEN</span><span class="p">)</span>

<span class="n">IdDescriptorColType</span> <span class="o">=</span> <span class="n">Unicode</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">ID_DESCRIPTOR_MAX_LEN</span><span class="p">)</span>
<span class="n">IdPolicyColType</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">ID_POLICY_MAX_LEN</span><span class="p">)</span>
<span class="c1"># IntUnsigned = Integer().with_variant(mysql.INTEGER(unsigned=True), &#39;mysql&#39;)</span>
<span class="n">IPAddressColType</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">IP_ADDRESS_MAX_LEN</span><span class="p">)</span>
<span class="c1"># This is a plain string.</span>
<span class="c1"># See also e.g. http://sqlalchemy-utils.readthedocs.io/en/latest/_modules/sqlalchemy_utils/types/ip_address.html  # noqa</span>

<span class="c1"># Large BLOB:</span>
<span class="c1"># https://stackoverflow.com/questions/43791725/sqlalchemy-how-to-make-a-longblob-column-in-mysql  # noqa</span>
<span class="c1"># One of these:</span>
<span class="c1"># LongBlob = LargeBinary().with_variant(mysql.LONGBLOB, &quot;mysql&quot;)</span>
<span class="n">LongBlob</span> <span class="o">=</span> <span class="n">LargeBinary</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">LONGBLOB_LONGTEXT_MAX_LEN</span><span class="p">)</span>

<span class="c1"># LongText = UnicodeText().with_variant(mysql.LONGTEXT, &#39;mysql&#39;)</span>
<span class="n">LongText</span> <span class="o">=</span> <span class="n">UnicodeText</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">LONGBLOB_LONGTEXT_MAX_LEN</span><span class="p">)</span>

<span class="n">MimeTypeColType</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">MIMETYPE_MAX_LEN</span><span class="p">)</span>

<span class="n">PatientNameColType</span> <span class="o">=</span> <span class="n">Unicode</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">PATIENT_NAME_MAX_LEN</span><span class="p">)</span>

<span class="n">SendingFormatColType</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">SENDING_FORMAT_MAX_LEN</span><span class="p">)</span>
<span class="n">SessionTokenColType</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">SESSION_TOKEN_MAX_LEN</span><span class="p">)</span>
<span class="n">SexColType</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">SummaryCategoryColType</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">TASK_SUMMARY_TEXT_FIELD_DEFAULT_MAX_LEN</span><span class="p">)</span>  <span class="c1"># pretty generic  # noqa</span>

<span class="n">TableNameColType</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">TABLENAME_MAX_LEN</span><span class="p">)</span>

<span class="n">UserNameColType</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">USERNAME_MAX_LEN</span><span class="p">)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Helper operations for PendulumDateTimeAsIsoTextColType</span>
<span class="c1"># =============================================================================</span>
<span class="c1"># Database string format is e.g.</span>
<span class="c1">#   2013-07-24T20:04:07.123456+01:00</span>
<span class="c1">#   2013-07-24T20:04:07.123+01:00</span>
<span class="c1">#   0        1         2         3      } position in string; 1-based</span>
<span class="c1">#   12345678901234567890123456789012    }</span>
<span class="c1">#</span>
<span class="c1"># So: rightmost 6 characters are time zone; rest is date/time.</span>
<span class="c1">#     leftmost 23 characters are time up to millisecond precision.</span>
<span class="c1">#     overall length is typically 29 (milliseconds) or 32 (microseconds)</span>

<span class="n">_TZ_LEN</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># length of the timezone part of the ISO8601 string</span>
<span class="n">_UTC_TZ_LITERAL</span> <span class="o">=</span> <span class="s2">&quot;&#39;+00:00&#39;&quot;</span>
<span class="n">_SQLITE_DATETIME_FMT_FOR_PYTHON</span> <span class="o">=</span> <span class="s2">&quot;&#39;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:</span><span class="si">%f</span><span class="s2">&#39;&quot;</span>

<span class="n">_MYSQL_DATETIME_LEN</span> <span class="o">=</span> <span class="mi">19</span>
<span class="n">_SQLSERVER_DATETIME_LEN</span> <span class="o">=</span> <span class="mi">19</span>
<span class="n">_SQLSERVER_DATETIME2_LEN</span> <span class="o">=</span> <span class="mi">27</span>


<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># isotzdatetime_to_utcdatetime</span>
<span class="c1"># -----------------------------------------------------------------------------</span>

<span class="c1"># noinspection PyPep8Naming</span>
<div class="viewcode-block" id="isotzdatetime_to_utcdatetime"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.isotzdatetime_to_utcdatetime">[docs]</a><span class="k">class</span> <span class="nc">isotzdatetime_to_utcdatetime</span><span class="p">(</span><span class="n">FunctionElement</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used as an SQL operation by PendulumDateTimeAsIsoTextColType.</span>

<span class="sd">    Creates an SQL expression wrapping a field containing our ISO-8601 text,</span>
<span class="sd">    making a DATETIME out of it, in the UTC timezone.</span>

<span class="sd">    Implemented for different SQL dialects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">()</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;isotzdatetime_to_utcdatetime&#39;</span></div>


<span class="c1"># noinspection PyUnusedLocal</span>
<div class="viewcode-block" id="isotzdatetime_to_utcdatetime_default"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.isotzdatetime_to_utcdatetime_default">[docs]</a><span class="nd">@compiles</span><span class="p">(</span><span class="n">isotzdatetime_to_utcdatetime</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">isotzdatetime_to_utcdatetime_default</span><span class="p">(</span>
        <span class="n">element</span><span class="p">:</span> <span class="s2">&quot;ClauseElement&quot;</span><span class="p">,</span>
        <span class="n">compiler</span><span class="p">:</span> <span class="s2">&quot;SQLCompiler&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Default implementation for isotzdatetime_to_utcdatetime: fail.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fail_unknown_dialect</span><span class="p">(</span><span class="n">compiler</span><span class="p">,</span> <span class="s2">&quot;perform isotzdatetime_to_utcdatetime&quot;</span><span class="p">)</span></div>


<span class="c1"># noinspection PyUnusedLocal</span>
<div class="viewcode-block" id="isotzdatetime_to_utcdatetime_mysql"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.isotzdatetime_to_utcdatetime_mysql">[docs]</a><span class="nd">@compiles</span><span class="p">(</span><span class="n">isotzdatetime_to_utcdatetime</span><span class="p">,</span> <span class="n">SqlaDialectName</span><span class="o">.</span><span class="n">MYSQL</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">isotzdatetime_to_utcdatetime_mysql</span><span class="p">(</span>
        <span class="n">element</span><span class="p">:</span> <span class="s2">&quot;ClauseElement&quot;</span><span class="p">,</span>
        <span class="n">compiler</span><span class="p">:</span> <span class="s2">&quot;SQLCompiler&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implementation of isotzdatetime_to_utcdatetime for MySQL.</span>
<span class="sd">    </span>
<span class="sd">    For format, see</span>
<span class="sd">    https://dev.mysql.com/doc/refman/5.5/en/date-and-time-functions.html#function_date-format</span>
<span class="sd">    </span>
<span class="sd">    Note the use of &quot;%i&quot; for minutes.</span>
<span class="sd">    </span>
<span class="sd">    Things after &quot;func.&quot; get passed to the database engine as literal SQL</span>
<span class="sd">    functions; http://docs.sqlalchemy.org/en/latest/core/tutorial.html</span>
<span class="sd">    &quot;&quot;&quot;</span>  <span class="c1"># noqa</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">fetch_processed_single_clause</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">)</span>

    <span class="c1"># Let&#39;s do this in a clear way:</span>
    <span class="n">date_time_part</span> <span class="o">=</span> <span class="s2">&quot;LEFT(</span><span class="si">{x}</span><span class="s2">, LENGTH(</span><span class="si">{x}</span><span class="s2">) - </span><span class="si">{tzl}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">tzl</span><span class="o">=</span><span class="n">_TZ_LEN</span><span class="p">)</span>
    <span class="c1"># ... drop the rightmost 6 chars (the timezone component)</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="n">compiler</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;&#39;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:</span><span class="si">%i</span><span class="s2">:%S.</span><span class="si">%f</span><span class="s2">&#39;&quot;</span><span class="p">))</span>
    <span class="c1"># ... the text() part deals with the necessary escaping of % for the DBAPI</span>
    <span class="n">the_date_time</span> <span class="o">=</span> <span class="s2">&quot;STR_TO_DATE(</span><span class="si">{date_time_part}</span><span class="s2">, </span><span class="si">{fmt}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">date_time_part</span><span class="o">=</span><span class="n">date_time_part</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">fmt</span><span class="p">)</span>
    <span class="c1"># ... STR_TO_DATE() returns a DATETIME if the string contains both date and</span>
    <span class="c1">#     time components.</span>
    <span class="n">old_timezone</span> <span class="o">=</span> <span class="s2">&quot;RIGHT(</span><span class="si">{x}</span><span class="s2">, </span><span class="si">{tzl}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">tzl</span><span class="o">=</span><span class="n">_TZ_LEN</span><span class="p">)</span>
    <span class="n">result_utc</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;CONVERT_TZ(</span><span class="si">{the_date_time}</span><span class="s2">, </span><span class="si">{old_timezone}</span><span class="s2">, </span><span class="si">{utc}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">the_date_time</span><span class="o">=</span><span class="n">the_date_time</span><span class="p">,</span>
            <span class="n">old_timezone</span><span class="o">=</span><span class="n">old_timezone</span><span class="p">,</span>
            <span class="n">utc</span><span class="o">=</span><span class="n">_UTC_TZ_LITERAL</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># log.critical(result_utc)</span>
    <span class="k">return</span> <span class="n">result_utc</span></div>


<span class="c1"># noinspection PyUnusedLocal</span>
<div class="viewcode-block" id="isotzdatetime_to_utcdatetime_sqlite"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.isotzdatetime_to_utcdatetime_sqlite">[docs]</a><span class="nd">@compiles</span><span class="p">(</span><span class="n">isotzdatetime_to_utcdatetime</span><span class="p">,</span> <span class="n">SqlaDialectName</span><span class="o">.</span><span class="n">SQLITE</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">isotzdatetime_to_utcdatetime_sqlite</span><span class="p">(</span>
        <span class="n">element</span><span class="p">:</span> <span class="s2">&quot;ClauseElement&quot;</span><span class="p">,</span>
        <span class="n">compiler</span><span class="p">:</span> <span class="s2">&quot;SQLCompiler&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implementation of isotzdatetime_to_utcdatetime for SQLite.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">fetch_processed_single_clause</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">)</span>

    <span class="c1"># https://sqlite.org/lang_corefunc.html#substr</span>
    <span class="c1"># https://sqlite.org/lang_datefunc.html</span>
    <span class="c1"># http://www.sqlite.org/lang_expr.html</span>
    <span class="c1">#</span>
    <span class="c1"># Get an SQL expression for the timezone adjustment in hours.</span>
    <span class="c1"># Note that if a time is 12:00+01:00, that means e.g. midday BST, which</span>
    <span class="c1"># is 11:00+00:00 or 11:00 UTC. So you SUBTRACT the displayed timezone from</span>
    <span class="c1"># the time, which I&#39;ve always thought is a bit odd.</span>
    <span class="c1">#</span>
    <span class="c1"># Ha! Was busy implementing this, but SQLite is magic; if there&#39;s a</span>
    <span class="c1"># timezone at the end, STRFTIME() will convert it to UTC automatically!</span>
    <span class="c1"># Moreover, the format is the OUTPUT format that a Python datetime will</span>
    <span class="c1"># recognize, so no &#39;T&#39;.</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="n">compiler</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">_SQLITE_DATETIME_FMT_FOR_PYTHON</span><span class="p">))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;STRFTIME(</span><span class="si">{fmt}</span><span class="s2">, </span><span class="si">{x}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="n">fmt</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>

    <span class="c1"># log.critical(result)</span>
    <span class="k">return</span> <span class="n">result</span></div>


<span class="c1"># noinspection PyUnusedLocal</span>
<div class="viewcode-block" id="isotzdatetime_to_utcdatetime_sqlserver"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.isotzdatetime_to_utcdatetime_sqlserver">[docs]</a><span class="nd">@compiles</span><span class="p">(</span><span class="n">isotzdatetime_to_utcdatetime</span><span class="p">,</span> <span class="n">SqlaDialectName</span><span class="o">.</span><span class="n">SQLSERVER</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">isotzdatetime_to_utcdatetime_sqlserver</span><span class="p">(</span>
        <span class="n">element</span><span class="p">:</span> <span class="s2">&quot;ClauseElement&quot;</span><span class="p">,</span>
        <span class="n">compiler</span><span class="p">:</span> <span class="s2">&quot;SQLCompiler&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implementation of isotzdatetime_to_utcdatetime for SQL Server.</span>

<span class="sd">    **Converting strings to DATETIME values**</span>

<span class="sd">    - CAST():     Part of ANSI SQL.</span>
<span class="sd">    - CONVERT():  Not part of ANSI SQL; has some extra formatting options.</span>

<span class="sd">    Both methods work:</span>

<span class="sd">    .. code-block:: sql</span>

<span class="sd">      SELECT CAST(&#39;2001-01-31T21:30:49.123&#39; AS DATETIME) AS via_cast,</span>
<span class="sd">             CONVERT(DATETIME, &#39;2001-01-31T21:30:49.123&#39;) AS via_convert;</span>

<span class="sd">    ... fine on SQL Server 2005, with milliseconds in both cases.</span>
<span class="sd">    However, going beyond milliseconds doesn&#39;t fail gracefully, it causes an</span>
<span class="sd">    error (e.g. &quot;...21:30.49.123456&quot;) both for CAST and CONVERT.</span>

<span class="sd">    The DATETIME2 format accepts greater precision, but requires SQL Server</span>
<span class="sd">    2008 or higher. Then this works:</span>

<span class="sd">    .. code-block:: sql</span>

<span class="sd">      SELECT CAST(&#39;2001-01-31T21:30:49.123456&#39; AS DATETIME2) AS via_cast,</span>
<span class="sd">             CONVERT(DATETIME2, &#39;2001-01-31T21:30:49.123456&#39;) AS via_convert;</span>

<span class="sd">    So as not to be too optimistic: CAST(x AS DATETIME2) ignores (silently) any</span>
<span class="sd">    timezone information in the string. So does CONVERT(DATETIME2, x, {0 or 1}).</span>

<span class="sd">    **Converting between time zones**</span>

<span class="sd">    NO TIME ZONE SUPPORT in SQL Server 2005.</span>
<span class="sd">    e.g. https://stackoverflow.com/questions/3200827/how-to-convert-timezones-in-sql-server-2005  # noqa</span>

<span class="sd">    .. code-block:: none</span>

<span class="sd">        TODATETIMEOFFSET(expression, time_zone):</span>
<span class="sd">              expression: something that evaluates to a DATETIME2 value</span>
<span class="sd">              time_zone: integer minutes, or string hours/minutes e.g. &quot;+13.00&quot;</span>
<span class="sd">          -&gt; produces a DATETIMEOFFSET value</span>

<span class="sd">    Available from SQL Server 2008.</span>
<span class="sd">    https://docs.microsoft.com/en-us/sql/t-sql/functions/todatetimeoffset-transact-sql  # noqa</span>

<span class="sd">    .. code-block:: none</span>

<span class="sd">        SWITCHOFFSET</span>
<span class="sd">          -&gt; converts one DATETIMEOFFSET value to another, preserving its UTC</span>
<span class="sd">             time, but changing the displayed (local) time zone.</span>

<span class="sd">    ... however, is that unnecessary? We want a plain ``DATETIME2`` in UTC, and</span>
<span class="sd">    .conversion to UTC is automatically achieved by ``CONVERT(DATETIME2,</span>
<span class="sd">    .some_datetimeoffset, 1)``</span>

<span class="sd">    ... https://stackoverflow.com/questions/4953903/how-can-i-convert-a-sql-server-2008-datetimeoffset-to-a-datetime  # noqa</span>

<span class="sd">    ... but not by ``CAST(some_datetimeoffset AS DATETIME2)``, and not by</span>
<span class="sd">    ``CONVERT(DATETIME2, some_datetimeoffset, 0)``</span>

<span class="sd">    ... and styles 0 and 1 are the only ones permissible from SQL Server 2012</span>
<span class="sd">    and up, empirically and (documented for the reverse direction at:</span>
<span class="sd">    https://docs.microsoft.com/en-us/sql/t-sql/functions/cast-and-convert-transact-sql?view=sql-server-2017  # noqa</span>

<span class="sd">    ... this is not properly documented re UTC conversion, as far as I can</span>
<span class="sd">    see. Let&#39;s use SWITCHOFFSET -&gt; CAST to be explicit and clear.</span>

<span class="sd">    AT TIME ZONE:</span>
<span class="sd">    From SQL Server 2016 only.</span>
<span class="sd">    https://docs.microsoft.com/en-us/sql/t-sql/queries/at-time-zone-transact-sql?view=sql-server-2017</span>

<span class="sd">    **Therefore**</span>

<span class="sd">    - We need to require SQL Server 2008 or higher.</span>
<span class="sd">    - Therefore we can use the DATETIME2 type.</span>
<span class="sd">    - Note that LEN(), not LENGTH(), is ANSI SQL; SQL Server only supports</span>
<span class="sd">      LEN.</span>

<span class="sd">    **Example (tested on SQL Server 2014)**</span>

<span class="sd">    .. code-block:: sql</span>

<span class="sd">        DECLARE @source AS VARCHAR(100) = &#39;2001-01-31T21:30:49.123456+07:00&#39;;</span>

<span class="sd">        SELECT CAST(</span>
<span class="sd">            SWITCHOFFSET(</span>
<span class="sd">                TODATETIMEOFFSET(</span>
<span class="sd">                    CAST(LEFT(@source, LEN(@source) - 6) AS DATETIME2),</span>
<span class="sd">                    RIGHT(@source, 6)</span>
<span class="sd">                ),</span>
<span class="sd">                &#39;+00:00&#39;</span>
<span class="sd">            )</span>
<span class="sd">            AS DATETIME2</span>
<span class="sd">        )  -- 2001-01-31 14:30:49.1234560</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">fetch_processed_single_clause</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">)</span>

    <span class="n">date_time_part</span> <span class="o">=</span> <span class="s2">&quot;LEFT(</span><span class="si">{x}</span><span class="s2">, LEN(</span><span class="si">{x}</span><span class="s2">) - {tzl)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">tzl</span><span class="o">=</span><span class="n">_TZ_LEN</span><span class="p">)</span>  <span class="c1"># a VARCHAR  # noqa</span>
    <span class="n">old_timezone</span> <span class="o">=</span> <span class="s2">&quot;RIGHT(</span><span class="si">{x}</span><span class="s2">, </span><span class="si">{tzl}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">tzl</span><span class="o">=</span><span class="n">_TZ_LEN</span><span class="p">)</span>  <span class="c1"># a VARCHAR</span>
    <span class="n">date_time_no_tz</span> <span class="o">=</span> <span class="s2">&quot;CAST(</span><span class="si">{dtp}</span><span class="s2"> AS DATETIME2)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtp</span><span class="o">=</span><span class="n">date_time_part</span><span class="p">)</span>  <span class="c1"># a DATETIME2  # noqa</span>
    <span class="n">date_time_offset_with_old_tz</span> <span class="o">=</span> <span class="s2">&quot;TODATETIMEOFFSET(</span><span class="si">{dt}</span><span class="s2">, </span><span class="si">{tz}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">dt</span><span class="o">=</span><span class="n">date_time_no_tz</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="n">old_timezone</span><span class="p">)</span>  <span class="c1"># a DATETIMEOFFSET</span>
    <span class="n">date_time_offset_with_utc_tz</span> <span class="o">=</span> <span class="s2">&quot;SWITCHOFFSET(</span><span class="si">{dto}</span><span class="s2">, </span><span class="si">{utc}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">dto</span><span class="o">=</span><span class="n">date_time_offset_with_old_tz</span><span class="p">,</span>
        <span class="n">utc</span><span class="o">=</span><span class="n">_UTC_TZ_LITERAL</span><span class="p">)</span>  <span class="c1"># a DATETIMEOFFSET in UTC</span>
    <span class="n">result_utc</span> <span class="o">=</span> <span class="s2">&quot;CAST(</span><span class="si">{dtu}</span><span class="s2"> AS DATETIME2&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">dtu</span><span class="o">=</span><span class="n">date_time_offset_with_utc_tz</span><span class="p">)</span>

    <span class="c1"># log.critical(result_utc)</span>
    <span class="k">return</span> <span class="n">result_utc</span></div>


<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># unknown_field_to_utcdatetime</span>
<span class="c1"># -----------------------------------------------------------------------------</span>

<span class="c1"># noinspection PyPep8Naming</span>
<div class="viewcode-block" id="unknown_field_to_utcdatetime"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.unknown_field_to_utcdatetime">[docs]</a><span class="k">class</span> <span class="nc">unknown_field_to_utcdatetime</span><span class="p">(</span><span class="n">FunctionElement</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used as an SQL operation by PendulumDateTimeAsIsoTextColType.</span>

<span class="sd">    Creates an SQL expression wrapping a field containing something unknown,</span>
<span class="sd">    which might be a DATETIME or an ISO-formatted field, and</span>
<span class="sd">    making a DATETIME out of it, in the UTC timezone.</span>

<span class="sd">    Implemented for different SQL dialects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">()</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;unknown_field_to_utcdatetime&#39;</span></div>


<span class="c1"># noinspection PyUnusedLocal</span>
<div class="viewcode-block" id="unknown_field_to_utcdatetime_default"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.unknown_field_to_utcdatetime_default">[docs]</a><span class="nd">@compiles</span><span class="p">(</span><span class="n">unknown_field_to_utcdatetime</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">unknown_field_to_utcdatetime_default</span><span class="p">(</span>
        <span class="n">element</span><span class="p">:</span> <span class="s2">&quot;ClauseElement&quot;</span><span class="p">,</span>
        <span class="n">compiler</span><span class="p">:</span> <span class="s2">&quot;SQLCompiler&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Default implementation for unknown_field_to_utcdatetime: fail.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fail_unknown_dialect</span><span class="p">(</span><span class="n">compiler</span><span class="p">,</span> <span class="s2">&quot;perform unknown_field_to_utcdatetime&quot;</span><span class="p">)</span></div>


<span class="c1"># noinspection PyUnusedLocal</span>
<div class="viewcode-block" id="unknown_field_to_utcdatetime_mysql"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.unknown_field_to_utcdatetime_mysql">[docs]</a><span class="nd">@compiles</span><span class="p">(</span><span class="n">unknown_field_to_utcdatetime</span><span class="p">,</span> <span class="n">SqlaDialectName</span><span class="o">.</span><span class="n">MYSQL</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">unknown_field_to_utcdatetime_mysql</span><span class="p">(</span>
        <span class="n">element</span><span class="p">:</span> <span class="s2">&quot;ClauseElement&quot;</span><span class="p">,</span>
        <span class="n">compiler</span><span class="p">:</span> <span class="s2">&quot;SQLCompiler&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implementation of unknown_field_to_utcdatetime for MySQL.</span>

<span class="sd">    If it&#39;s the length of a plain DATETIME e.g. &quot;2013-05-30 00:00:00&quot; (19),</span>
<span class="sd">    leave it as a DATETIME; otherwise convert ISO -&gt; DATETIME</span>
<span class="sd">    log.critical(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">fetch_processed_single_clause</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;IF(LENGTH(</span><span class="si">{x}</span><span class="s2">) = </span><span class="si">{dtlen}</span><span class="s2">, </span><span class="si">{x}</span><span class="s2">, </span><span class="si">{converted}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
        <span class="n">dtlen</span><span class="o">=</span><span class="n">_MYSQL_DATETIME_LEN</span><span class="p">,</span>
        <span class="n">converted</span><span class="o">=</span><span class="n">isotzdatetime_to_utcdatetime_mysql</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span></div>


<span class="c1"># noinspection PyUnusedLocal</span>
<div class="viewcode-block" id="unknown_field_to_utcdatetime_sqlite"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.unknown_field_to_utcdatetime_sqlite">[docs]</a><span class="nd">@compiles</span><span class="p">(</span><span class="n">unknown_field_to_utcdatetime</span><span class="p">,</span> <span class="n">SqlaDialectName</span><span class="o">.</span><span class="n">SQLITE</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">unknown_field_to_utcdatetime_sqlite</span><span class="p">(</span>
        <span class="n">element</span><span class="p">:</span> <span class="s2">&quot;ClauseElement&quot;</span><span class="p">,</span>
        <span class="n">compiler</span><span class="p">:</span> <span class="s2">&quot;SQLCompiler&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implementation of unknown_field_to_utcdatetime for SQLite.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">fetch_processed_single_clause</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">)</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="n">compiler</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">_SQLITE_DATETIME_FMT_FOR_PYTHON</span><span class="p">))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;STRFTIME(</span><span class="si">{fmt}</span><span class="s2">, </span><span class="si">{x}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="n">fmt</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
    <span class="c1"># log.critical(result)</span>
    <span class="k">return</span> <span class="n">result</span></div>


<span class="c1"># noinspection PyUnusedLocal</span>
<div class="viewcode-block" id="unknown_field_to_utcdatetime_sqlserver"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.unknown_field_to_utcdatetime_sqlserver">[docs]</a><span class="nd">@compiles</span><span class="p">(</span><span class="n">unknown_field_to_utcdatetime</span><span class="p">,</span> <span class="n">SqlaDialectName</span><span class="o">.</span><span class="n">SQLSERVER</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">unknown_field_to_utcdatetime_sqlserver</span><span class="p">(</span>
        <span class="n">element</span><span class="p">:</span> <span class="s2">&quot;ClauseElement&quot;</span><span class="p">,</span>
        <span class="n">compiler</span><span class="p">:</span> <span class="s2">&quot;SQLCompiler&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implementation of unknown_field_to_utcdatetime for SQL Server.</span>

<span class="sd">    We should cope also with the possibility of a DATETIME2 field, not just</span>
<span class="sd">    DATETIME. It seems consistent that LEN(DATETIME2) = 27, with precision</span>
<span class="sd">    tenth of a microsecond, e.g. ``2001-01-31 21:30:49.1234567`` (27).</span>

<span class="sd">    So, if it looks like a DATETIME or a DATETIME2, then we leave it alone;</span>
<span class="sd">    otherwise we put it through our ISO-to-datetime function.</span>

<span class="sd">    Importantly, note that neither _SQLSERVER_DATETIME_LEN nor</span>
<span class="sd">    _SQLSERVER_DATETIME2_LEN are the length of any of our ISO strings.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">fetch_processed_single_clause</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">)</span>
    <span class="c1"># https://stackoverflow.com/questions/5487892/sql-server-case-when-or-then-else-end-the-or-is-not-supported  # noqa</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;CASE &quot;</span>
        <span class="s2">&quot;WHEN LEN(</span><span class="si">{x}</span><span class="s2">) IN (</span><span class="si">{dtlen}</span><span class="s2">, </span><span class="si">{dt2len}</span><span class="s2">) THEN </span><span class="si">{x}</span><span class="s2"> &quot;</span>
        <span class="s2">&quot;ELSE </span><span class="si">{converted}</span><span class="s2"> &quot;</span>
        <span class="s2">&quot;END&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
            <span class="n">dtlen</span><span class="o">=</span><span class="n">_SQLSERVER_DATETIME_LEN</span><span class="p">,</span>
            <span class="n">dt2len</span><span class="o">=</span><span class="n">_SQLSERVER_DATETIME2_LEN</span><span class="p">,</span>
            <span class="n">converted</span><span class="o">=</span><span class="n">isotzdatetime_to_utcdatetime_sqlserver</span><span class="p">(</span>
                <span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="c1"># log.critical(result)</span>
    <span class="k">return</span> <span class="n">result</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Custom date/time field as ISO-8601 text including timezone, using Pendulum</span>
<span class="c1"># on the Python side.</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="PendulumDateTimeAsIsoTextColType"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.PendulumDateTimeAsIsoTextColType">[docs]</a><span class="k">class</span> <span class="nc">PendulumDateTimeAsIsoTextColType</span><span class="p">(</span><span class="n">TypeDecorator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stores date/time values as ISO-8601, in a specific format.</span>
<span class="sd">    Uses Pendulum on the Python side.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">impl</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">ISO8601_STRING_MAX_LEN</span><span class="p">)</span>  <span class="c1"># underlying SQL type</span>

    <span class="n">_coltype_name</span> <span class="o">=</span> <span class="s2">&quot;PendulumDateTimeAsIsoTextColType&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">python_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Pendulum</span>

<div class="viewcode-block" id="PendulumDateTimeAsIsoTextColType.pendulum_to_isostring"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.PendulumDateTimeAsIsoTextColType.pendulum_to_isostring">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">pendulum_to_isostring</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">PotentialDatetimeType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        From a Python datetime to an ISO-formatted string in our particular</span>
<span class="sd">        format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># https://docs.python.org/3.4/library/datetime.html#strftime-strptime-behavior  # noqa</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">coerce_to_pendulum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mainpart</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># microsecond accuracy  # noqa</span>
            <span class="n">timezone</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%z&quot;</span><span class="p">)</span>  <span class="c1"># won&#39;t have the colon in</span>
            <span class="k">return</span> <span class="n">mainpart</span> <span class="o">+</span> <span class="n">timezone</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">timezone</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="PendulumDateTimeAsIsoTextColType.isostring_to_pendulum"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.PendulumDateTimeAsIsoTextColType.isostring_to_pendulum">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">isostring_to_pendulum</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Pendulum</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;From an ISO-formatted string to a Python Pendulum, with timezone.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">coerce_to_pendulum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">ParserError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Bad ISO date/time string: </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="PendulumDateTimeAsIsoTextColType.process_bind_param"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.PendulumDateTimeAsIsoTextColType.process_bind_param">[docs]</a>    <span class="k">def</span> <span class="nf">process_bind_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Pendulum</span><span class="p">],</span>
                           <span class="n">dialect</span><span class="p">:</span> <span class="n">Dialect</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Convert things on the way from Python to the database.&quot;&quot;&quot;</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pendulum_to_isostring</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">DEBUG_DATETIME_AS_ISO_TEXT</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.process_bind_param(&quot;</span>
                <span class="s2">&quot;self=</span><span class="si">{!r}</span><span class="s2">, value=</span><span class="si">{!r}</span><span class="s2">, dialect=</span><span class="si">{!r}</span><span class="s2">) -&gt; </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_coltype_name</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dialect</span><span class="p">,</span> <span class="n">retval</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">retval</span></div>

<div class="viewcode-block" id="PendulumDateTimeAsIsoTextColType.process_literal_param"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.PendulumDateTimeAsIsoTextColType.process_literal_param">[docs]</a>    <span class="k">def</span> <span class="nf">process_literal_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Pendulum</span><span class="p">],</span>
                              <span class="n">dialect</span><span class="p">:</span> <span class="n">Dialect</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Convert things on the way from Python to the database.&quot;&quot;&quot;</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pendulum_to_isostring</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">DEBUG_DATETIME_AS_ISO_TEXT</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.process_literal_param(&quot;</span>
                <span class="s2">&quot;self=</span><span class="si">{!r}</span><span class="s2">, value=</span><span class="si">{!r}</span><span class="s2">, dialect=</span><span class="si">{!r}</span><span class="s2">) -&gt; </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_coltype_name</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dialect</span><span class="p">,</span> <span class="n">retval</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">retval</span></div>

<div class="viewcode-block" id="PendulumDateTimeAsIsoTextColType.process_result_value"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.PendulumDateTimeAsIsoTextColType.process_result_value">[docs]</a>    <span class="k">def</span> <span class="nf">process_result_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                             <span class="n">dialect</span><span class="p">:</span> <span class="n">Dialect</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Pendulum</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Convert things on the way from the database to Python.&quot;&quot;&quot;</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isostring_to_pendulum</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">DEBUG_DATETIME_AS_ISO_TEXT</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.process_result_value(&quot;</span>
                <span class="s2">&quot;self=</span><span class="si">{!r}</span><span class="s2">, value=</span><span class="si">{!r}</span><span class="s2">, dialect=</span><span class="si">{!r}</span><span class="s2">) -&gt; </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_coltype_name</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dialect</span><span class="p">,</span> <span class="n">retval</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">retval</span></div>

    <span class="c1"># noinspection PyPep8Naming</span>
<div class="viewcode-block" id="PendulumDateTimeAsIsoTextColType.comparator_factory"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.PendulumDateTimeAsIsoTextColType.comparator_factory">[docs]</a>    <span class="k">class</span> <span class="nc">comparator_factory</span><span class="p">(</span><span class="n">TypeDecorator</span><span class="o">.</span><span class="n">Comparator</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process SQL for when we are comparing our column, in the database,</span>
<span class="sd">        to something else.</span>

<span class="sd">        We make this dialect-independent by calling functions like</span>

<span class="sd">        .. code-block:: none</span>

<span class="sd">            unknown_field_to_utcdatetime</span>
<span class="sd">            isotzdatetime_to_utcdatetime</span>

<span class="sd">        ... which we then specialize for specific dialects.</span>
<span class="sd">        &quot;&quot;&quot;</span>

<div class="viewcode-block" id="PendulumDateTimeAsIsoTextColType.comparator_factory.operate"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.PendulumDateTimeAsIsoTextColType.comparator_factory.operate">[docs]</a>        <span class="k">def</span> <span class="nf">operate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">other</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">kwargs</span>
            <span class="n">other</span> <span class="o">=</span> <span class="n">other</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">processed_other</span> <span class="o">=</span> <span class="n">convert_datetime_to_utc</span><span class="p">(</span>
                    <span class="n">coerce_to_pendulum</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="n">ParserError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                <span class="c1"># OK. At this point, &quot;other&quot; could be a plain DATETIME field,</span>
                <span class="c1"># or a PendulumDateTimeAsIsoTextColType field (or potentially</span>
                <span class="c1"># something else that we don&#39;t really care about). If it&#39;s a</span>
                <span class="c1"># DATETIME, then we assume it is already in UTC.</span>
                <span class="n">processed_other</span> <span class="o">=</span> <span class="n">unknown_field_to_utcdatetime</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">DEBUG_DATETIME_AS_ISO_TEXT</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;operate(self=</span><span class="si">{!r}</span><span class="s2">, op=</span><span class="si">{!r}</span><span class="s2">, other=</span><span class="si">{!r}</span><span class="s2">)&quot;</span><span class="p">,</span>
                          <span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;self.expr = </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>
                <span class="c1"># traceback.print_stack()</span>
            <span class="k">return</span> <span class="n">op</span><span class="p">(</span><span class="n">isotzdatetime_to_utcdatetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="p">),</span>
                      <span class="n">processed_other</span><span class="p">)</span></div>

<div class="viewcode-block" id="PendulumDateTimeAsIsoTextColType.comparator_factory.reverse_operate"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.PendulumDateTimeAsIsoTextColType.comparator_factory.reverse_operate">[docs]</a>        <span class="k">def</span> <span class="nf">reverse_operate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">other</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;I don&#39;t think this is ever being called&quot;</span></div></div></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Semantic version column type</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="SemanticVersionColType"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.SemanticVersionColType">[docs]</a><span class="k">class</span> <span class="nc">SemanticVersionColType</span><span class="p">(</span><span class="n">TypeDecorator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stores semantic versions in the database.</span>
<span class="sd">    Uses semantic_version.Version on the Python side.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">impl</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">147</span><span class="p">)</span>  <span class="c1"># https://github.com/mojombo/semver/issues/79</span>

    <span class="n">_coltype_name</span> <span class="o">=</span> <span class="s2">&quot;SemanticVersionColType&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">python_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Version</span>

<div class="viewcode-block" id="SemanticVersionColType.process_bind_param"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.SemanticVersionColType.process_bind_param">[docs]</a>    <span class="k">def</span> <span class="nf">process_bind_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Version</span><span class="p">],</span>
                           <span class="n">dialect</span><span class="p">:</span> <span class="n">Dialect</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Convert things on the way from Python to the database.&quot;&quot;&quot;</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">DEBUG_SEMANTIC_VERSION</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.process_bind_param(&quot;</span>
                <span class="s2">&quot;self=</span><span class="si">{!r}</span><span class="s2">, value=</span><span class="si">{!r}</span><span class="s2">, dialect=</span><span class="si">{!r}</span><span class="s2">) -&gt; </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_coltype_name</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dialect</span><span class="p">,</span> <span class="n">retval</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">retval</span></div>

<div class="viewcode-block" id="SemanticVersionColType.process_literal_param"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.SemanticVersionColType.process_literal_param">[docs]</a>    <span class="k">def</span> <span class="nf">process_literal_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Version</span><span class="p">],</span>
                              <span class="n">dialect</span><span class="p">:</span> <span class="n">Dialect</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Convert things on the way from Python to the database.&quot;&quot;&quot;</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">DEBUG_SEMANTIC_VERSION</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.process_literal_param(&quot;</span>
                <span class="s2">&quot;self=</span><span class="si">{!r}</span><span class="s2">, value=</span><span class="si">{!r}</span><span class="s2">, dialect=</span><span class="si">{!r}</span><span class="s2">) -&gt; !r&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_coltype_name</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dialect</span><span class="p">,</span> <span class="n">retval</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">retval</span></div>

<div class="viewcode-block" id="SemanticVersionColType.process_result_value"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.SemanticVersionColType.process_result_value">[docs]</a>    <span class="k">def</span> <span class="nf">process_result_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                             <span class="n">dialect</span><span class="p">:</span> <span class="n">Dialect</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Version</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Convert things on the way from the database to Python.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Here we do some slightly fancier conversion to deal with all</span>
            <span class="c1"># sorts of potential rubbish coming in, so we get a properly</span>
            <span class="c1"># ordered Version out:</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="n">make_version</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">DEBUG_SEMANTIC_VERSION</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.process_result_value(&quot;</span>
                <span class="s2">&quot;self=</span><span class="si">{!r}</span><span class="s2">, value=</span><span class="si">{!r}</span><span class="s2">, dialect=</span><span class="si">{!r}</span><span class="s2">) -&gt; </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_coltype_name</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dialect</span><span class="p">,</span> <span class="n">retval</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">retval</span></div>

    <span class="c1"># noinspection PyPep8Naming</span>
<div class="viewcode-block" id="SemanticVersionColType.comparator_factory"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.SemanticVersionColType.comparator_factory">[docs]</a>    <span class="k">class</span> <span class="nc">comparator_factory</span><span class="p">(</span><span class="n">TypeDecorator</span><span class="o">.</span><span class="n">Comparator</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process SQL for when we are comparing our column, in the database,</span>
<span class="sd">        to something else.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="SemanticVersionColType.comparator_factory.operate"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.SemanticVersionColType.comparator_factory.operate">[docs]</a>        <span class="k">def</span> <span class="nf">operate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">other</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">kwargs</span>
            <span class="n">other</span> <span class="o">=</span> <span class="n">other</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Version</span><span class="p">):</span>
                <span class="n">processed_other</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Version</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">processed_other</span> <span class="o">=</span> <span class="n">other</span>
            <span class="k">return</span> <span class="n">op</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">processed_other</span><span class="p">)</span></div>

<div class="viewcode-block" id="SemanticVersionColType.comparator_factory.reverse_operate"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.SemanticVersionColType.comparator_factory.reverse_operate">[docs]</a>        <span class="k">def</span> <span class="nf">reverse_operate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">other</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;I don&#39;t think this is ever being called&quot;</span></div></div></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># IdNumReferenceListColType</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="IdNumReferenceListColType"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.IdNumReferenceListColType">[docs]</a><span class="k">class</span> <span class="nc">IdNumReferenceListColType</span><span class="p">(</span><span class="n">TypeDecorator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stores a list of IdNumReference objects.</span>
<span class="sd">    On the database side, uses a comma-separated list of integers.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">impl</span> <span class="o">=</span> <span class="n">Text</span><span class="p">()</span>
    <span class="n">_coltype_name</span> <span class="o">=</span> <span class="s2">&quot;IdNumReferenceListColType&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">python_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_idnumdef_list_to_dbstr</span><span class="p">(</span>
            <span class="n">idnumdef_list</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">IdNumReference</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">idnumdef_list</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="n">elements</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[int]</span>
        <span class="k">for</span> <span class="n">idnumdef</span> <span class="ow">in</span> <span class="n">idnumdef_list</span><span class="p">:</span>
            <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idnumdef</span><span class="o">.</span><span class="n">which_idnum</span><span class="p">)</span>
            <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idnumdef</span><span class="o">.</span><span class="n">idnum_value</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_dbstr_to_idnumdef_list</span><span class="p">(</span><span class="n">dbstr</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">IdNumReference</span><span class="p">]:</span>
        <span class="n">idnumdef_list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[IdNumReference]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">intlist</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">numstr</span><span class="p">)</span> <span class="k">for</span> <span class="n">numstr</span> <span class="ow">in</span> <span class="n">dbstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">intlist</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">length</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># enforce pairs</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">which_idnum</span><span class="p">,</span> <span class="n">idnum_value</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">(</span><span class="n">intlist</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">which_idnum</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">idnum_value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># enforce positive integers</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="n">idnumdef_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">IdNumReference</span><span class="p">(</span><span class="n">which_idnum</span><span class="o">=</span><span class="n">which_idnum</span><span class="p">,</span>
                                                <span class="n">idnum_value</span><span class="o">=</span><span class="n">idnum_value</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">idnumdef_list</span>

<div class="viewcode-block" id="IdNumReferenceListColType.process_bind_param"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.IdNumReferenceListColType.process_bind_param">[docs]</a>    <span class="k">def</span> <span class="nf">process_bind_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">IdNumReference</span><span class="p">]],</span>
                           <span class="n">dialect</span><span class="p">:</span> <span class="n">Dialect</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Convert things on the way from Python to the database.&quot;&quot;&quot;</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idnumdef_list_to_dbstr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">DEBUG_IDNUMDEF_LIST</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.process_bind_param(&quot;</span>
                <span class="s2">&quot;self=</span><span class="si">{!r}</span><span class="s2">, value=</span><span class="si">{!r}</span><span class="s2">, dialect=</span><span class="si">{!r}</span><span class="s2">) -&gt; </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_coltype_name</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dialect</span><span class="p">,</span> <span class="n">retval</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">retval</span></div>

<div class="viewcode-block" id="IdNumReferenceListColType.process_literal_param"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.IdNumReferenceListColType.process_literal_param">[docs]</a>    <span class="k">def</span> <span class="nf">process_literal_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">IdNumReference</span><span class="p">]],</span>
                              <span class="n">dialect</span><span class="p">:</span> <span class="n">Dialect</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Convert things on the way from Python to the database.&quot;&quot;&quot;</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idnumdef_list_to_dbstr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">DEBUG_IDNUMDEF_LIST</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.process_literal_param(&quot;</span>
                <span class="s2">&quot;self=</span><span class="si">{!r}</span><span class="s2">, value=</span><span class="si">{!r}</span><span class="s2">, dialect=</span><span class="si">{!r}</span><span class="s2">) -&gt; !r&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_coltype_name</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dialect</span><span class="p">,</span> <span class="n">retval</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">retval</span></div>

<div class="viewcode-block" id="IdNumReferenceListColType.process_result_value"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.IdNumReferenceListColType.process_result_value">[docs]</a>    <span class="k">def</span> <span class="nf">process_result_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                             <span class="n">dialect</span><span class="p">:</span> <span class="n">Dialect</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">IdNumReference</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Convert things on the way from the database to Python.&quot;&quot;&quot;</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbstr_to_idnumdef_list</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">DEBUG_IDNUMDEF_LIST</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.process_result_value(&quot;</span>
                <span class="s2">&quot;self=</span><span class="si">{!r}</span><span class="s2">, value=</span><span class="si">{!r}</span><span class="s2">, dialect=</span><span class="si">{!r}</span><span class="s2">) -&gt; </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_coltype_name</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dialect</span><span class="p">,</span> <span class="n">retval</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">retval</span></div></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># PermittedValueChecker: used by CamcopsColumn</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="PermittedValueChecker"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.PermittedValueChecker">[docs]</a><span class="k">class</span> <span class="nc">PermittedValueChecker</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents permitted values, and checks a value against them.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">not_null</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">minimum</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">maximum</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">permitted_values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">not_null</span> <span class="o">=</span> <span class="n">not_null</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="n">minimum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">maximum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">permitted_values</span> <span class="o">=</span> <span class="n">permitted_values</span>

    <span class="k">def</span> <span class="nf">is_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">not_null</span>
            <span class="c1"># If not_null is True, then the value is not OK; return False.</span>
            <span class="c1"># If not_null is False, then a null value passes all other tests.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">permitted_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">permitted_values</span><span class="p">:</span>  <span class="c1"># noqa</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimum</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maximum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maximum</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">failure_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">not_null</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;value is None and NULL values are not permitted&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># value is OK</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">permitted_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">permitted_values</span><span class="p">:</span>  <span class="c1"># noqa</span>
            <span class="k">return</span> <span class="s2">&quot;value </span><span class="si">{!r}</span><span class="s2"> not in permitted values </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">permitted_values</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimum</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;value </span><span class="si">{!r}</span><span class="s2"> less than minimum of </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimum</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maximum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maximum</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;value </span><span class="si">{!r}</span><span class="s2"> more than maximum of </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">maximum</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">auto_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>


<span class="c1"># Specific instances, to reduce object duplication and magic numbers:</span>

<span class="n">MIN_ZERO_CHECKER</span> <span class="o">=</span> <span class="n">PermittedValueChecker</span><span class="p">(</span><span class="n">minimum</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">BIT_CHECKER</span> <span class="o">=</span> <span class="n">PermittedValueChecker</span><span class="p">(</span><span class="n">permitted_values</span><span class="o">=</span><span class="n">PV</span><span class="o">.</span><span class="n">BIT</span><span class="p">)</span>
<span class="n">ZERO_TO_ONE_CHECKER</span> <span class="o">=</span> <span class="n">PermittedValueChecker</span><span class="p">(</span><span class="n">minimum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">maximum</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ZERO_TO_TWO_CHECKER</span> <span class="o">=</span> <span class="n">PermittedValueChecker</span><span class="p">(</span><span class="n">minimum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">maximum</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ZERO_TO_THREE_CHECKER</span> <span class="o">=</span> <span class="n">PermittedValueChecker</span><span class="p">(</span><span class="n">minimum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">maximum</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">ZERO_TO_FOUR_CHECKER</span> <span class="o">=</span> <span class="n">PermittedValueChecker</span><span class="p">(</span><span class="n">minimum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">maximum</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">ZERO_TO_FIVE_CHECKER</span> <span class="o">=</span> <span class="n">PermittedValueChecker</span><span class="p">(</span><span class="n">minimum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">maximum</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="n">ONE_TO_TWO_CHECKER</span> <span class="o">=</span> <span class="n">PermittedValueChecker</span><span class="p">(</span><span class="n">minimum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">maximum</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ONE_TO_THREE_CHECKER</span> <span class="o">=</span> <span class="n">PermittedValueChecker</span><span class="p">(</span><span class="n">minimum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">maximum</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">ONE_TO_FOUR_CHECKER</span> <span class="o">=</span> <span class="n">PermittedValueChecker</span><span class="p">(</span><span class="n">minimum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">maximum</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">ONE_TO_FIVE_CHECKER</span> <span class="o">=</span> <span class="n">PermittedValueChecker</span><span class="p">(</span><span class="n">minimum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">maximum</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">ONE_TO_SIX_CHECKER</span> <span class="o">=</span> <span class="n">PermittedValueChecker</span><span class="p">(</span><span class="n">minimum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">maximum</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="n">ONE_TO_SEVEN_CHECKER</span> <span class="o">=</span> <span class="n">PermittedValueChecker</span><span class="p">(</span><span class="n">minimum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">maximum</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
<span class="n">ONE_TO_EIGHT_CHECKER</span> <span class="o">=</span> <span class="n">PermittedValueChecker</span><span class="p">(</span><span class="n">minimum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">maximum</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">ONE_TO_NINE_CHECKER</span> <span class="o">=</span> <span class="n">PermittedValueChecker</span><span class="p">(</span><span class="n">minimum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">maximum</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># CamcopsColumn: provides extra functions over Column.</span>
<span class="c1"># =============================================================================</span>

<span class="c1"># noinspection PyAbstractClass</span>
<div class="viewcode-block" id="CamcopsColumn"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.CamcopsColumn">[docs]</a><span class="k">class</span> <span class="nc">CamcopsColumn</span><span class="p">(</span><span class="n">Column</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Column class that supports some CamCOPS-specific flags, such as whether</span>
<span class="sd">    a field is a BLOB reference; how it should be treated for anonymisation;</span>
<span class="sd">    and which values are permitted in the field (in a soft sense: duff values</span>
<span class="sd">    cause errors to be reported, but they&#39;re still stored).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                 <span class="n">cris_include</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">exempt_from_anonymisation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">identifies_patient</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">is_blob_id_field</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">blob_relationship_attr_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                 <span class="n">permitted_value_checker</span><span class="p">:</span> <span class="n">PermittedValueChecker</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cris_include</span> <span class="o">=</span> <span class="n">cris_include</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exempt_from_anonymisation</span> <span class="o">=</span> <span class="n">exempt_from_anonymisation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identifies_patient</span> <span class="o">=</span> <span class="n">identifies_patient</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_blob_id_field</span> <span class="o">=</span> <span class="n">is_blob_id_field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blob_relationship_attr_name</span> <span class="o">=</span> <span class="n">blob_relationship_attr_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">permitted_value_checker</span> <span class="o">=</span> <span class="n">permitted_value_checker</span>
        <span class="k">if</span> <span class="n">is_blob_id_field</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">blob_relationship_attr_name</span><span class="p">,</span> <span class="p">(</span>
                <span class="s2">&quot;If specifying a BLOB ID field, must give the attribute name &quot;</span>
                <span class="s2">&quot;of the relationship too&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_constructor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># https://bitbucket.org/zzzeek/sqlalchemy/issues/2284/please-make-column-easier-to-subclass  # noqa</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;cris_include&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cris_include</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;exempt_from_anonymisation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exempt_from_anonymisation</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;identifies_patient&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifies_patient</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;is_blob_id_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_blob_id_field</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;blob_relationship_attr_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blob_relationship_attr_name</span>  <span class="c1"># noqa</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;permitted_value_checker&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">permitted_value_checker</span>
        <span class="k">return</span> <span class="n">CamcopsColumn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">kvp</span><span class="p">(</span><span class="n">attrname</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">=</span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attrname</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrname</span><span class="p">))</span>
        <span class="n">elements</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">kvp</span><span class="p">(</span><span class="s2">&quot;cris_include&quot;</span><span class="p">),</span>
            <span class="n">kvp</span><span class="p">(</span><span class="s2">&quot;exempt_from_anonymisation&quot;</span><span class="p">),</span>
            <span class="n">kvp</span><span class="p">(</span><span class="s2">&quot;identifies_patient&quot;</span><span class="p">),</span>
            <span class="n">kvp</span><span class="p">(</span><span class="s2">&quot;is_blob_id_field&quot;</span><span class="p">),</span>
            <span class="n">kvp</span><span class="p">(</span><span class="s2">&quot;blob_relationship_attr_name&quot;</span><span class="p">),</span>
            <span class="n">kvp</span><span class="p">(</span><span class="s2">&quot;permitted_value_checker&quot;</span><span class="p">),</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">(),</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="s2">&quot;CamcopsColumn(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">elements</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">set_permitted_value_checker</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">permitted_value_checker</span><span class="p">:</span> <span class="n">PermittedValueChecker</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">permitted_value_checker</span> <span class="o">=</span> <span class="n">permitted_value_checker</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Operate on Column/CamcopsColumn properties</span>
<span class="c1"># =============================================================================</span>

<span class="k">def</span> <span class="nf">gen_columns_matching_attrnames</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attrnames</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> \
        <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Column</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">gen_columns</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attrname</span> <span class="ow">in</span> <span class="n">attrnames</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">column</span>


<div class="viewcode-block" id="gen_camcops_columns"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.gen_camcops_columns">[docs]</a><span class="k">def</span> <span class="nf">gen_camcops_columns</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">CamcopsColumn</span><span class="p">],</span>
                                          <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yields tuples of (attr_name, CamcopsColumn) from an object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">gen_columns</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">CamcopsColumn</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">column</span></div>


<div class="viewcode-block" id="gen_camcops_blob_columns"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.gen_camcops_blob_columns">[docs]</a><span class="k">def</span> <span class="nf">gen_camcops_blob_columns</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">CamcopsColumn</span><span class="p">],</span>
                                               <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yields tuples of (attr_name, CamcopsColumn) from a class where those</span>
<span class="sd">    CamcopsColumns are for fields referencing the BLOB table.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">gen_camcops_columns</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">is_blob_id_field</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attrname</span> <span class="o">!=</span> <span class="n">column</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;BLOB field where attribute name </span><span class="si">{!r}</span><span class="s2"> != SQL &quot;</span>
                            <span class="s2">&quot;column name </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">column</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">column</span></div>


<span class="k">def</span> <span class="nf">get_column_attr_names</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">attrname</span> <span class="k">for</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">gen_columns</span><span class="p">(</span><span class="n">obj</span><span class="p">)]</span>


<span class="k">def</span> <span class="nf">get_camcops_column_attr_names</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">attrname</span> <span class="k">for</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">gen_camcops_columns</span><span class="p">(</span><span class="n">obj</span><span class="p">)]</span>


<span class="k">def</span> <span class="nf">get_camcops_blob_column_attr_names</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">attrname</span> <span class="k">for</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">gen_camcops_blob_columns</span><span class="p">(</span><span class="n">obj</span><span class="p">)]</span>


<div class="viewcode-block" id="permitted_value_failure_msgs"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.permitted_value_failure_msgs">[docs]</a><span class="k">def</span> <span class="nf">permitted_value_failure_msgs</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks a SQLAlchemy ORM object instance against its PermittedValueColumn</span>
<span class="sd">    checks, if it has any.</span>
<span class="sd">    Returns a list of failure messages (empty list means all OK).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">failure_msgs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">camcops_column</span> <span class="ow">in</span> <span class="n">gen_camcops_columns</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="n">pv_checker</span> <span class="o">=</span> <span class="n">camcops_column</span><span class="o">.</span><span class="n">permitted_value_checker</span>  <span class="c1"># type: Optional[PermittedValueChecker]  # noqa</span>
        <span class="k">if</span> <span class="n">pv_checker</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attrname</span><span class="p">)</span>
        <span class="n">failure_msg</span> <span class="o">=</span> <span class="n">pv_checker</span><span class="o">.</span><span class="n">failure_msg</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">failure_msg</span><span class="p">:</span>
            <span class="n">failure_msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;Invalid value for </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attrname</span><span class="p">,</span> <span class="n">failure_msg</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">failure_msgs</span></div>


<div class="viewcode-block" id="permitted_values_ok"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.permitted_values_ok">[docs]</a><span class="k">def</span> <span class="nf">permitted_values_ok</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Faster way of checking WHETHER an instance passes its PermittedValueColumn</span>
<span class="sd">    checks, if it has any.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">camcops_column</span> <span class="ow">in</span> <span class="n">gen_camcops_columns</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="n">pv_checker</span> <span class="o">=</span> <span class="n">camcops_column</span><span class="o">.</span><span class="n">permitted_value_checker</span>  <span class="c1"># type: Optional[PermittedValueChecker]  # noqa</span>
        <span class="k">if</span> <span class="n">pv_checker</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attrname</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pv_checker</span><span class="o">.</span><span class="n">is_ok</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="gen_ancillary_relationships"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.gen_ancillary_relationships">[docs]</a><span class="k">def</span> <span class="nf">gen_ancillary_relationships</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span>
        <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">RelationshipProperty</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;GenericTabletRecordMixin&quot;</span><span class="p">]],</span>
        <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yields tuples of ``(attrname, RelationshipProperty, related_class)``</span>
<span class="sd">    for all relationships that are marked as a CamCOPS ancillary relationship.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">rel_prop</span><span class="p">,</span> <span class="n">related_class</span> <span class="ow">in</span> <span class="n">gen_relationships</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">rel_prop</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">RelationshipInfo</span><span class="o">.</span><span class="n">IS_ANCILLARY</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">rel_prop</span><span class="p">,</span> <span class="n">related_class</span></div>


<div class="viewcode-block" id="gen_blob_relationships"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.gen_blob_relationships">[docs]</a><span class="k">def</span> <span class="nf">gen_blob_relationships</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span>
        <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">RelationshipProperty</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;GenericTabletRecordMixin&quot;</span><span class="p">]],</span>
        <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yields tuples of ``(attrname, RelationshipProperty, related_class)``</span>
<span class="sd">    for all relationships that are marked as a CamCOPS BLOB relationship.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">rel_prop</span><span class="p">,</span> <span class="n">related_class</span> <span class="ow">in</span> <span class="n">gen_relationships</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">rel_prop</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">RelationshipInfo</span><span class="o">.</span><span class="n">IS_BLOB</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">rel_prop</span><span class="p">,</span> <span class="n">related_class</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Specializations of CamcopsColumn to save typing</span>
<span class="c1"># =============================================================================</span>

<span class="k">def</span> <span class="nf">_name_type_in_column_args</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    SQLAlchemy doesn&#39;t encourage deriving from Column.</span>
<span class="sd">    If you do, you have to implement __init__() and _constructor() carefully.</span>
<span class="sd">    The __init__() function will be called by user code, and via SQLAlchemy</span>
<span class="sd">    internals, including via _constructor (e.g. from Column.make_proxy()).</span>

<span class="sd">    It is likely that __init__ will experience many combinations of the column</span>
<span class="sd">    name and type being passed either in *args or *kwargs. It must pass them</span>
<span class="sd">    on to Column. If you don&#39;t mess with the type, that&#39;s easy; just pass them</span>
<span class="sd">    on unmodified. But if you plan to mess with the type, as we do in</span>
<span class="sd">    BoolColumn below, we must make sure that we don&#39;t pass either of name</span>
<span class="sd">    or type_ in *both* args and kwargs.</span>

<span class="sd">    This function tells you whether name and type_ are present in args,</span>
<span class="sd">    using the same method as Column.__init__().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name_in_args</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">type_in_args</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>  <span class="c1"># make a copy, and make it a list not a tuple</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">util</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">name_in_args</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">coltype</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">coltype</span><span class="p">,</span> <span class="s2">&quot;_sqla_type&quot;</span><span class="p">):</span>
            <span class="n">type_in_args</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">name_in_args</span><span class="p">,</span> <span class="n">type_in_args</span>


<span class="c1"># noinspection PyAbstractClass</span>
<div class="viewcode-block" id="BoolColumn"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.BoolColumn">[docs]</a><span class="k">class</span> <span class="nc">BoolColumn</span><span class="p">(</span><span class="n">CamcopsColumn</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Must pass on all arguments, ultimately to Column, or when using</span>
        <span class="c1"># AbstractConcreteBase, you can get this:</span>
        <span class="c1">#</span>
        <span class="c1"># TypeError: Could not create a copy of this &lt;class &#39;camcops_server.</span>
        <span class="c1"># cc_modules.cc_sqla_coltypes.BoolColumn&#39;&gt; object.  Ensure the class</span>
        <span class="c1"># includes a _constructor() attribute or method which accepts the</span>
        <span class="c1"># standard Column constructor arguments, or references the Column class</span>
        <span class="c1"># itself.</span>
        <span class="c1">#</span>
        <span class="c1"># During internal copying, &quot;type_&quot; can arrive here within kwargs, so</span>
        <span class="c1"># we must make sure that we don&#39;t send it on twice to super().__init().</span>
        <span class="c1"># Also, Column.make_proxy() calls our _constructor() with name and type</span>
        <span class="c1"># in args, so we must handle that, too...</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">type_in_args</span> <span class="o">=</span> <span class="n">_name_type_in_column_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">type_in_args</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;type_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Boolean</span><span class="p">()</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;permitted_value_checker&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_CHECKER</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_constructor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;BoolColumn&quot;</span><span class="p">:</span>
        <span class="c1"># https://bitbucket.org/zzzeek/sqlalchemy/issues/2284/please-make-column-easier-to-subclass  # noqa</span>
        <span class="k">return</span> <span class="n">BoolColumn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Unit testing</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="SqlaColtypesTest"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_sqla_coltypes.html#camcops_server.cc_modules.cc_sqla_coltypes.SqlaColtypesTest">[docs]</a><span class="k">class</span> <span class="nc">SqlaColtypesTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="c1"># don&#39;t inherit from ExtendedTestCase; circular import</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_assert_dt_equal</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">Pendulum</span><span class="p">],</span>
                         <span class="n">b</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">Pendulum</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Accept that one may have been truncated or rounded to milliseconds.</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">coerce_to_pendulum</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">coerce_to_pendulum</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span>
        <span class="k">assert</span> <span class="n">diff</span><span class="o">.</span><span class="n">microseconds</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{!r}</span><span class="s2"> != </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_iso_field</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;test_iso_field&quot;</span><span class="p">)</span>

        <span class="c1"># from pprint import pformat</span>
        <span class="kn">import</span> <span class="nn">pendulum</span>
        <span class="kn">from</span> <span class="nn">sqlalchemy.engine</span> <span class="k">import</span> <span class="n">create_engine</span>
        <span class="kn">from</span> <span class="nn">sqlalchemy.sql.expression</span> <span class="k">import</span> <span class="n">select</span>
        <span class="kn">from</span> <span class="nn">sqlalchemy.sql.schema</span> <span class="k">import</span> <span class="n">MetaData</span><span class="p">,</span> <span class="n">Table</span>

        <span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">SQLITE_MEMORY_URL</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
        <span class="n">meta</span><span class="o">.</span><span class="n">bind</span> <span class="o">=</span> <span class="n">engine</span>  <span class="c1"># adds execute() method to select() etc.</span>
        <span class="c1"># ... http://docs.sqlalchemy.org/en/latest/core/connections.html</span>

        <span class="n">id_colname</span> <span class="o">=</span> <span class="s1">&#39;id&#39;</span>
        <span class="n">dt_local_colname</span> <span class="o">=</span> <span class="s1">&#39;dt_local&#39;</span>
        <span class="n">dt_utc_colname</span> <span class="o">=</span> <span class="s1">&#39;dt_utc&#39;</span>
        <span class="n">iso_colname</span> <span class="o">=</span> <span class="s1">&#39;iso&#39;</span>
        <span class="n">id_col</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">id_colname</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">dt_local_col</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">dt_local_colname</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">)</span>
        <span class="n">dt_utc_col</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">dt_utc_colname</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">)</span>
        <span class="n">iso_col</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">iso_colname</span><span class="p">,</span> <span class="n">PendulumDateTimeAsIsoTextColType</span><span class="p">)</span>

        <span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;testtable&#39;</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span>
                      <span class="n">id_col</span><span class="p">,</span> <span class="n">dt_local_col</span><span class="p">,</span> <span class="n">dt_utc_col</span><span class="p">,</span> <span class="n">iso_col</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>

        <span class="n">now</span> <span class="o">=</span> <span class="n">Pendulum</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">now_utc</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">in_tz</span><span class="p">(</span><span class="n">pendulum</span><span class="o">.</span><span class="n">UTC</span><span class="p">)</span>
        <span class="n">yesterday</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">yesterday_utc</span> <span class="o">=</span> <span class="n">yesterday</span><span class="o">.</span><span class="n">in_tz</span><span class="p">(</span><span class="n">pendulum</span><span class="o">.</span><span class="n">UTC</span><span class="p">)</span>

        <span class="n">table</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">([</span>
            <span class="p">{</span>
                <span class="n">id_colname</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">dt_local_colname</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>
                <span class="n">dt_utc_colname</span><span class="p">:</span> <span class="n">now_utc</span><span class="p">,</span>
                <span class="n">iso_colname</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="n">id_colname</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                <span class="n">dt_local_colname</span><span class="p">:</span> <span class="n">yesterday</span><span class="p">,</span>
                <span class="n">dt_utc_colname</span><span class="p">:</span> <span class="n">yesterday_utc</span><span class="p">,</span>
                <span class="n">iso_colname</span><span class="p">:</span> <span class="n">yesterday</span>
            <span class="p">},</span>
        <span class="p">])</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="n">select_fields</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">id_col</span><span class="p">,</span>
            <span class="n">dt_local_col</span><span class="p">,</span>
            <span class="n">dt_utc_col</span><span class="p">,</span>
            <span class="n">iso_col</span><span class="p">,</span>
            <span class="n">func</span><span class="o">.</span><span class="n">length</span><span class="p">(</span><span class="n">dt_local_col</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;len_dt_local_col&quot;</span><span class="p">),</span>
            <span class="n">func</span><span class="o">.</span><span class="n">length</span><span class="p">(</span><span class="n">dt_utc_col</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;len_dt_utc_col&quot;</span><span class="p">),</span>
            <span class="n">func</span><span class="o">.</span><span class="n">length</span><span class="p">(</span><span class="n">iso_col</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;len_iso_col&quot;</span><span class="p">),</span>
            <span class="n">isotzdatetime_to_utcdatetime</span><span class="p">(</span><span class="n">iso_col</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;iso_to_utcdt&quot;</span><span class="p">),</span>
            <span class="n">unknown_field_to_utcdatetime</span><span class="p">(</span><span class="n">dt_utc_col</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;uk_utcdt_to_utcdt&quot;</span><span class="p">),</span>
            <span class="n">unknown_field_to_utcdatetime</span><span class="p">(</span><span class="n">iso_col</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;uk_iso_to_utc_dt&quot;</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="n">select</span><span class="p">(</span><span class="n">select_fields</span><span class="p">)</span>
            <span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">id_col</span><span class="p">)</span>
            <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="c1"># for row in rows:</span>
        <span class="c1">#     log.critical(&quot;\n{}&quot;, pformat(dict(row)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_dt_equal</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">dt_local_col</span><span class="p">],</span> <span class="n">now</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_dt_equal</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">dt_utc_col</span><span class="p">],</span> <span class="n">now_utc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_dt_equal</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">iso_colname</span><span class="p">],</span> <span class="n">now</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_dt_equal</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;iso_to_utcdt&quot;</span><span class="p">],</span> <span class="n">now_utc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_dt_equal</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;uk_utcdt_to_utcdt&quot;</span><span class="p">],</span> <span class="n">now_utc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_dt_equal</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;uk_iso_to_utc_dt&quot;</span><span class="p">],</span> <span class="n">now_utc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_dt_equal</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">dt_local_col</span><span class="p">],</span> <span class="n">yesterday</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_dt_equal</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">dt_utc_col</span><span class="p">],</span> <span class="n">yesterday_utc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_dt_equal</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">iso_colname</span><span class="p">],</span> <span class="n">yesterday</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_dt_equal</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;iso_to_utcdt&quot;</span><span class="p">],</span> <span class="n">yesterday_utc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_dt_equal</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;uk_utcdt_to_utcdt&quot;</span><span class="p">],</span> <span class="n">yesterday_utc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_dt_equal</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;uk_iso_to_utc_dt&quot;</span><span class="p">],</span> <span class="n">yesterday_utc</span><span class="p">)</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># main</span>
<span class="c1"># =============================================================================</span>
<span class="c1"># run with &quot;python -m camcops_server.cc_modules.cc_sqla_coltypes -v&quot; to be verbose  # noqa</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main_only_quicksetup_rootlogger</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
    <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../../../index.html">Table Of Contents</a></h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/download.html">2. Downloading CamCOPS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../client/client_installation.html">3. Installing and configuring the client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../client/client_using.html">4. Using the client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../server/server_front_end_general.html">5. Web site: general use</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tasks/_tasks_by_category.html">6. Tasks in CamCOPS by category</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tasks/_tasks_all.html">7. All tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../client/client_troubleshooting.html">8. Troubleshooting client problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../server/server_installation.html">9. Installing CamCOPS on the server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../server/server_configuration.html">10. Configuring the server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../server/server_config_file.html">11. The CamCOPS server configuration file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../server/server_front_end_admin.html">12. Web site: admin functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../server/server_command_line.html">13. CamCOPS command-line tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../server/server_troubleshooting.html">14. Troubleshooting server problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../licences/licences.html">15. Licences</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer/index.html">16. Developer notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/tcpip_ports.html">17. Common relevant TCP/IP ports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/linux_flavours.html">18. Linux flavours</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autodoc/_index.html">19. Automatic documentation of core server source code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">20. Change log/history</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq_known_problems.html">21. FAQ and known problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../to_do.html">22. Things to do</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../wishlist.html">23. Wishlist and blue-sky thoughts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/local_info.html">24. Local configuration information</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">CamCOPS 2.2.4 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2012-2018, Rudolf Cardinal.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.5.
    </div>
  </body>
</html>