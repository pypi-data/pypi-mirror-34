
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>camcops_server.camcops &#8212; CamCOPS 2.2.4 documentation</title>
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/camcops_docs.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">CamCOPS 2.2.4 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for camcops_server.camcops</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># camcops_server/camcops.py</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">===============================================================================</span>

<span class="sd">    Copyright (C) 2012-2018 Rudolf Cardinal (rudolf@pobox.com).</span>

<span class="sd">    This file is part of CamCOPS.</span>

<span class="sd">    CamCOPS is free software: you can redistribute it and/or modify</span>
<span class="sd">    it under the terms of the GNU General Public License as published by</span>
<span class="sd">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">    (at your option) any later version.</span>

<span class="sd">    CamCOPS is distributed in the hope that it will be useful,</span>
<span class="sd">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="sd">    GNU General Public License for more details.</span>

<span class="sd">    You should have received a copy of the GNU General Public License</span>
<span class="sd">    along with CamCOPS. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="sd">===============================================================================</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># SET UP LOGGING BEFORE WE IMPORT CAMCOPS MODULES, allowing them to log during</span>
<span class="c1"># imports (see e.g. cc_plot).</span>
<span class="c1"># Currently sets up colour logging even if under WSGI environment. This is fine</span>
<span class="c1"># for gunicorn from the command line; I&#39;m less clear about whether the disk</span>
<span class="c1"># logs look polluted by ANSI codes; needs checking.</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.logs</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">BraceStyleAdapter</span><span class="p">,</span>
    <span class="n">main_only_quicksetup_rootlogger</span><span class="p">,</span>
    <span class="n">print_report_on_all_logs</span><span class="p">,</span>
    <span class="n">set_level_for_logger_and_its_handlers</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">main_only_quicksetup_rootlogger</span><span class="p">(</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="n">with_process_id</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_thread_id</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">BraceStyleAdapter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">))</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;CamCOPS starting&quot;</span><span class="p">)</span>

<span class="c1"># Main imports</span>

<span class="kn">from</span> <span class="nn">argparse</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">ArgumentParser</span><span class="p">,</span>
    <span class="n">ArgumentDefaultsHelpFormatter</span><span class="p">,</span>
    <span class="n">Namespace</span><span class="p">,</span>
    <span class="n">RawDescriptionHelpFormatter</span><span class="p">,</span>
<span class="p">)</span>  <span class="c1"># nopep8</span>
<span class="kn">import</span> <span class="nn">codecs</span>  <span class="c1"># nopep8</span>
<span class="kn">import</span> <span class="nn">os</span>  <span class="c1"># nopep8</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>  <span class="c1"># nopep8</span>
<span class="c1"># from pprint import pformat  # nopep8</span>
<span class="kn">import</span> <span class="nn">sys</span>  <span class="c1"># nopep8</span>
<span class="kn">import</span> <span class="nn">tempfile</span>  <span class="c1"># nopep8</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">TYPE_CHECKING</span>  <span class="c1"># nopep8</span>
<span class="kn">import</span> <span class="nn">unittest</span>  <span class="c1"># nopep8</span>

<span class="kn">import</span> <span class="nn">cherrypy</span>  <span class="c1"># nopep8</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">gunicorn.app.base</span> <span class="k">import</span> <span class="n">BaseApplication</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">BaseApplication</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># e.g. on Windows: &quot;ImportError: no module named &#39;fcntl&#39;&quot;.  # noqa</span>
<span class="kn">from</span> <span class="nn">pyramid.router</span> <span class="k">import</span> <span class="n">Router</span>  <span class="c1"># nopep8</span>
<span class="kn">from</span> <span class="nn">wsgiref.simple_server</span> <span class="k">import</span> <span class="n">make_server</span>  <span class="c1"># nopep8</span>

<span class="kn">from</span> <span class="nn">cardinal_pythonlib.argparse_func</span> <span class="k">import</span> <span class="n">ShowAllSubparserHelpAction</span>  <span class="c1"># nopep8</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.classes</span> <span class="k">import</span> <span class="n">gen_all_subclasses</span>  <span class="c1"># nopep8</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.debugging</span> <span class="k">import</span> <span class="n">pdb_run</span>  <span class="c1"># nopep8</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.process</span> <span class="k">import</span> <span class="n">launch_external_file</span>  <span class="c1"># nopep8</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.ui</span> <span class="k">import</span> <span class="n">ask_user</span><span class="p">,</span> <span class="n">ask_user_password</span>  <span class="c1"># nopep8</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.sqlalchemy.dialect</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">ALL_SQLA_DIALECTS</span><span class="p">,</span>
    <span class="n">SqlaDialectName</span><span class="p">,</span>
<span class="p">)</span>  <span class="c1"># nopep8</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.wsgi.constants</span> <span class="k">import</span> <span class="n">WsgiEnvVar</span>  <span class="c1"># nopep8</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.wsgi.reverse_proxied_mw</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">ReverseProxiedConfig</span><span class="p">,</span>
    <span class="n">ReverseProxiedMiddleware</span><span class="p">,</span>
<span class="p">)</span>  <span class="c1"># nopep8</span>

<span class="c1"># Import this one early:</span>
<span class="c1"># noinspection PyUnresolvedReferences</span>
<span class="kn">import</span> <span class="nn">camcops_server.cc_modules.cc_all_models</span>  <span class="c1"># import side effects (ensure all models registered)  # noqa</span>

<span class="kn">from</span> <span class="nn">camcops_server.cc_modules.cc_alembic</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">create_database_from_scratch</span><span class="p">,</span>
    <span class="n">upgrade_database_to_head</span><span class="p">,</span>
<span class="p">)</span>  <span class="c1"># nopep8</span>
<span class="kn">from</span> <span class="nn">camcops_server.cc_modules.cc_baseconstants</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">ENVVAR_CONFIG_FILE</span><span class="p">,</span>
    <span class="n">DOCUMENTATION_INDEX_FILENAME</span><span class="p">,</span>
<span class="p">)</span>  <span class="c1"># nopep8</span>
<span class="c1"># noinspection PyUnresolvedReferences</span>
<span class="kn">import</span> <span class="nn">camcops_server.cc_modules.client_api</span>  <span class="c1"># import side effects (register unit test)  # nopep8</span>
<span class="kn">from</span> <span class="nn">camcops_server.cc_modules.cc_config</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">get_default_config_from_os_env</span><span class="p">,</span>  <span class="c1"># nopep8</span>
    <span class="n">get_demo_apache_config</span><span class="p">,</span>
    <span class="n">get_demo_config</span><span class="p">,</span>
    <span class="n">get_demo_mysql_create_db</span><span class="p">,</span>
    <span class="n">get_demo_mysql_dump_script</span><span class="p">,</span>
    <span class="n">get_demo_supervisor_config</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">camcops_server.cc_modules.cc_constants</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">CAMCOPS_URL</span><span class="p">,</span>
    <span class="n">MINIMUM_PASSWORD_LENGTH</span><span class="p">,</span>
    <span class="n">USER_NAME_FOR_SYSTEM</span><span class="p">,</span>
<span class="p">)</span>  <span class="c1"># nopep8</span>
<span class="kn">from</span> <span class="nn">camcops_server.cc_modules.cc_hl7</span> <span class="k">import</span> <span class="n">send_all_pending_hl7_messages</span>  <span class="c1"># nopep8</span>
<span class="kn">from</span> <span class="nn">camcops_server.cc_modules.cc_pyramid</span> <span class="k">import</span> <span class="n">RouteCollection</span>  <span class="c1"># nopep8</span>
<span class="kn">from</span> <span class="nn">camcops_server.cc_modules.cc_request</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">CamcopsRequest</span><span class="p">,</span>
    <span class="n">command_line_request_context</span><span class="p">,</span>
    <span class="n">pyramid_configurator_context</span><span class="p">,</span>
<span class="p">)</span>  <span class="c1"># nopep8</span>
<span class="kn">from</span> <span class="nn">camcops_server.cc_modules.cc_sqlalchemy</span> <span class="k">import</span> <span class="n">get_all_ddl</span>  <span class="c1"># nopep8</span>
<span class="kn">from</span> <span class="nn">camcops_server.cc_modules.cc_task</span> <span class="k">import</span> <span class="n">Task</span>  <span class="c1"># nopep8</span>
<span class="kn">from</span> <span class="nn">camcops_server.cc_modules.cc_unittest</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">DemoDatabaseTestCase</span><span class="p">,</span>
    <span class="n">DemoRequestTestCase</span><span class="p">,</span>
    <span class="n">ExtendedTestCase</span><span class="p">,</span>
<span class="p">)</span>  <span class="c1"># nopep8</span>
<span class="kn">from</span> <span class="nn">camcops_server.cc_modules.cc_user</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">SecurityLoginFailure</span><span class="p">,</span>
    <span class="n">set_password_directly</span><span class="p">,</span>
    <span class="n">User</span><span class="p">,</span>
<span class="p">)</span>  <span class="c1"># nopep8</span>
<span class="kn">from</span> <span class="nn">camcops_server.cc_modules.cc_version</span> <span class="k">import</span> <span class="n">CAMCOPS_SERVER_VERSION</span>  <span class="c1"># nopep8</span>
<span class="kn">from</span> <span class="nn">camcops_server.cc_modules.merge_db</span> <span class="k">import</span> <span class="n">merge_camcops_db</span>  <span class="c1"># nopep8</span>

<span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;All imports complete&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="c1"># noinspection PyProtectedMember</span>
    <span class="kn">from</span> <span class="nn">argparse</span> <span class="k">import</span> <span class="n">_SubParsersAction</span>

<span class="c1"># =============================================================================</span>
<span class="c1"># Check Python version (the shebang is not a guarantee)</span>
<span class="c1"># =============================================================================</span>

<span class="c1"># if sys.version_info[0] != 2 or sys.version_info[1] != 7:</span>
<span class="c1">#     # ... sys.version_info.major (etc.) require Python 2.7 in any case!</span>
<span class="c1">#     raise RuntimeError(</span>
<span class="c1">#         &quot;CamCOPS needs Python 2.7, and this Python version is: &quot;</span>
<span class="c1">#         + sys.version)</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
        <span class="s2">&quot;CamCOPS needs Python 3, and this Python version is: &quot;</span> <span class="o">+</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>

<span class="c1"># =============================================================================</span>
<span class="c1"># Debugging options</span>
<span class="c1"># =============================================================================</span>

<span class="n">DEBUG_LOG_CONFIG</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">DEBUG_RUN_WITH_PDB</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">if</span> <span class="n">DEBUG_LOG_CONFIG</span> <span class="ow">or</span> <span class="n">DEBUG_RUN_WITH_PDB</span><span class="p">:</span>
    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Debugging options enabled!&quot;</span><span class="p">)</span>

<span class="c1"># =============================================================================</span>
<span class="c1"># Other constants</span>
<span class="c1"># =============================================================================</span>

<span class="n">DEFAULT_CONFIG_FILENAME</span> <span class="o">=</span> <span class="s2">&quot;/etc/camcops/camcops.conf&quot;</span>
<span class="n">DEFAULT_HOST</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
<span class="n">DEFAULT_MAX_THREADS</span> <span class="o">=</span> <span class="mi">100</span>
<span class="c1"># ... beware the default MySQL connection limit of 151;</span>
<span class="c1">#     https://dev.mysql.com/doc/refman/5.7/en/too-many-connections.html</span>
<span class="n">DEFAULT_PORT</span> <span class="o">=</span> <span class="mi">8000</span>
<span class="n">URL_PATH_ROOT</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># WSGI entry point</span>
<span class="c1"># =============================================================================</span>

<span class="k">def</span> <span class="nf">ensure_database_is_ok</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">get_default_config_from_os_env</span><span class="p">()</span>
    <span class="n">config</span><span class="o">.</span><span class="n">assert_database_ok</span><span class="p">()</span>


<div class="viewcode-block" id="make_wsgi_app"><a class="viewcode-back" href="../../autodoc/camcops.html#camcops_server.camcops.make_wsgi_app">[docs]</a><span class="k">def</span> <span class="nf">make_wsgi_app</span><span class="p">(</span><span class="n">debug_toolbar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                  <span class="n">reverse_proxied_config</span><span class="p">:</span> <span class="n">ReverseProxiedConfig</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">debug_reverse_proxy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Router</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Makes and returns a WSGI application, attaching all our special methods.</span>

<span class="sd">    QUESTION: how do we access the WSGI environment (passed to the WSGI app)</span>
<span class="sd">    from within a Pyramid request?</span>
<span class="sd">    ANSWER:</span>

<span class="sd">    .. code-block:: none</span>

<span class="sd">        Configurator.make_wsgi_app() calls Router.__init__()</span>
<span class="sd">        and returns: app = Router(...)</span>
<span class="sd">        The WSGI framework uses: response = app(environ, start_response)</span>
<span class="sd">        which therefore calls: Router.__call__(environ, start_response)</span>
<span class="sd">        which does:</span>
<span class="sd">              response = self.execution_policy(environ, self)</span>
<span class="sd">              return response(environ, start_response)</span>
<span class="sd">        So something LIKE this will be called:</span>
<span class="sd">              Router.default_execution_policy(environ, router)</span>
<span class="sd">                  with router.request_context(environ) as request:</span>
<span class="sd">                      # ...</span>
<span class="sd">        So the environ is handled by Router.request_context(environ)</span>
<span class="sd">        which will call BaseRequest.__init__()</span>
<span class="sd">        which does:</span>
<span class="sd">              d = self.__dict__</span>
<span class="sd">              d[&#39;environ&#39;] = environ</span>
<span class="sd">        so we should be able to use</span>
<span class="sd">              request.environ  # type: Dict[str, str]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Creating WSGI app&quot;</span><span class="p">)</span>

    <span class="c1"># Make app</span>
    <span class="k">with</span> <span class="n">pyramid_configurator_context</span><span class="p">(</span><span class="n">debug_toolbar</span><span class="o">=</span><span class="n">debug_toolbar</span><span class="p">)</span> <span class="k">as</span> <span class="n">config</span><span class="p">:</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">make_wsgi_app</span><span class="p">()</span>

    <span class="c1"># Middleware above the Pyramid level</span>
    <span class="k">if</span> <span class="n">reverse_proxied_config</span> <span class="ow">and</span> <span class="n">reverse_proxied_config</span><span class="o">.</span><span class="n">necessary</span><span class="p">():</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">ReverseProxiedMiddleware</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span>
                                       <span class="n">config</span><span class="o">=</span><span class="n">reverse_proxied_config</span><span class="p">,</span>
                                       <span class="n">debug</span><span class="o">=</span><span class="n">debug_reverse_proxy</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;WSGI app created&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">app</span></div>


<span class="k">def</span> <span class="nf">make_wsgi_app_from_argparse_args</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Namespace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Router</span><span class="p">:</span>
    <span class="c1"># ... matches add_wsgi_options()</span>
    <span class="n">reverse_proxied_config</span> <span class="o">=</span> <span class="n">ReverseProxiedConfig</span><span class="p">(</span>
        <span class="n">trusted_proxy_headers</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">trusted_proxy_headers</span><span class="p">,</span>
        <span class="n">http_host</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">proxy_http_host</span><span class="p">,</span>
        <span class="n">remote_addr</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">proxy_remote_addr</span><span class="p">,</span>
        <span class="n">script_name</span><span class="o">=</span><span class="p">(</span>
            <span class="n">args</span><span class="o">.</span><span class="n">proxy_script_name</span> <span class="ow">or</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">WsgiEnvVar</span><span class="o">.</span><span class="n">SCRIPT_NAME</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="n">server_port</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">proxy_server_port</span><span class="p">,</span>
        <span class="n">server_name</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">proxy_server_name</span><span class="p">,</span>
        <span class="n">url_scheme</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">proxy_url_scheme</span><span class="p">,</span>
        <span class="n">rewrite_path_info</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">proxy_rewrite_path_info</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">make_wsgi_app</span><span class="p">(</span><span class="n">debug_toolbar</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">debug_toolbar</span><span class="p">,</span>
                         <span class="n">reverse_proxied_config</span><span class="o">=</span><span class="n">reverse_proxied_config</span><span class="p">,</span>
                         <span class="n">debug_reverse_proxy</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">debug_reverse_proxy</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_serve_pyramid</span><span class="p">(</span><span class="n">application</span><span class="p">:</span> <span class="n">Router</span><span class="p">,</span>
                       <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">DEFAULT_HOST</span><span class="p">,</span>
                       <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_PORT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">ensure_database_is_ok</span><span class="p">()</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">make_server</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">application</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Serving on host=</span><span class="si">{}</span><span class="s2">, port=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
    <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">join_url_fragments</span><span class="p">(</span><span class="o">*</span><span class="n">fragments</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="c1"># urllib.parse.urljoin doesn&#39;t do what we want</span>
    <span class="n">newfrags</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fragments</span><span class="p">]</span>
    <span class="k">return</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">newfrags</span><span class="p">)</span>


<div class="viewcode-block" id="serve_cherrypy"><a class="viewcode-back" href="../../autodoc/camcops.html#camcops_server.camcops.serve_cherrypy">[docs]</a><span class="k">def</span> <span class="nf">serve_cherrypy</span><span class="p">(</span><span class="n">application</span><span class="p">:</span> <span class="n">Router</span><span class="p">,</span>
                   <span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                   <span class="n">port</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                   <span class="n">unix_domain_socket_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                   <span class="n">threads_start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                   <span class="n">threads_max</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>  <span class="c1"># -1 for no limit</span>
                   <span class="n">server_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                   <span class="n">log_screen</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                   <span class="n">ssl_certificate</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                   <span class="n">ssl_private_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                   <span class="n">root_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start CherryPy server</span>
<span class="sd">    - Multithreading.</span>
<span class="sd">    - Any platform.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ensure_database_is_ok</span><span class="p">()</span>

    <span class="c1"># Report on options</span>
    <span class="k">if</span> <span class="n">unix_domain_socket_filename</span><span class="p">:</span>
        <span class="c1"># If this is specified, it takes priority</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting CherryPy server via UNIX domain socket at: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span>
                 <span class="n">unix_domain_socket_filename</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting CherryPy server on host </span><span class="si">{}</span><span class="s2">, port </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Within this web server instance, CamCOPS will be at: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span>
             <span class="n">root_path</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;... webview at: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="c1"># urllib.parse.urljoin is useless for this</span>
        <span class="n">join_url_fragments</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="n">RouteCollection</span><span class="o">.</span><span class="n">HOME</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;... tablet client API at: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">join_url_fragments</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="n">RouteCollection</span><span class="o">.</span><span class="n">CLIENT_API</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Thread pool starting size: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">threads_start</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Thread pool max size: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">threads_max</span><span class="p">)</span>

    <span class="c1"># Set up CherryPy</span>
    <span class="n">cherrypy</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="c1"># See http://svn.cherrypy.org/trunk/cherrypy/_cpserver.py</span>
        <span class="s1">&#39;server.socket_host&#39;</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span>
        <span class="s1">&#39;server.socket_port&#39;</span><span class="p">:</span> <span class="n">port</span><span class="p">,</span>
        <span class="s1">&#39;server.socket_file&#39;</span><span class="p">:</span> <span class="n">unix_domain_socket_filename</span><span class="p">,</span>
        <span class="s1">&#39;server.thread_pool&#39;</span><span class="p">:</span> <span class="n">threads_start</span><span class="p">,</span>
        <span class="s1">&#39;server.thread_pool_max&#39;</span><span class="p">:</span> <span class="n">threads_max</span><span class="p">,</span>
        <span class="s1">&#39;server.server_name&#39;</span><span class="p">:</span> <span class="n">server_name</span><span class="p">,</span>
        <span class="s1">&#39;server.log_screen&#39;</span><span class="p">:</span> <span class="n">log_screen</span><span class="p">,</span>
    <span class="p">})</span>
    <span class="k">if</span> <span class="n">ssl_certificate</span> <span class="ow">and</span> <span class="n">ssl_private_key</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;server.ssl_module&#39;</span><span class="p">:</span> <span class="s1">&#39;builtin&#39;</span><span class="p">,</span>
            <span class="s1">&#39;server.ssl_certificate&#39;</span><span class="p">:</span> <span class="n">ssl_certificate</span><span class="p">,</span>
            <span class="s1">&#39;server.ssl_private_key&#39;</span><span class="p">:</span> <span class="n">ssl_private_key</span><span class="p">,</span>
        <span class="p">})</span>

    <span class="c1"># Mount WSGI application</span>
    <span class="n">cherrypy</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">graft</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="n">root_path</span><span class="p">)</span>

    <span class="c1"># Start server</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># log.debug(&quot;cherrypy.server.thread_pool: {}&quot;,</span>
        <span class="c1">#           cherrypy.server.thread_pool)</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">block</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div>


<div class="viewcode-block" id="serve_gunicorn"><a class="viewcode-back" href="../../autodoc/camcops.html#camcops_server.camcops.serve_gunicorn">[docs]</a><span class="k">def</span> <span class="nf">serve_gunicorn</span><span class="p">(</span><span class="n">application</span><span class="p">:</span> <span class="n">Router</span><span class="p">,</span>
                   <span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                   <span class="n">port</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                   <span class="n">unix_domain_socket_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                   <span class="n">num_workers</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                   <span class="n">ssl_certificate</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                   <span class="n">ssl_private_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                   <span class="n">reload</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                   <span class="n">timeout_s</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
                   <span class="n">debug_show_gunicorn_options</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start Gunicorn server</span>

<span class="sd">    - Multiprocessing; this is a Good Thing particularly in Python; see e.g.</span>
<span class="sd">      https://eli.thegreenplace.net/2012/01/16/python-parallelizing-cpu-bound-tasks-with-multiprocessing/  # noqa</span>
<span class="sd">      http://www.dabeaz.com/python/UnderstandingGIL.pdf</span>

<span class="sd">    - UNIX only.</span>

<span class="sd">    - The Pyramid debug toolbar detects a multiprocessing web server and says</span>
<span class="sd">      &quot;shan&#39;t, because I use global state&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">BaseApplication</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Gunicorn does not run under Windows. &quot;</span>
                           <span class="s2">&quot;(It relies on the UNIX fork() facility.)&quot;</span><span class="p">)</span>

    <span class="n">ensure_database_is_ok</span><span class="p">()</span>

    <span class="c1"># Report on options, and calculate Gunicorn versions</span>
    <span class="k">if</span> <span class="n">unix_domain_socket_filename</span><span class="p">:</span>
        <span class="c1"># If this is specified, it takes priority</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting Gunicorn server via UNIX domain socket at: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span>
                 <span class="n">unix_domain_socket_filename</span><span class="p">)</span>
        <span class="n">bind</span> <span class="o">=</span> <span class="s2">&quot;unix:&quot;</span> <span class="o">+</span> <span class="n">unix_domain_socket_filename</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting Gunicorn server on host </span><span class="si">{}</span><span class="s2">, port </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
        <span class="n">bind</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;... using </span><span class="si">{}</span><span class="s2"> workers&quot;</span><span class="p">,</span> <span class="n">num_workers</span><span class="p">)</span>

    <span class="c1"># We encapsulate this class definition in the function, since it inherits</span>
    <span class="c1"># from a class whose import will crash under Windows.</span>

    <span class="c1"># http://docs.gunicorn.org/en/stable/custom.html</span>

    <span class="k">class</span> <span class="nc">StandaloneApplication</span><span class="p">(</span><span class="n">BaseApplication</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                     <span class="n">app_</span><span class="p">:</span> <span class="n">Router</span><span class="p">,</span>
                     <span class="n">options</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">debug_show_known_settings</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span> <span class="ow">or</span> <span class="p">{}</span>  <span class="c1"># type: Dict[str, Any]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">application</span> <span class="o">=</span> <span class="n">app_</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">debug_show_known_settings</span><span class="p">:</span>
                <span class="c1"># log.info(&quot;Gunicorn settings:\n{}&quot;, pformat(self.cfg.settings))</span>
                <span class="c1"># ... which basically tells us to look in gunicorn/config.py</span>
                <span class="c1"># at every class that inherits from Setting.</span>
                <span class="c1"># Each has helpful documentation, as follows:</span>
                <span class="n">possible_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">possible_keys</span><span class="p">:</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">desc</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">load_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c1"># The Gunicorn example looks somewhat convoluted! Let&#39;s be simpler:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">key_lower</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">key_lower</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">settings</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">key_lower</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span>

    <span class="n">opts</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;bind&#39;</span><span class="p">:</span> <span class="n">bind</span><span class="p">,</span>
        <span class="s1">&#39;certfile&#39;</span><span class="p">:</span> <span class="n">ssl_certificate</span><span class="p">,</span>
        <span class="s1">&#39;keyfile&#39;</span><span class="p">:</span> <span class="n">ssl_private_key</span><span class="p">,</span>
        <span class="s1">&#39;reload&#39;</span><span class="p">:</span> <span class="n">reload</span><span class="p">,</span>
        <span class="s1">&#39;timeout&#39;</span><span class="p">:</span> <span class="n">timeout_s</span><span class="p">,</span>
        <span class="s1">&#39;workers&#39;</span><span class="p">:</span> <span class="n">num_workers</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">StandaloneApplication</span><span class="p">(</span>
        <span class="n">application</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span>
        <span class="n">debug_show_known_settings</span><span class="o">=</span><span class="n">debug_show_gunicorn_options</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Command-line functions</span>
<span class="c1"># =============================================================================</span>

<span class="k">def</span> <span class="nf">launch_manual</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">launch_external_file</span><span class="p">(</span><span class="n">DOCUMENTATION_INDEX_FILENAME</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">print_demo_camcops_config</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">get_demo_config</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">print_demo_supervisor_config</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">get_demo_supervisor_config</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">print_demo_apache_config</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">get_demo_apache_config</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">print_demo_mysql_create_db</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">get_demo_mysql_create_db</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">print_demo_mysql_dump_script</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">get_demo_mysql_dump_script</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">print_database_title</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">command_line_request_context</span><span class="p">()</span> <span class="k">as</span> <span class="n">req</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">database_title</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">generate_anonymisation_staging_db</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># generate_anonymisation_staging_db: *** BROKEN; REPLACE</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">pls</span><span class="o">.</span><span class="n">get_anonymisation_database</span><span class="p">()</span>  <span class="c1"># may raise</span>
    <span class="n">ddfilename</span> <span class="o">=</span> <span class="n">pls</span><span class="o">.</span><span class="n">EXPORT_CRIS_DATA_DICTIONARY_TSV_FILE</span>
    <span class="n">classes</span> <span class="o">=</span> <span class="n">get_all_task_classes</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ddfilename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">written_header</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">is_anonymous</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># Drop, make and populate tables</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">make_cris_tables</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
            <span class="c1"># Add info to data dictionary</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_cris_dd_rows</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">written_header</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">get_tsv_header_from_dict</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">written_header</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">get_tsv_line_from_dict</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Draft data dictionary written to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ddfilename</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">get_username_from_cli</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                          <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                          <span class="n">starting_username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                          <span class="n">must_exist</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                          <span class="n">must_not_exist</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="n">must_exist</span> <span class="ow">and</span> <span class="n">must_not_exist</span><span class="p">)</span>
    <span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
            <span class="n">username</span> <span class="o">=</span> <span class="n">starting_username</span>
            <span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">username</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">username</span> <span class="ow">or</span> <span class="n">ask_user</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
        <span class="n">exists</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">user_exists</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">must_not_exist</span> <span class="ow">and</span> <span class="n">exists</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;... user already exists!&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">must_exist</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;... no such user!&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">username</span> <span class="o">==</span> <span class="n">USER_NAME_FOR_SYSTEM</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;... username </span><span class="si">{!r}</span><span class="s2"> is reserved&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">USER_NAME_FOR_SYSTEM</span><span class="p">))</span>
            <span class="k">continue</span>
        <span class="k">return</span> <span class="n">username</span>


<span class="k">def</span> <span class="nf">get_new_password_from_cli</span><span class="p">(</span><span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">password1</span> <span class="o">=</span> <span class="n">ask_user_password</span><span class="p">(</span><span class="s2">&quot;New password for user &quot;</span>
                                      <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">password1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">password1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">MINIMUM_PASSWORD_LENGTH</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;... passwords can&#39;t be blank or shorter than </span><span class="si">{}</span><span class="s2"> &quot;</span>
                      <span class="s2">&quot;characters&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">MINIMUM_PASSWORD_LENGTH</span><span class="p">))</span>
            <span class="k">continue</span>
        <span class="n">password2</span> <span class="o">=</span> <span class="n">ask_user_password</span><span class="p">(</span><span class="s2">&quot;New password for user </span><span class="si">{}</span><span class="s2"> &quot;</span>
                                      <span class="s2">&quot;(again)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">password1</span> <span class="o">!=</span> <span class="n">password2</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;... passwords don&#39;t match; try again&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">return</span> <span class="n">password1</span>


<div class="viewcode-block" id="make_superuser"><a class="viewcode-back" href="../../autodoc/camcops.html#camcops_server.camcops.make_superuser">[docs]</a><span class="k">def</span> <span class="nf">make_superuser</span><span class="p">(</span><span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make a superuser from the command line.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">command_line_request_context</span><span class="p">()</span> <span class="k">as</span> <span class="n">req</span><span class="p">:</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">get_username_from_cli</span><span class="p">(</span>
            <span class="n">req</span><span class="o">=</span><span class="n">req</span><span class="p">,</span>
            <span class="n">prompt</span><span class="o">=</span><span class="s2">&quot;Username for new superuser (or to gain superuser status)&quot;</span><span class="p">,</span>
            <span class="n">starting_username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">existing_user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">get_user_by_name</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">existing_user</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Giving superuser status to </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="p">))</span>
            <span class="n">existing_user</span><span class="o">.</span><span class="n">superuser</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating superuser </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="p">))</span>
            <span class="n">password</span> <span class="o">=</span> <span class="n">get_new_password_from_cli</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
            <span class="n">success</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">create_superuser</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Success&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Failed to create superuser&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="reset_password"><a class="viewcode-back" href="../../autodoc/camcops.html#camcops_server.camcops.reset_password">[docs]</a><span class="k">def</span> <span class="nf">reset_password</span><span class="p">(</span><span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reset a password from the command line.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">command_line_request_context</span><span class="p">()</span> <span class="k">as</span> <span class="n">req</span><span class="p">:</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">get_username_from_cli</span><span class="p">(</span>
            <span class="n">req</span><span class="o">=</span><span class="n">req</span><span class="p">,</span>
            <span class="n">prompt</span><span class="o">=</span><span class="s2">&quot;Username to reset password for&quot;</span><span class="p">,</span>
            <span class="n">starting_username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
            <span class="n">must_exist</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Resetting password for user </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="p">))</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">get_new_password_from_cli</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
        <span class="n">success</span> <span class="o">=</span> <span class="n">set_password_directly</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Success&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Failure&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">success</span></div>


<div class="viewcode-block" id="enable_user_cli"><a class="viewcode-back" href="../../autodoc/camcops.html#camcops_server.camcops.enable_user_cli">[docs]</a><span class="k">def</span> <span class="nf">enable_user_cli</span><span class="p">(</span><span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Re-enable a locked user account from the command line.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">command_line_request_context</span><span class="p">()</span> <span class="k">as</span> <span class="n">req</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">username</span> <span class="o">=</span> <span class="n">get_username_from_cli</span><span class="p">(</span>
                <span class="n">req</span><span class="o">=</span><span class="n">req</span><span class="p">,</span>
                <span class="n">prompt</span><span class="o">=</span><span class="s2">&quot;Username to unlock&quot;</span><span class="p">,</span>
                <span class="n">must_exist</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">User</span><span class="o">.</span><span class="n">user_exists</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;No such user: </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="n">SecurityLoginFailure</span><span class="o">.</span><span class="n">enable_user</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Enabled.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<span class="k">def</span> <span class="nf">send_hl7</span><span class="p">(</span><span class="n">show_queue_only</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">command_line_request_context</span><span class="p">()</span> <span class="k">as</span> <span class="n">req</span><span class="p">:</span>
        <span class="n">send_all_pending_hl7_messages</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                                      <span class="n">show_queue_only</span><span class="o">=</span><span class="n">show_queue_only</span><span class="p">)</span>


<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># Test rig</span>
<span class="c1"># -----------------------------------------------------------------------------</span>

<div class="viewcode-block" id="self_test"><a class="viewcode-back" href="../../autodoc/camcops.html#camcops_server.camcops.self_test">[docs]</a><span class="k">def</span> <span class="nf">self_test</span><span class="p">(</span><span class="n">show_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run all unit tests.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdirname</span><span class="p">:</span>
        <span class="n">tmpconfigfilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdirname</span><span class="p">,</span> <span class="s2">&quot;dummy_config.conf&quot;</span><span class="p">)</span>
        <span class="n">configtext</span> <span class="o">=</span> <span class="n">get_demo_config</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmpconfigfilename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">configtext</span><span class="p">)</span>
        <span class="c1"># First, for safety:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">ENVVAR_CONFIG_FILE</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmpconfigfilename</span>
        <span class="c1"># ... we&#39;re going to be using a test (SQLite) database, but we want to</span>
        <span class="c1"># be very sure that nothing writes to a real database! Also, we will</span>
        <span class="c1"># want to read from this dummy config at some point.</span>

        <span class="c1"># If you use this:</span>
        <span class="c1">#       loader = TestLoader()</span>
        <span class="c1">#       suite = loader.discover(CAMCOPS_SERVER_DIRECTORY)</span>
        <span class="c1"># ... then it fails because submodules contain relative imports (e.g.</span>
        <span class="c1"># &quot;from ..cc_modules.something import x&quot; and this gives &quot;ValueError:</span>
        <span class="c1"># attemped relative import beyond top-level package&quot;. As the unittest</span>
        <span class="c1"># docs say, &quot;In order to be compatible with test discovery, all of the</span>
        <span class="c1"># test files must be modules or packages... importable from the</span>
        <span class="c1"># top-level directory of the project&quot;.</span>
        <span class="c1">#</span>
        <span class="c1"># However, having imported everything, all our tests should be</span>
        <span class="c1"># subclasses of TestCase... but so are some other things.</span>
        <span class="c1">#</span>
        <span class="c1"># So we have a choice:</span>
        <span class="c1"># 1. manual test specification (yuk)</span>
        <span class="c1"># 2. hack around TestCase.__subclasses__ to exclude &quot;built-in&quot; ones</span>
        <span class="c1"># 3. abandon relative imports</span>
        <span class="c1">#   ... not a bad general idea (they often seem to cause problems!)</span>
        <span class="c1">#   ... however, the discovery process (a) fails with importing</span>
        <span class="c1">#       &quot;alembic.versions&quot;, but more problematically, imports tasks</span>
        <span class="c1">#       twice, which gives errors like</span>
        <span class="c1">#       &quot;sqlalchemy.exc.InvalidRequestError: Table &#39;ace3&#39; is already</span>
        <span class="c1">#       defined for this MetaData instance.&quot;</span>
        <span class="c1"># So, hack it is.</span>

        <span class="c1"># noinspection PyProtectedMember</span>
        <span class="n">skip_testclass_subclasses</span> <span class="o">=</span> <span class="p">[</span>
            <span class="c1"># The ugly hack: what you see from</span>
            <span class="c1"># unittest.TestCase.__subclasses__() from a clean import:</span>
            <span class="n">unittest</span><span class="o">.</span><span class="n">case</span><span class="o">.</span><span class="n">FunctionTestCase</span><span class="p">,</span>  <span class="c1"># built in</span>
            <span class="n">unittest</span><span class="o">.</span><span class="n">case</span><span class="o">.</span><span class="n">_SubTest</span><span class="p">,</span>  <span class="c1"># built in</span>
            <span class="n">unittest</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">_FailedTest</span><span class="p">,</span>  <span class="c1"># built in</span>
            <span class="c1"># plus our extras:</span>
            <span class="n">DemoDatabaseTestCase</span><span class="p">,</span>  <span class="c1"># our base class</span>
            <span class="n">DemoRequestTestCase</span><span class="p">,</span>  <span class="c1"># also a base class</span>
            <span class="n">ExtendedTestCase</span><span class="p">,</span>  <span class="c1"># also a base class</span>
        <span class="p">]</span>
        <span class="n">suite</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestSuite</span><span class="p">()</span>
        <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">gen_all_subclasses</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
            <span class="c1"># log.critical(&quot;Considering: {}&quot;, cls)</span>
            <span class="k">if</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">skip_testclass_subclasses</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__module__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;camcops_server&quot;</span><span class="p">):</span>
                <span class="c1"># don&#39;t, for example, run cardinal_pythonlib self-tests</span>
                <span class="k">continue</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Discovered test: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
            <span class="n">suite</span><span class="o">.</span><span class="n">addTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">makeSuite</span><span class="p">(</span><span class="bp">cls</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">show_only</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">runner</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TextTestRunner</span><span class="p">()</span>
        <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">suite</span><span class="p">)</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Command-line processor</span>
<span class="c1"># =============================================================================</span>

<span class="n">_REQNAMED</span> <span class="o">=</span> <span class="s1">&#39;required named arguments&#39;</span>


<span class="c1"># noinspection PyShadowingBuiltins</span>
<div class="viewcode-block" id="add_sub"><a class="viewcode-back" href="../../autodoc/camcops.html#camcops_server.camcops.add_sub">[docs]</a><span class="k">def</span> <span class="nf">add_sub</span><span class="p">(</span><span class="n">sp</span><span class="p">:</span> <span class="s2">&quot;_SubParsersAction&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">config_mandatory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">help</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ArgumentParser</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    help:</span>
<span class="sd">        Used for the main help summary, i.e. &quot;camcops --help&quot;.</span>
<span class="sd">    description:</span>
<span class="sd">        Used for the description in the detailed help, e.g.</span>
<span class="sd">        &quot;camcops docs --help&quot;. Defaults to &quot;help&quot;.</span>
<span class="sd">    config_mandatory:</span>
<span class="sd">        None = don&#39;t ask for config</span>
<span class="sd">        False = ask for it, but not mandatory</span>
<span class="sd">        True = mandatory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">description</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">help</span>
    <span class="n">subparser</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
        <span class="n">cmd</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">help</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
        <span class="n">formatter_class</span><span class="o">=</span><span class="n">ArgumentDefaultsHelpFormatter</span>
    <span class="p">)</span>  <span class="c1"># type: ArgumentParser</span>
    <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;--verbose&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Be verbose&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config_mandatory</span><span class="p">:</span>
        <span class="n">cfg_help</span> <span class="o">=</span> <span class="s2">&quot;Configuration file&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cfg_help</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Configuration file (if not specified, the environment&quot;</span>
                    <span class="s2">&quot; variable </span><span class="si">{}</span><span class="s2"> is checked)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ENVVAR_CONFIG_FILE</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">config_mandatory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">config_mandatory</span><span class="p">:</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="n">_REQNAMED</span><span class="p">)</span>
        <span class="c1"># https://stackoverflow.com/questions/24180527/argparse-required-arguments-listed-under-optional-arguments  # noqa</span>
        <span class="n">g</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--config&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">cfg_help</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">subparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--config&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">cfg_help</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">subparser</span></div>


<span class="c1"># noinspection PyShadowingBuiltins</span>
<span class="k">def</span> <span class="nf">add_req_named</span><span class="p">(</span><span class="n">sp</span><span class="p">:</span> <span class="n">ArgumentParser</span><span class="p">,</span> <span class="n">switch</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">action</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># noinspection PyProtectedMember</span>
    <span class="n">reqgroup</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">sp</span><span class="o">.</span><span class="n">_action_groups</span>
                     <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">title</span> <span class="o">==</span> <span class="n">_REQNAMED</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">reqgroup</span><span class="p">:</span>
        <span class="n">reqgroup</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="n">_REQNAMED</span><span class="p">)</span>
    <span class="n">reqgroup</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="n">switch</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">help</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">add_wsgi_options</span><span class="p">(</span><span class="n">sp</span><span class="p">:</span> <span class="n">ArgumentParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">sp</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--trusted_proxy_headers&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Trust these WSGI environment variables for when the server &quot;</span>
            <span class="s2">&quot;is behind a reverse proxy (e.g. an Apache front-end web &quot;</span>
            <span class="s2">&quot;server). Options: </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">ReverseProxiedMiddleware</span><span class="o">.</span><span class="n">ALL_CANDIDATES</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">sp</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--proxy_http_host&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Option to set the WSGI HTTP host directly. &quot;</span>
            <span class="s2">&quot;This affects the WSGI variable </span><span class="si">{w}</span><span class="s2">. If not specified, &quot;</span>
            <span class="s2">&quot;trusted variables within </span><span class="si">{v!r}</span><span class="s2"> will be used.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">w</span><span class="o">=</span><span class="n">WsgiEnvVar</span><span class="o">.</span><span class="n">HTTP_HOST</span><span class="p">,</span>
                <span class="n">v</span><span class="o">=</span><span class="n">ReverseProxiedMiddleware</span><span class="o">.</span><span class="n">CANDIDATES_HTTP_HOST</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">sp</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--proxy_remote_addr&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Option to set the WSGI remote address directly. &quot;</span>
            <span class="s2">&quot;This affects the WSGI variable </span><span class="si">{w}</span><span class="s2">. If not specified, &quot;</span>
            <span class="s2">&quot;trusted variables within </span><span class="si">{v!r}</span><span class="s2"> will be used.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">w</span><span class="o">=</span><span class="n">WsgiEnvVar</span><span class="o">.</span><span class="n">REMOTE_ADDR</span><span class="p">,</span>
                <span class="n">v</span><span class="o">=</span><span class="n">ReverseProxiedMiddleware</span><span class="o">.</span><span class="n">CANDIDATES_REMOTE_ADDR</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">sp</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--proxy_script_name&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Path at which this script is mounted. Set this if you are &quot;</span>
            <span class="s2">&quot;hosting this CamCOPS instance at a non-root path, unless you &quot;</span>
            <span class="s2">&quot;set trusted WSGI headers instead. For example, &quot;</span>
            <span class="s2">&quot;if you are running an Apache server and want this instance &quot;</span>
            <span class="s2">&quot;of CamCOPS to appear at /somewhere/camcops, then (a) &quot;</span>
            <span class="s2">&quot;configure your Apache instance to proxy requests to &quot;</span>
            <span class="s2">&quot;/somewhere/camcops/... to this server (e.g. via an internal &quot;</span>
            <span class="s2">&quot;TCP/IP port or UNIX socket) and specify this option. If this &quot;</span>
            <span class="s2">&quot;option is not set, then the OS environment variable </span><span class="si">{sn}</span><span class="s2"> &quot;</span>
            <span class="s2">&quot;will be checked as well, and if that is not set, trusted &quot;</span>
            <span class="s2">&quot;variables within </span><span class="si">{v!r}</span><span class="s2"> will be used. This option affects the &quot;</span>
            <span class="s2">&quot;WSGI variables </span><span class="si">{sn}</span><span class="s2"> and </span><span class="si">{pi}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">sn</span><span class="o">=</span><span class="n">WsgiEnvVar</span><span class="o">.</span><span class="n">SCRIPT_NAME</span><span class="p">,</span>
                <span class="n">pi</span><span class="o">=</span><span class="n">WsgiEnvVar</span><span class="o">.</span><span class="n">PATH_INFO</span><span class="p">,</span>
                <span class="n">v</span><span class="o">=</span><span class="n">ReverseProxiedMiddleware</span><span class="o">.</span><span class="n">CANDIDATES_SCRIPT_NAME</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">sp</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--proxy_server_port&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Option to set the WSGI server port directly. &quot;</span>
            <span class="s2">&quot;This affects the WSGI variable </span><span class="si">{w}</span><span class="s2">. If not specified, &quot;</span>
            <span class="s2">&quot;trusted variables within </span><span class="si">{v!r}</span><span class="s2"> will be used.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">w</span><span class="o">=</span><span class="n">WsgiEnvVar</span><span class="o">.</span><span class="n">SERVER_PORT</span><span class="p">,</span>
                <span class="n">v</span><span class="o">=</span><span class="n">ReverseProxiedMiddleware</span><span class="o">.</span><span class="n">CANDIDATES_SERVER_PORT</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">sp</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--proxy_server_name&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Option to set the WSGI server name directly. &quot;</span>
            <span class="s2">&quot;This affects the WSGI variable </span><span class="si">{w}</span><span class="s2">. If not specified, &quot;</span>
            <span class="s2">&quot;trusted variables within </span><span class="si">{v!r}</span><span class="s2"> will be used.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">w</span><span class="o">=</span><span class="n">WsgiEnvVar</span><span class="o">.</span><span class="n">SERVER_NAME</span><span class="p">,</span>
                <span class="n">v</span><span class="o">=</span><span class="n">ReverseProxiedMiddleware</span><span class="o">.</span><span class="n">CANDIDATES_SERVER_NAME</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">sp</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--proxy_url_scheme&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Option to set the WSGI scheme (e.g. http, https) directly. &quot;</span>
            <span class="s2">&quot;This affects the WSGI variable </span><span class="si">{w}</span><span class="s2">. If not specified, &quot;</span>
            <span class="s2">&quot;trusted variables within </span><span class="si">{v!r}</span><span class="s2"> will be used.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">w</span><span class="o">=</span><span class="n">WsgiEnvVar</span><span class="o">.</span><span class="n">WSGI_URL_SCHEME</span><span class="p">,</span>
                <span class="n">v</span><span class="o">=</span><span class="n">ReverseProxiedMiddleware</span><span class="o">.</span><span class="n">CANDIDATES_URL_SCHEME</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">sp</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--proxy_rewrite_path_info&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;If SCRIPT_NAME is rewritten, this option causes PATH_INFO to &quot;</span>
            <span class="s2">&quot;be rewritten, if it starts with SCRIPT_NAME, to strip off &quot;</span>
            <span class="s2">&quot;SCRIPT_NAME. Appropriate for some front-end web browsers &quot;</span>
            <span class="s2">&quot;with limited reverse proxying support (but do not use for &quot;</span>
            <span class="s2">&quot;Apache with ProxyPass, because that rewrites incoming URLs &quot;</span>
            <span class="s2">&quot;properly).&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">sp</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--debug_reverse_proxy&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;For --behind_reverse_proxy: show debugging information as &quot;</span>
             <span class="s2">&quot;WSGI variables are rewritten.&quot;</span>
    <span class="p">)</span>
    <span class="n">sp</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--debug_toolbar&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable the Pyramid debug toolbar&quot;</span>
    <span class="p">)</span>


<div class="viewcode-block" id="camcops_main"><a class="viewcode-back" href="../../autodoc/camcops.html#camcops_server.camcops.camcops_main">[docs]</a><span class="k">def</span> <span class="nf">camcops_main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Command-line entry point.</span>

<span class="sd">    Note that we can&#39;t easily use delayed imports to speed up the help output,</span>
<span class="sd">    because the help system has function calls embedded into it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Fetch command-line options.</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Base parser</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">prog</span><span class="o">=</span><span class="s2">&quot;camcops&quot;</span><span class="p">,</span>  <span class="c1"># name the user will use to call it</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;CamCOPS server version </span><span class="si">{}</span><span class="s2">, by Rudolf Cardinal.</span>
<span class="s2">Use &#39;camcops &lt;COMMAND&gt; --help&#39; for more detail on each command.&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">CAMCOPS_SERVER_VERSION</span><span class="p">),</span>
        <span class="n">formatter_class</span><span class="o">=</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">,</span>
        <span class="c1"># add_help=False  # only do this if manually overriding the method</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--allhelp&#39;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="n">ShowAllSubparserHelpAction</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;show help for all commands and exit&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--version&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;version&quot;</span><span class="p">,</span>
        <span class="n">version</span><span class="o">=</span><span class="s2">&quot;CamCOPS </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">CAMCOPS_SERVER_VERSION</span><span class="p">))</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Subcommand subparser</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="n">subparsers</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_subparsers</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;commands&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Valid CamCOPS commands are as follows.&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Specify one command.&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;command&#39;</span><span class="p">,</span>  <span class="c1"># sorts out the help for the command being mandatory</span>
        <span class="c1"># https://stackoverflow.com/questions/23349349/argparse-with-required-subparser  # noqa</span>
    <span class="p">)</span>  <span class="c1"># type: _SubParsersAction  # noqa</span>
    <span class="n">subparsers</span><span class="o">.</span><span class="n">required</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># requires a command</span>
    <span class="c1"># You can&#39;t use &quot;add_subparsers&quot; more than once.</span>
    <span class="c1"># Subparser groups seem not yet to be supported:</span>
    <span class="c1">#   https://bugs.python.org/issue9341</span>
    <span class="c1">#   https://bugs.python.org/issue14037</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Getting started commands</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="n">docs_parser</span> <span class="o">=</span> <span class="n">add_sub</span><span class="p">(</span>
        <span class="n">subparsers</span><span class="p">,</span> <span class="s2">&quot;docs&quot;</span><span class="p">,</span> <span class="n">config_mandatory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Launch the main documentation (CamCOPS manual)&quot;</span>
    <span class="p">)</span>
    <span class="n">docs_parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span>
        <span class="n">func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">args</span><span class="p">:</span> <span class="n">launch_manual</span><span class="p">())</span>

    <span class="n">democonfig_parser</span> <span class="o">=</span> <span class="n">add_sub</span><span class="p">(</span>
        <span class="n">subparsers</span><span class="p">,</span> <span class="s2">&quot;demo_camcops_config&quot;</span><span class="p">,</span> <span class="n">config_mandatory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Print a demo CamCOPS config file&quot;</span><span class="p">)</span>
    <span class="n">democonfig_parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span>
        <span class="n">func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">args</span><span class="p">:</span> <span class="n">print_demo_camcops_config</span><span class="p">())</span>

    <span class="n">demosupervisorconf_parser</span> <span class="o">=</span> <span class="n">add_sub</span><span class="p">(</span>
        <span class="n">subparsers</span><span class="p">,</span> <span class="s2">&quot;demo_supervisor_config&quot;</span><span class="p">,</span> <span class="n">config_mandatory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Print a demo &#39;supervisor&#39; config file for CamCOPS&quot;</span><span class="p">)</span>
    <span class="n">demosupervisorconf_parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span>
        <span class="n">func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">args</span><span class="p">:</span> <span class="n">print_demo_supervisor_config</span><span class="p">())</span>

    <span class="n">demoapacheconf_parser</span> <span class="o">=</span> <span class="n">add_sub</span><span class="p">(</span>
        <span class="n">subparsers</span><span class="p">,</span> <span class="s2">&quot;demo_apache_config&quot;</span><span class="p">,</span> <span class="n">config_mandatory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Print a demo Apache config file section for CamCOPS&quot;</span><span class="p">)</span>
    <span class="n">demoapacheconf_parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span>
        <span class="n">func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">args</span><span class="p">:</span> <span class="n">print_demo_apache_config</span><span class="p">())</span>

    <span class="n">demo_mysql_create_db_parser</span> <span class="o">=</span> <span class="n">add_sub</span><span class="p">(</span>
        <span class="n">subparsers</span><span class="p">,</span> <span class="s2">&quot;demo_mysql_create_db&quot;</span><span class="p">,</span> <span class="n">config_mandatory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Print demo instructions to create a MySQL database for CamCOPS&quot;</span><span class="p">)</span>
    <span class="n">demo_mysql_create_db_parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span>
        <span class="n">func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">args</span><span class="p">:</span> <span class="n">print_demo_mysql_create_db</span><span class="p">())</span>

    <span class="n">demo_mysql_dump_script_parser</span> <span class="o">=</span> <span class="n">add_sub</span><span class="p">(</span>
        <span class="n">subparsers</span><span class="p">,</span> <span class="s2">&quot;demo_mysql_dump_script&quot;</span><span class="p">,</span> <span class="n">config_mandatory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Print demo instructions to dump all current MySQL databases&quot;</span><span class="p">)</span>
    <span class="n">demo_mysql_dump_script_parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span>
        <span class="n">func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">args</span><span class="p">:</span> <span class="n">print_demo_mysql_dump_script</span><span class="p">())</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Database commands</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="n">upgradedb_parser</span> <span class="o">=</span> <span class="n">add_sub</span><span class="p">(</span>
        <span class="n">subparsers</span><span class="p">,</span> <span class="s2">&quot;upgrade_db&quot;</span><span class="p">,</span> <span class="n">config_mandatory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Upgrade database to most recent version (via Alembic)&quot;</span><span class="p">)</span>
    <span class="n">upgradedb_parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span>
        <span class="n">func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">args</span><span class="p">:</span> <span class="n">upgrade_database_to_head</span><span class="p">())</span>

    <span class="n">show_upgrade_sql_parser</span> <span class="o">=</span> <span class="n">add_sub</span><span class="p">(</span>
        <span class="n">subparsers</span><span class="p">,</span> <span class="s2">&quot;show_upgrade_sql&quot;</span><span class="p">,</span> <span class="n">config_mandatory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Show SQL for upgrading database (to stdout)&quot;</span><span class="p">)</span>
    <span class="n">show_upgrade_sql_parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span>
        <span class="n">func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">args</span><span class="p">:</span> <span class="n">upgrade_database_to_head</span><span class="p">(</span><span class="n">as_sql</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

    <span class="n">showdbtitle_parser</span> <span class="o">=</span> <span class="n">add_sub</span><span class="p">(</span>
        <span class="n">subparsers</span><span class="p">,</span> <span class="s2">&quot;show_db_title&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Show database title&quot;</span><span class="p">)</span>
    <span class="n">showdbtitle_parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span>
        <span class="n">func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">args</span><span class="p">:</span> <span class="n">print_database_title</span><span class="p">())</span>

    <span class="n">mergedb_parser</span> <span class="o">=</span> <span class="n">add_sub</span><span class="p">(</span>
        <span class="n">subparsers</span><span class="p">,</span> <span class="s2">&quot;merge_db&quot;</span><span class="p">,</span> <span class="n">config_mandatory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Merge in data from an old or recent CamCOPS database&quot;</span><span class="p">)</span>
    <span class="n">mergedb_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--report_every&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Report progress every n rows&quot;</span><span class="p">)</span>
    <span class="n">mergedb_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--echo&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Echo SQL to source database&quot;</span><span class="p">)</span>
    <span class="n">mergedb_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--dummy_run&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Perform a dummy run only; do not alter destination database&quot;</span><span class="p">)</span>
    <span class="n">mergedb_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--info_only&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Show table information only; don&#39;t do any work&quot;</span><span class="p">)</span>
    <span class="n">mergedb_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--skip_hl7_logs&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Skip the HL7 message log table&quot;</span><span class="p">)</span>
    <span class="n">mergedb_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--skip_audit_logs&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Skip the audit log table&quot;</span><span class="p">)</span>
    <span class="n">mergedb_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--default_group_id&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Default group ID (integer) to apply to old records without one. &quot;</span>
             <span class="s2">&quot;If none is specified, a new group will be created for such &quot;</span>
             <span class="s2">&quot;records.&quot;</span><span class="p">)</span>
    <span class="n">mergedb_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--default_group_name&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If default_group_id is not specified, use this group name. The &quot;</span>
             <span class="s2">&quot;group will be looked up if it exists, and created if not.&quot;</span><span class="p">)</span>
    <span class="n">add_req_named</span><span class="p">(</span>
        <span class="n">mergedb_parser</span><span class="p">,</span>
        <span class="s2">&quot;--src&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Source database (specified as an SQLAlchemy URL). The contents &quot;</span>
             <span class="s2">&quot;of this database will be merged into the database specified &quot;</span>
             <span class="s2">&quot;in the config file.&quot;</span><span class="p">)</span>
    <span class="n">mergedb_parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">args</span><span class="p">:</span> <span class="n">merge_camcops_db</span><span class="p">(</span>
        <span class="n">src</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">src</span><span class="p">,</span>
        <span class="n">echo</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">echo</span><span class="p">,</span>
        <span class="n">report_every</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">report_every</span><span class="p">,</span>
        <span class="n">dummy_run</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">dummy_run</span><span class="p">,</span>
        <span class="n">info_only</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">info_only</span><span class="p">,</span>
        <span class="n">skip_hl7_logs</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">skip_hl7_logs</span><span class="p">,</span>
        <span class="n">skip_audit_logs</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">skip_audit_logs</span><span class="p">,</span>
        <span class="n">default_group_id</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">default_group_id</span><span class="p">,</span>
        <span class="n">default_group_name</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">default_group_name</span><span class="p">,</span>
    <span class="p">))</span>
    <span class="c1"># WATCH OUT. There appears to be a bug somewhere in the way that the</span>
    <span class="c1"># Pyramid debug toolbar registers itself with SQLAlchemy (see</span>
    <span class="c1"># pyramid_debugtoolbar/panels/sqla.py; look for &quot;before_cursor_execute&quot;</span>
    <span class="c1"># and &quot;after_cursor_execute&quot;. Somehow, some connections (but not all) seem</span>
    <span class="c1"># to get this event registered twice. The upshot is that the sequence can</span>
    <span class="c1"># lead to an attempt to double-delete the debug toolbar&#39;s timer:</span>
    <span class="c1">#</span>
    <span class="c1"># _before_cursor_execute: &lt;sqlalchemy.engine.base.Connection object at 0x7f5c1fa7c630&gt;, &#39;SHOW CREATE TABLE `_hl7_run_log`&#39;, ()  # noqa</span>
    <span class="c1"># _before_cursor_execute: &lt;sqlalchemy.engine.base.Connection object at 0x7f5c1fa7c630&gt;, &#39;SHOW CREATE TABLE `_hl7_run_log`&#39;, ()  # noqa</span>
    <span class="c1">#       ^^^ this is the problem: event called twice</span>
    <span class="c1"># _after_cursor_execute: &lt;sqlalchemy.engine.base.Connection object at 0x7f5c1fa7c630&gt;, &#39;SHOW CREATE TABLE `_hl7_run_log`&#39;, ()  # noqa</span>
    <span class="c1"># _after_cursor_execute: &lt;sqlalchemy.engine.base.Connection object at 0x7f5c1fa7c630&gt;, &#39;SHOW CREATE TABLE `_hl7_run_log`&#39;, ()  # noqa</span>
    <span class="c1">#       ^^^ and this is where the problem becomes evident</span>
    <span class="c1"># Traceback (most recent call last):</span>
    <span class="c1"># ...</span>
    <span class="c1">#   File &quot;/home/rudolf/dev/venvs/camcops/lib/python3.5/site-packages/pyramid_debugtoolbar/panels/sqla.py&quot;, line 51, in _after_cursor_execute  # noqa</span>
    <span class="c1">#     delattr(conn, &#39;pdtb_start_timer&#39;)</span>
    <span class="c1"># AttributeError: pdtb_start_timer</span>
    <span class="c1">#</span>
    <span class="c1"># So the simplest thing is only to register the debug toolbar for stuff</span>
    <span class="c1"># that might need it...</span>

    <span class="n">createdb_parser</span> <span class="o">=</span> <span class="n">add_sub</span><span class="p">(</span>
        <span class="n">subparsers</span><span class="p">,</span> <span class="s2">&quot;create_db&quot;</span><span class="p">,</span> <span class="n">config_mandatory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Create CamCOPS database from scratch (AVOID; use the upgrade &quot;</span>
             <span class="s2">&quot;facility instead)&quot;</span><span class="p">)</span>
    <span class="n">add_req_named</span><span class="p">(</span>
        <span class="n">createdb_parser</span><span class="p">,</span>
        <span class="s1">&#39;--confirm_create_db&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Must specify this too, as a safety measure&quot;</span><span class="p">)</span>
    <span class="n">createdb_parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span>
        <span class="n">func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">args</span><span class="p">:</span> <span class="n">create_database_from_scratch</span><span class="p">(</span>
            <span class="n">cfg</span><span class="o">=</span><span class="n">get_default_config_from_os_env</span><span class="p">()</span>
        <span class="p">))</span>

    <span class="c1"># db_group.add_argument(</span>
    <span class="c1">#     &quot;-s&quot;, &quot;--summarytables&quot;, action=&quot;store_true&quot;, default=False,</span>
    <span class="c1">#     help=&quot;Make summary tables&quot;)</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># User commands</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="n">superuser_parser</span> <span class="o">=</span> <span class="n">add_sub</span><span class="p">(</span>
        <span class="n">subparsers</span><span class="p">,</span> <span class="s2">&quot;make_superuser&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Make superuser, or give superuser status to an existing user&quot;</span><span class="p">)</span>
    <span class="n">superuser_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--username&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Username of superuser to create/promote (if omitted, you will &quot;</span>
             <span class="s2">&quot;be asked to type it in)&quot;</span><span class="p">)</span>
    <span class="n">superuser_parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">args</span><span class="p">:</span> <span class="n">make_superuser</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">username</span>
    <span class="p">))</span>

    <span class="n">password_parser</span> <span class="o">=</span> <span class="n">add_sub</span><span class="p">(</span>
        <span class="n">subparsers</span><span class="p">,</span> <span class="s2">&quot;reset_password&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Reset a user&#39;s password&quot;</span><span class="p">)</span>
    <span class="n">password_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--username&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Username to change password for (if omitted, you will be asked &quot;</span>
             <span class="s2">&quot;to type it in)&quot;</span><span class="p">)</span>
    <span class="n">password_parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">args</span><span class="p">:</span> <span class="n">reset_password</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">username</span>
    <span class="p">))</span>

    <span class="n">enableuser_parser</span> <span class="o">=</span> <span class="n">add_sub</span><span class="p">(</span>
        <span class="n">subparsers</span><span class="p">,</span> <span class="s2">&quot;enable_user&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Re-enable a locked user account&quot;</span><span class="p">)</span>
    <span class="n">enableuser_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--username&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Username to enable (if omitted, you will be asked &quot;</span>
             <span class="s2">&quot;to type it in)&quot;</span><span class="p">)</span>
    <span class="n">enableuser_parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">args</span><span class="p">:</span> <span class="n">enable_user_cli</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">username</span>
    <span class="p">))</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Export options</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="n">ddl_parser</span> <span class="o">=</span> <span class="n">add_sub</span><span class="p">(</span>
        <span class="n">subparsers</span><span class="p">,</span> <span class="s2">&quot;ddl&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Print database schema (data definition language; DDL)&quot;</span><span class="p">)</span>
    <span class="n">ddl_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--dialect&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">SqlaDialectName</span><span class="o">.</span><span class="n">MYSQL</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;SQL dialect (options: </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ALL_SQLA_DIALECTS</span><span class="p">)))</span>
    <span class="n">ddl_parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span>
        <span class="n">func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">args</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">get_all_ddl</span><span class="p">(</span><span class="n">dialect_name</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">dialect</span><span class="p">)))</span>

    <span class="n">hl7_parser</span> <span class="o">=</span> <span class="n">add_sub</span><span class="p">(</span>
        <span class="n">subparsers</span><span class="p">,</span> <span class="s2">&quot;hl7&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Send pending HL7 messages and outbound files&quot;</span><span class="p">)</span>
    <span class="n">hl7_parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span>
        <span class="n">func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">args</span><span class="p">:</span> <span class="n">send_hl7</span><span class="p">(</span><span class="n">show_queue_only</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

    <span class="n">showhl7queue_parser</span> <span class="o">=</span> <span class="n">add_sub</span><span class="p">(</span>
        <span class="n">subparsers</span><span class="p">,</span> <span class="s2">&quot;show_hl7_queue&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;View outbound HL7/file queue (without sending)&quot;</span><span class="p">)</span>
    <span class="n">showhl7queue_parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span>
        <span class="n">func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">args</span><span class="p">:</span> <span class="n">send_hl7</span><span class="p">(</span><span class="n">show_queue_only</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

    <span class="c1"># *** ANONYMOUS STAGING DATABASE DISABLED TEMPORARILY</span>
    <span class="c1"># anonstaging_parser = add_sub(</span>
    <span class="c1">#     subparsers, &quot;anonstaging&quot;,</span>
    <span class="c1">#     help=&quot;Generate/regenerate anonymisation staging database&quot;)</span>
    <span class="c1"># anonstaging_parser.set_defaults(</span>
    <span class="c1">#     func=lambda args: generate_anonymisation_staging_db())</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Test options</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="n">showtests_parser</span> <span class="o">=</span> <span class="n">add_sub</span><span class="p">(</span>
        <span class="n">subparsers</span><span class="p">,</span> <span class="s2">&quot;show_tests&quot;</span><span class="p">,</span> <span class="n">config_mandatory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Show available self-tests&quot;</span><span class="p">)</span>
    <span class="n">showtests_parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">args</span><span class="p">:</span> <span class="n">self_test</span><span class="p">(</span><span class="n">show_only</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

    <span class="n">selftest_parser</span> <span class="o">=</span> <span class="n">add_sub</span><span class="p">(</span>
        <span class="n">subparsers</span><span class="p">,</span> <span class="s2">&quot;self_test&quot;</span><span class="p">,</span> <span class="n">config_mandatory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Test internal code&quot;</span><span class="p">)</span>
    <span class="n">selftest_parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">args</span><span class="p">:</span> <span class="n">self_test</span><span class="p">())</span>

    <span class="n">serve_pyr_parser</span> <span class="o">=</span> <span class="n">add_sub</span><span class="p">(</span>
        <span class="n">subparsers</span><span class="p">,</span> <span class="s2">&quot;serve_pyramid&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Test web server (single-thread, single-process, HTTP-only, &quot;</span>
             <span class="s2">&quot;Pyramid; for development use only&quot;</span><span class="p">)</span>
    <span class="n">serve_pyr_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--host&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_HOST</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Hostname to listen on&quot;</span><span class="p">)</span>
    <span class="n">serve_pyr_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--port&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_PORT</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Port to listen on&quot;</span><span class="p">)</span>
    <span class="n">add_wsgi_options</span><span class="p">(</span><span class="n">serve_pyr_parser</span><span class="p">)</span>
    <span class="n">serve_pyr_parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">args</span><span class="p">:</span> <span class="n">test_serve_pyramid</span><span class="p">(</span>
        <span class="n">application</span><span class="o">=</span><span class="n">make_wsgi_app_from_argparse_args</span><span class="p">(</span><span class="n">args</span><span class="p">),</span>
        <span class="n">host</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
        <span class="n">port</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">port</span>
    <span class="p">))</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Web server options</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="n">serve_cp_parser</span> <span class="o">=</span> <span class="n">add_sub</span><span class="p">(</span>
        <span class="n">subparsers</span><span class="p">,</span> <span class="s2">&quot;serve_cherrypy&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Start web server (via CherryPy)&quot;</span><span class="p">)</span>
    <span class="n">serve_cp_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--serve&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">serve_cp_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--host&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_HOST</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;hostname to listen on&quot;</span><span class="p">)</span>
    <span class="n">serve_cp_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--port&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_PORT</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;port to listen on&quot;</span><span class="p">)</span>
    <span class="n">serve_cp_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--unix_domain_socket&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;UNIX domain socket to listen on (overrides host/port if &quot;</span>
             <span class="s2">&quot;specified)&quot;</span><span class="p">)</span>
    <span class="n">serve_cp_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--server_name&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;CherryPy&#39;s SERVER_NAME environ entry&quot;</span><span class="p">)</span>
    <span class="n">serve_cp_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--threads_start&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of threads for server to start with&quot;</span><span class="p">)</span>
    <span class="n">serve_cp_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--threads_max&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_MAX_THREADS</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Maximum number of threads for server to use (-1 for no limit) &quot;</span>
             <span class="s2">&quot;(BEWARE exceeding the permitted number of database connections)&quot;</span><span class="p">)</span>
    <span class="n">serve_cp_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--ssl_certificate&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;SSL certificate file &quot;</span>
             <span class="s2">&quot;(e.g. /etc/ssl/certs/ssl-cert-snakeoil.pem)&quot;</span><span class="p">)</span>
    <span class="n">serve_cp_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--ssl_private_key&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;SSL private key file &quot;</span>
             <span class="s2">&quot;(e.g. /etc/ssl/private/ssl-cert-snakeoil.key)&quot;</span><span class="p">)</span>
    <span class="n">serve_cp_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--log_screen&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;log_screen&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Log access requests etc. to terminal (default)&quot;</span><span class="p">)</span>
    <span class="n">serve_cp_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--no_log_screen&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;log_screen&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_false&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Don&#39;t log access requests etc. to terminal&quot;</span><span class="p">)</span>
    <span class="n">serve_cp_parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">log_screen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">serve_cp_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--root_path&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">URL_PATH_ROOT</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Root path to serve CRATE at, WITHIN this CherryPy web server &quot;</span>
            <span class="s2">&quot;instance. (There is unlikely to be a reason to use something &quot;</span>
            <span class="s2">&quot;other than &#39;/&#39;; do not confuse this with the mount point &quot;</span>
            <span class="s2">&quot;within a wider, e.g. Apache, configuration, which is set &quot;</span>
            <span class="s2">&quot;instead by the WSGI variable </span><span class="si">{}</span><span class="s2">; see the &quot;</span>
            <span class="s2">&quot;--trusted_proxy_headers and --proxy_script_name &quot;</span>
            <span class="s2">&quot;options.)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">WsgiEnvVar</span><span class="o">.</span><span class="n">SCRIPT_NAME</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">add_wsgi_options</span><span class="p">(</span><span class="n">serve_cp_parser</span><span class="p">)</span>
    <span class="n">serve_cp_parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">args</span><span class="p">:</span> <span class="n">serve_cherrypy</span><span class="p">(</span>
        <span class="n">application</span><span class="o">=</span><span class="n">make_wsgi_app_from_argparse_args</span><span class="p">(</span><span class="n">args</span><span class="p">),</span>
        <span class="n">host</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
        <span class="n">port</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
        <span class="n">threads_start</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">threads_start</span><span class="p">,</span>
        <span class="n">threads_max</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">threads_max</span><span class="p">,</span>
        <span class="n">unix_domain_socket_filename</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">unix_domain_socket</span><span class="p">,</span>
        <span class="n">server_name</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">server_name</span><span class="p">,</span>
        <span class="n">log_screen</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">log_screen</span><span class="p">,</span>
        <span class="n">ssl_certificate</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ssl_certificate</span><span class="p">,</span>
        <span class="n">ssl_private_key</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ssl_private_key</span><span class="p">,</span>
        <span class="n">root_path</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">root_path</span><span class="p">,</span>
    <span class="p">))</span>

    <span class="n">cpu_count</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>

    <span class="n">serve_gu_parser</span> <span class="o">=</span> <span class="n">add_sub</span><span class="p">(</span>
        <span class="n">subparsers</span><span class="p">,</span> <span class="s2">&quot;serve_gunicorn&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Start web server (via Gunicorn) (not available under Windows)&quot;</span><span class="p">)</span>
    <span class="n">serve_gu_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--serve&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">serve_gu_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--host&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_HOST</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;hostname to listen on&quot;</span><span class="p">)</span>
    <span class="n">serve_gu_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--port&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_PORT</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;port to listen on&quot;</span><span class="p">)</span>
    <span class="n">serve_gu_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;--unix_domain_socket&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;UNIX domain socket to listen on (overrides host/port if &quot;</span>
             <span class="s2">&quot;specified)&quot;</span><span class="p">)</span>
    <span class="n">serve_gu_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--num_workers&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">cpu_count</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of worker processes for server to use&quot;</span><span class="p">)</span>
    <span class="n">serve_gu_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--debug_reload&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Debugging option: reload Gunicorn upon code change&quot;</span><span class="p">)</span>
    <span class="n">serve_gu_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--ssl_certificate&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;SSL certificate file &quot;</span>
             <span class="s2">&quot;(e.g. /etc/ssl/certs/ssl-cert-snakeoil.pem)&quot;</span><span class="p">)</span>
    <span class="n">serve_gu_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--ssl_private_key&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;SSL private key file &quot;</span>
             <span class="s2">&quot;(e.g. /etc/ssl/private/ssl-cert-snakeoil.key)&quot;</span><span class="p">)</span>
    <span class="n">serve_gu_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--timeout&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Gunicorn worker timeout (s)&quot;</span>
    <span class="p">)</span>
    <span class="n">serve_gu_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--debug_show_gunicorn_options&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Debugging option: show possible Gunicorn settings&quot;</span>
    <span class="p">)</span>
    <span class="n">serve_gu_parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">log_screen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">add_wsgi_options</span><span class="p">(</span><span class="n">serve_gu_parser</span><span class="p">)</span>
    <span class="n">serve_gu_parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">args</span><span class="p">:</span> <span class="n">serve_gunicorn</span><span class="p">(</span>
        <span class="n">application</span><span class="o">=</span><span class="n">make_wsgi_app_from_argparse_args</span><span class="p">(</span><span class="n">args</span><span class="p">),</span>
        <span class="n">host</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
        <span class="n">port</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
        <span class="n">num_workers</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span>
        <span class="n">unix_domain_socket_filename</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">unix_domain_socket</span><span class="p">,</span>
        <span class="n">ssl_certificate</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ssl_certificate</span><span class="p">,</span>
        <span class="n">ssl_private_key</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ssl_private_key</span><span class="p">,</span>
        <span class="n">reload</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">debug_reload</span><span class="p">,</span>
        <span class="n">timeout_s</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
        <span class="n">debug_show_gunicorn_options</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">debug_show_gunicorn_options</span><span class="p">,</span>
    <span class="p">))</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># OK; parse the arguments</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="n">progargs</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="c1"># Initial log level (overridden later by config file but helpful for start)</span>
    <span class="n">loglevel</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span> <span class="k">if</span> <span class="n">progargs</span><span class="o">.</span><span class="n">verbose</span> <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span>
    <span class="n">rootlogger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
    <span class="n">set_level_for_logger_and_its_handlers</span><span class="p">(</span><span class="n">rootlogger</span><span class="p">,</span> <span class="n">loglevel</span><span class="p">)</span>

    <span class="c1"># Say hello</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;CamCOPS server version </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">CAMCOPS_SERVER_VERSION</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;By Rudolf Cardinal. See </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">CAMCOPS_URL</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using </span><span class="si">{}</span><span class="s2"> tasks&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">Task</span><span class="o">.</span><span class="n">all_subclasses_by_tablename</span><span class="p">()))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Command-line arguments: </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">progargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">DEBUG_LOG_CONFIG</span><span class="p">:</span>
        <span class="n">print_report_on_all_logs</span><span class="p">()</span>

    <span class="c1"># Finalize the config filename</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">progargs</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">progargs</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
        <span class="c1"># We want the the config filename in the environment from now on:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">ENVVAR_CONFIG_FILE</span><span class="p">]</span> <span class="o">=</span> <span class="n">progargs</span><span class="o">.</span><span class="n">config</span>
    <span class="n">cfg_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ENVVAR_CONFIG_FILE</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using configuration file: </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cfg_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">progargs</span><span class="o">.</span><span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Command-line function not implemented!&quot;</span><span class="p">)</span>
    <span class="n">success</span> <span class="o">=</span> <span class="n">progargs</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">progargs</span><span class="p">)</span>  <span class="c1"># type: Optional[bool]</span>
    <span class="k">if</span> <span class="n">success</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">success</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Command-line entry point</span>
<span class="c1"># =============================================================================</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">DEBUG_RUN_WITH_PDB</span><span class="p">:</span>
        <span class="n">pdb_run</span><span class="p">(</span><span class="n">camcops_main</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">camcops_main</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../../index.html">Table Of Contents</a></h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/download.html">2. Downloading CamCOPS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../client/client_installation.html">3. Installing and configuring the client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../client/client_using.html">4. Using the client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../server/server_front_end_general.html">5. Web site: general use</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tasks/_tasks_by_category.html">6. Tasks in CamCOPS by category</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tasks/_tasks_all.html">7. All tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../client/client_troubleshooting.html">8. Troubleshooting client problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../server/server_installation.html">9. Installing CamCOPS on the server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../server/server_configuration.html">10. Configuring the server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../server/server_config_file.html">11. The CamCOPS server configuration file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../server/server_front_end_admin.html">12. Web site: admin functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../server/server_command_line.html">13. CamCOPS command-line tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../server/server_troubleshooting.html">14. Troubleshooting server problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../licences/licences.html">15. Licences</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/index.html">16. Developer notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/tcpip_ports.html">17. Common relevant TCP/IP ports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/linux_flavours.html">18. Linux flavours</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../autodoc/_index.html">19. Automatic documentation of core server source code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">20. Change log/history</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq_known_problems.html">21. FAQ and known problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../to_do.html">22. Things to do</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../wishlist.html">23. Wishlist and blue-sky thoughts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/local_info.html">24. Local configuration information</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">CamCOPS 2.2.4 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2012-2018, Rudolf Cardinal.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.5.
    </div>
  </body>
</html>