
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>1.9. Internal data structure in CamCOPS &#8212; CamCOPS 2.2.4 documentation</title>
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/css/camcops_docs.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="2. Downloading CamCOPS" href="../misc/download.html" />
    <link rel="prev" title="1.8. Security design" href="security_design.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../misc/download.html" title="2. Downloading CamCOPS"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="security_design.html" title="1.8. Security design"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">CamCOPS 2.2.4 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="introduction.html" accesskey="U">1. Introduction</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="internal-data-structure-in-camcops">
<h1>1.9. Internal data structure in CamCOPS<a class="headerlink" href="#internal-data-structure-in-camcops" title="Permalink to this headline">¶</a></h1>
<div class="section" id="the-basics">
<h2>1.9.1. The basics<a class="headerlink" href="#the-basics" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>The CamCOPS client uses a simple, standard relational database design.</li>
<li>The server tables mirror the client device tables closely.</li>
<li>On top of this, a layer of complexity is grafted: (a) to allow devices to
operate independently, (b) to allow an audit trail, and (c) to allow devices
to wipe their data whilst preserving it on the server.</li>
</ul>
<p>To overcome this complexity for most practical purposes, the server provides
methods of viewing or downloading task data that hides out-of-date versions and
so forth.</p>
</div>
<div class="section" id="audit-trail-and-preserve-and-delete-function">
<h2>1.9.2. Audit trail and preserve-and-delete function<a class="headerlink" href="#audit-trail-and-preserve-and-delete-function" title="Permalink to this headline">¶</a></h2>
<p>The thought process behind the design runs as follows.</p>
<ul class="simple">
<li>Tablet devices (“clients”) must be able to operate offline, without internet
connectivity. Therefore, they must store their data locally, at least for a
time; and they must periodically communicate with their server.</li>
<li>Patient details should not be retrievable from a central server to the tablet
device, because that isn’t necessary (the web viewer offers an alternative
route) and therefore represents an unnecessary security vulnerability.
Additionally, requiring different tablets to be synchronized is potentially
unreliable (e.g. if someone adds the same patient on two tablets, both
currently disconnected from the network). Consequently, patient details on
different tablet devices are not necessarily synchronized. Therefore, the
server must maintain records for each of its client tablet devices and keep
them independent.<ul>
<li>All client tables have a primary key called id; this primary key is unique in
that table on that device.</li>
<li>The server mirrors the tables found on the client device.</li>
<li>In addition, a <cite>_device</cite> field on the server discriminates records by the
unique device ID of the uploading device.</li>
<li>The server maintains its own primary key in the <cite>_pk</cite> field; this field is
unique in that table on the server (across all devices).</li>
</ul>
</li>
<li>If someone edits a record on the server, the server shouldn’t rewrite its own
records; it should maintain an audit trail. Therefore, the server must keep
“old” records and distinguish them from “current” records.<ul>
<li>The server maintains a <cite>_current</cite> field, to mark current records.</li>
<li>Records that are not current have additional information. (Is the record
not current because it was deleted or because it was modified? Who deleted
or modified it? Which is its predecessor or successor record?)</li>
<li>Inclusion of fields for “when added” and “when removed” allows a historical
snapshot for any moment in time to be created.</li>
</ul>
</li>
<li>It should be possible to wipe a tablet device, yet keep its data actively
accessible on the server. Therefore, the server must keep “era” information
for each device.<ul>
<li>The server has an <cite>_era</cite> field for each table.</li>
<li>The <cite>_era</cite> field begins life with the value <cite>‘NOW’</cite>, representing the
“current” era. (The use of <cite>‘NOW’</cite> rather than NULL allows string
comparison at all times; see below regarding date/time storage.)</li>
<li>When a device “preserves” its data on the server and wipes its database,
the _era field is set to the date/time of the preservation process, for all
records in all tables for that device that were in the “current” era. A new
era is therefore begun for that device.</li>
<li>The combination of the <cite>_device</cite>, <cite>_era</cite>, and <cite>id</cite> fields is unique for all
<cite>_current</cite> fields.</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="transactional-upload">
<h2>1.9.3. Transactional upload<a class="headerlink" href="#transactional-upload" title="Permalink to this headline">¶</a></h2>
<p>The upload process is transactional: it either succeeds as a whole, or fails as
a whole. (This is necessary because there may be arbitrary relationships
between tables on the tablet, e.g. between the main table of a task and its
sub-tables.)</p>
</div>
<div class="section" id="date-time-storage">
<h2>1.9.4. Date/time storage<a class="headerlink" href="#date-time-storage" title="Permalink to this headline">¶</a></h2>
<p>Databases like MySQL discard fractions of a second, and CamCOPS needs to store
millisecond-accuracy timing information. Moreover, it is often helpful to work
in local time zones. Few databases handle this well, and there are no
consistent standards for database timezone handling.</p>
<p>For consistency, therefore, all date and date/time fields are stored as TEXT
fields in ISO 8601 format <a class="footnote-reference" href="#iso8601" id="id1">[1]</a>, specifically
<cite>YYYY-MM-DDTHH:mm:ss.SSS+ZZ:ZZ</cite>. An example is <cite>2013-04-22T14:35:07.381+01:00</cite>
– this means 22 April 2013 at 7.381 seconds after 2:35pm in a time zone 1 hour
ahead of Coordinated Universal Time (UTC, GMT), such as British Summer Time
(+01:00). Greater (e.g. microsecond) accuracy is permitted but not generally
used.</p>
<p>There are a few fields that are an exception to this rule and use DATETIME
format, but these are only used by the server and are not generally accessible
to users.</p>
</div>
<div class="section" id="tables-in-the-camcops-database">
<h2>1.9.5. Tables in the CamCOPS database<a class="headerlink" href="#tables-in-the-camcops-database" title="Permalink to this headline">¶</a></h2>
<p>Full details are available via the server’s option to view device definition
language (DDL, a subset of SQL) for all tables. These are fully commented, for
DDL dialects that support comments (try MySQL).</p>
<p>Note in particular the following conventions</p>
<ul class="simple">
<li>Tables beginning with an underscore (<cite>_</cite>) are private to the server, i.e. data
is not uploaded into them.</li>
<li>Fields (columns) beginning with an underscore are added by the server.</li>
<li>Columns with “(TASK)” in their comments are generic task fields.</li>
<li>Columns with “(CLINICIAN)” in their comments are generic fields for tasks
having a clinician whose details are recorded.</li>
<li>Columns with “(RESPONDENT)” in their comments are generic fields for tasks
having a respondent (i.e. someone answering the questions who’s not the
patient/subject and who’s not the clinician – such as a carer).</li>
<li>Columns with “(SERVER)” in their comments are added by the server.</li>
<li>Columns with “(GENERIC)” in their comments are generic summary fields.
Summary fields are not present on the server, but are created dynamically.
See <a class="reference internal" href="../server/server_front_end_general.html#summary-fields"><span class="std std-ref">summary fields</span></a>.</li>
</ul>
<p class="rubric">Footnotes</p>
<table class="docutils footnote" frame="void" id="iso8601" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="https://en.wikipedia.org/wiki/ISO_8601">https://en.wikipedia.org/wiki/ISO_8601</a></td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../index.html">Table Of Contents</a></h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="introduction.html">1. Introduction</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="overview.html">1.1. Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="tour.html">1.2. Tour</a></li>
<li class="toctree-l2"><a class="reference internal" href="requirements.html">1.3. Requirements and costs</a></li>
<li class="toctree-l2"><a class="reference internal" href="patient_identification.html">1.4. Patient/subject identification in CamCOPS</a></li>
<li class="toctree-l2"><a class="reference internal" href="groups.html">1.5. Groups</a></li>
<li class="toctree-l2"><a class="reference internal" href="registration.html">1.6. About device registration</a></li>
<li class="toctree-l2"><a class="reference internal" href="intellectual_property.html">1.7. Intellectual property</a></li>
<li class="toctree-l2"><a class="reference internal" href="security_design.html">1.8. Security design</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">1.9. Internal data structure in CamCOPS</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../misc/download.html">2. Downloading CamCOPS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../client/client_installation.html">3. Installing and configuring the client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../client/client_using.html">4. Using the client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../server/server_front_end_general.html">5. Web site: general use</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tasks/_tasks_by_category.html">6. Tasks in CamCOPS by category</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tasks/_tasks_all.html">7. All tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../client/client_troubleshooting.html">8. Troubleshooting client problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../server/server_installation.html">9. Installing CamCOPS on the server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../server/server_configuration.html">10. Configuring the server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../server/server_config_file.html">11. The CamCOPS server configuration file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../server/server_front_end_admin.html">12. Web site: admin functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../server/server_command_line.html">13. CamCOPS command-line tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../server/server_troubleshooting.html">14. Troubleshooting server problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../licences/licences.html">15. Licences</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer/index.html">16. Developer notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/tcpip_ports.html">17. Common relevant TCP/IP ports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/linux_flavours.html">18. Linux flavours</a></li>
<li class="toctree-l1"><a class="reference internal" href="../autodoc/_index.html">19. Automatic documentation of core server source code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">20. Change log/history</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq_known_problems.html">21. FAQ and known problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../to_do.html">22. Things to do</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wishlist.html">23. Wishlist and blue-sky thoughts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/local_info.html">24. Local configuration information</a></li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="security_design.html"
                        title="previous chapter">1.8. Security design</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../misc/download.html"
                        title="next chapter">2. Downloading CamCOPS</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/introduction/data_structure_design.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../misc/download.html" title="2. Downloading CamCOPS"
             >next</a> |</li>
        <li class="right" >
          <a href="security_design.html" title="1.8. Security design"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">CamCOPS 2.2.4 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="introduction.html" >1. Introduction</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2012-2018, Rudolf Cardinal.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.5.
    </div>
  </body>
</html>