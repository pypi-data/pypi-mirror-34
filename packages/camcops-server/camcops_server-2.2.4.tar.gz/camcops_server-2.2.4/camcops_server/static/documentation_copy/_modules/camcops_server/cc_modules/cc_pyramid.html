
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>camcops_server.cc_modules.cc_pyramid &#8212; CamCOPS 2.2.4 documentation</title>
    <link rel="stylesheet" href="../../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/css/camcops_docs.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">CamCOPS 2.2.4 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for camcops_server.cc_modules.cc_pyramid</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># camcops_server/cc_modules/cc_pyramid.py</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">===============================================================================</span>

<span class="sd">    Copyright (C) 2012-2018 Rudolf Cardinal (rudolf@pobox.com).</span>

<span class="sd">    This file is part of CamCOPS.</span>

<span class="sd">    CamCOPS is free software: you can redistribute it and/or modify</span>
<span class="sd">    it under the terms of the GNU General Public License as published by</span>
<span class="sd">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">    (at your option) any later version.</span>

<span class="sd">    CamCOPS is distributed in the hope that it will be useful,</span>
<span class="sd">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="sd">    GNU General Public License for more details.</span>

<span class="sd">    You should have received a copy of the GNU General Public License</span>
<span class="sd">    along with CamCOPS. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="sd">===============================================================================</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">enum</span> <span class="k">import</span> <span class="n">Enum</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span>
                    <span class="n">Type</span><span class="p">,</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Union</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="k">import</span> <span class="n">urlencode</span>

<span class="kn">from</span> <span class="nn">cardinal_pythonlib.logs</span> <span class="k">import</span> <span class="n">BraceStyleAdapter</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.wsgi.constants</span> <span class="k">import</span> <span class="n">WsgiEnvVar</span>
<span class="kn">from</span> <span class="nn">mako.lookup</span> <span class="k">import</span> <span class="n">TemplateLookup</span>
<span class="kn">from</span> <span class="nn">paginate</span> <span class="k">import</span> <span class="n">Page</span>
<span class="kn">from</span> <span class="nn">pyramid.authentication</span> <span class="k">import</span> <span class="n">IAuthenticationPolicy</span>
<span class="kn">from</span> <span class="nn">pyramid.authorization</span> <span class="k">import</span> <span class="n">IAuthorizationPolicy</span>
<span class="kn">from</span> <span class="nn">pyramid.config</span> <span class="k">import</span> <span class="n">Configurator</span>
<span class="kn">from</span> <span class="nn">pyramid.httpexceptions</span> <span class="k">import</span> <span class="n">HTTPFound</span>
<span class="kn">from</span> <span class="nn">pyramid.interfaces</span> <span class="k">import</span> <span class="n">ILocation</span><span class="p">,</span> <span class="n">ISession</span>
<span class="kn">from</span> <span class="nn">pyramid.request</span> <span class="k">import</span> <span class="n">Request</span>
<span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">Allowed</span><span class="p">,</span>
    <span class="n">Denied</span><span class="p">,</span>
    <span class="n">Authenticated</span><span class="p">,</span>
    <span class="n">Everyone</span><span class="p">,</span>
    <span class="n">PermitsResult</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">pyramid.session</span> <span class="k">import</span> <span class="n">SignedCookieSessionFactory</span>
<span class="kn">from</span> <span class="nn">pyramid_mako</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">MakoLookupTemplateRenderer</span><span class="p">,</span>
    <span class="n">MakoRendererFactory</span><span class="p">,</span>
    <span class="n">MakoRenderingException</span><span class="p">,</span>
    <span class="n">reraise</span><span class="p">,</span>
    <span class="n">text_error_template</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">Query</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.selectable</span> <span class="k">import</span> <span class="n">Select</span>
<span class="kn">from</span> <span class="nn">zope.interface</span> <span class="k">import</span> <span class="n">implementer</span>

<span class="kn">from</span> <span class="nn">.cc_baseconstants</span> <span class="k">import</span> <span class="n">TEMPLATE_DIR</span>
<span class="kn">from</span> <span class="nn">.cc_cache</span> <span class="k">import</span> <span class="n">cache_region_static</span>
<span class="kn">from</span> <span class="nn">.cc_constants</span> <span class="k">import</span> <span class="n">DEFAULT_ROWS_PER_PAGE</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.cc_request</span> <span class="k">import</span> <span class="n">CamcopsRequest</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">BraceStyleAdapter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">))</span>

<span class="c1"># =============================================================================</span>
<span class="c1"># Debugging options</span>
<span class="c1"># =============================================================================</span>

<span class="n">DEBUG_ADD_ROUTES</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">DEBUG_EFFECTIVE_PRINCIPALS</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">DEBUG_TEMPLATE_PARAMETERS</span> <span class="o">=</span> <span class="kc">False</span>
<span class="c1"># ... logs more information about template creation</span>
<span class="n">DEBUG_TEMPLATE_SOURCE</span> <span class="o">=</span> <span class="kc">False</span>
<span class="c1"># ... writes the templates in their compiled-to-Python version to a debugging</span>
<span class="c1">#     directory (see below), which is very informative.</span>
<span class="n">DEBUGGING_MAKO_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~/tmp/mako_template_source&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">DEBUG_ADD_ROUTES</span><span class="p">,</span>
        <span class="n">DEBUG_EFFECTIVE_PRINCIPALS</span><span class="p">,</span>
        <span class="n">DEBUG_TEMPLATE_PARAMETERS</span><span class="p">,</span>
        <span class="n">DEBUG_TEMPLATE_SOURCE</span><span class="p">]):</span>
    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Debugging options enabled!&quot;</span><span class="p">)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Constants</span>
<span class="c1"># =============================================================================</span>

<span class="n">COOKIE_NAME</span> <span class="o">=</span> <span class="s1">&#39;camcops&#39;</span>


<span class="k">class</span> <span class="nc">CookieKey</span><span class="p">:</span>
    <span class="n">SESSION_ID</span> <span class="o">=</span> <span class="s1">&#39;session_id&#39;</span>
    <span class="n">SESSION_TOKEN</span> <span class="o">=</span> <span class="s1">&#39;session_token&#39;</span>


<span class="k">class</span> <span class="nc">FormAction</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">CANCEL</span> <span class="o">=</span> <span class="s1">&#39;cancel&#39;</span>
    <span class="n">CLEAR_FILTERS</span> <span class="o">=</span> <span class="s1">&#39;clear_filters&#39;</span>
    <span class="n">DELETE</span> <span class="o">=</span> <span class="s1">&#39;delete&#39;</span>
    <span class="n">FINALIZE</span> <span class="o">=</span> <span class="s1">&#39;finalize&#39;</span>
    <span class="n">SET_FILTERS</span> <span class="o">=</span> <span class="s1">&#39;set_filters&#39;</span>
    <span class="n">SUBMIT</span> <span class="o">=</span> <span class="s1">&#39;submit&#39;</span>  <span class="c1"># the default for many forms</span>
    <span class="n">SUBMIT_TASKS_PER_PAGE</span> <span class="o">=</span> <span class="s1">&#39;submit_tpp&#39;</span>
    <span class="n">REFRESH_TASKS</span> <span class="o">=</span> <span class="s1">&#39;refresh_tasks&#39;</span>


<span class="k">class</span> <span class="nc">RequestMethod</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">GET</span> <span class="o">=</span> <span class="s2">&quot;GET&quot;</span>
    <span class="n">POST</span> <span class="o">=</span> <span class="s2">&quot;POST&quot;</span>


<div class="viewcode-block" id="ViewParam"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_pyramid.html#camcops_server.cc_modules.cc_pyramid.ViewParam">[docs]</a><span class="k">class</span> <span class="nc">ViewParam</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used in the following situations:</span>

<span class="sd">    - as parameter names for parameterized URLs, via RoutePath to Pyramid&#39;s</span>
<span class="sd">      route configuration, then fetched from the matchdict.</span>

<span class="sd">    - as form parameter names (often with some duplication as the attribute</span>
<span class="sd">      names of deform Form objects, because to avoid duplication would involve</span>
<span class="sd">      metaclass mess);</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># QUERY = &quot;_query&quot;  # built in to Pyramid</span>
    <span class="n">ADDRESS</span> <span class="o">=</span> <span class="s2">&quot;address&quot;</span>
    <span class="n">ADD_SPECIAL_NOTE</span> <span class="o">=</span> <span class="s2">&quot;add_special_note&quot;</span>
    <span class="n">ADMIN</span> <span class="o">=</span> <span class="s2">&quot;admin&quot;</span>
    <span class="n">AGE_MINIMUM</span> <span class="o">=</span> <span class="s2">&quot;age_minimum&quot;</span>
    <span class="n">AGE_MAXIMUM</span> <span class="o">=</span> <span class="s2">&quot;age_maximum&quot;</span>
    <span class="n">ALL_TASKS</span> <span class="o">=</span> <span class="s2">&quot;all_tasks&quot;</span>
    <span class="n">ANONYMISE</span> <span class="o">=</span> <span class="s2">&quot;anonymise&quot;</span>
    <span class="n">CSRF_TOKEN</span> <span class="o">=</span> <span class="s2">&quot;csrf&quot;</span>
    <span class="n">DATABASE_TITLE</span> <span class="o">=</span> <span class="s2">&quot;database_title&quot;</span>
    <span class="n">DIALECT</span> <span class="o">=</span> <span class="s2">&quot;dialect&quot;</span>
    <span class="n">DIAGNOSES_INCLUSION</span> <span class="o">=</span> <span class="s2">&quot;diagnoses_inclusion&quot;</span>
    <span class="n">DIAGNOSES_EXCLUSION</span> <span class="o">=</span> <span class="s2">&quot;diagnoses_exclusion&quot;</span>
    <span class="n">DESCRIPTION</span> <span class="o">=</span> <span class="s2">&quot;description&quot;</span>
    <span class="n">DEVICE_ID</span> <span class="o">=</span> <span class="s2">&quot;device_id&quot;</span>
    <span class="n">DEVICE_IDS</span> <span class="o">=</span> <span class="s2">&quot;device_ids&quot;</span>
    <span class="n">DUMP_METHOD</span> <span class="o">=</span> <span class="s2">&quot;dump_method&quot;</span>
    <span class="n">DOB</span> <span class="o">=</span> <span class="s2">&quot;dob&quot;</span>
    <span class="n">EMAIL</span> <span class="o">=</span> <span class="s2">&quot;email&quot;</span>
    <span class="n">END_DATETIME</span> <span class="o">=</span> <span class="s2">&quot;end_datetime&quot;</span>
    <span class="n">FILENAME</span> <span class="o">=</span> <span class="s2">&quot;filename&quot;</span>
    <span class="n">FINALIZE_POLICY</span> <span class="o">=</span> <span class="s2">&quot;finalize_policy&quot;</span>
    <span class="n">FORENAME</span> <span class="o">=</span> <span class="s2">&quot;forename&quot;</span>
    <span class="n">FULLNAME</span> <span class="o">=</span> <span class="s2">&quot;fullname&quot;</span>
    <span class="n">GP</span> <span class="o">=</span> <span class="s2">&quot;gp&quot;</span>
    <span class="n">GROUPADMIN</span> <span class="o">=</span> <span class="s2">&quot;groupadmin&quot;</span>
    <span class="n">GROUP_ID</span> <span class="o">=</span> <span class="s2">&quot;group_id&quot;</span>
    <span class="n">GROUP_IDS</span> <span class="o">=</span> <span class="s2">&quot;group_ids&quot;</span>
    <span class="n">HL7_ID_TYPE</span> <span class="o">=</span> <span class="s2">&quot;hl7_id_type&quot;</span>
    <span class="n">HL7_ASSIGNING_AUTHORITY</span> <span class="o">=</span> <span class="s2">&quot;hl7_assigning_authority&quot;</span>
    <span class="n">HL7_MSG_ID</span> <span class="o">=</span> <span class="s2">&quot;hl7_msg_id&quot;</span>
    <span class="n">HL7_RUN_ID</span> <span class="o">=</span> <span class="s2">&quot;hl7_run_id&quot;</span>
    <span class="n">ID_DEFINITIONS</span> <span class="o">=</span> <span class="s2">&quot;id_definitions&quot;</span>
    <span class="n">ID_REFERENCES</span> <span class="o">=</span> <span class="s2">&quot;id_references&quot;</span>
    <span class="n">IDNUM_VALUE</span> <span class="o">=</span> <span class="s2">&quot;idnum_value&quot;</span>
    <span class="n">INCLUDE_BLOBS</span> <span class="o">=</span> <span class="s2">&quot;include_blobs&quot;</span>
    <span class="n">INCLUDE_CALCULATED</span> <span class="o">=</span> <span class="s2">&quot;include_calculated&quot;</span>
    <span class="n">INCLUDE_COMMENTS</span> <span class="o">=</span> <span class="s2">&quot;include_comments&quot;</span>
    <span class="n">INCLUDE_PATIENT</span> <span class="o">=</span> <span class="s2">&quot;include_patient&quot;</span>
    <span class="n">MANUAL</span> <span class="o">=</span> <span class="s2">&quot;manual&quot;</span>
    <span class="n">MAY_ADD_NOTES</span> <span class="o">=</span> <span class="s2">&quot;may_add_notes&quot;</span>
    <span class="n">MAY_DUMP_DATA</span> <span class="o">=</span> <span class="s2">&quot;may_dump_data&quot;</span>
    <span class="n">MAY_REGISTER_DEVICES</span> <span class="o">=</span> <span class="s2">&quot;may_register_devices&quot;</span>
    <span class="n">MAY_RUN_REPORTS</span> <span class="o">=</span> <span class="s2">&quot;may_run_reports&quot;</span>
    <span class="n">MAY_UPLOAD</span> <span class="o">=</span> <span class="s2">&quot;may_upload&quot;</span>
    <span class="n">MAY_USE_WEBVIEWER</span> <span class="o">=</span> <span class="s2">&quot;may_use_webviewer&quot;</span>
    <span class="n">MUST_CHANGE_PASSWORD</span> <span class="o">=</span> <span class="s2">&quot;must_change_password&quot;</span>
    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;name&quot;</span>
    <span class="n">NOTE</span> <span class="o">=</span> <span class="s2">&quot;note&quot;</span>
    <span class="n">NEW_PASSWORD</span> <span class="o">=</span> <span class="s2">&quot;new_password&quot;</span>
    <span class="n">OLD_PASSWORD</span> <span class="o">=</span> <span class="s2">&quot;old_password&quot;</span>
    <span class="n">OTHER</span> <span class="o">=</span> <span class="s2">&quot;other&quot;</span>
    <span class="n">COMPLETE_ONLY</span> <span class="o">=</span> <span class="s2">&quot;complete_only&quot;</span>
    <span class="n">PAGE</span> <span class="o">=</span> <span class="s2">&quot;page&quot;</span>
    <span class="n">PASSWORD</span> <span class="o">=</span> <span class="s2">&quot;password&quot;</span>
    <span class="n">REDIRECT_URL</span> <span class="o">=</span> <span class="s2">&quot;redirect_url&quot;</span>
    <span class="n">REPORT_ID</span> <span class="o">=</span> <span class="s2">&quot;report_id&quot;</span>
    <span class="n">REMOTE_IP_ADDR</span> <span class="o">=</span> <span class="s2">&quot;remote_ip_addr&quot;</span>
    <span class="n">ROWS_PER_PAGE</span> <span class="o">=</span> <span class="s2">&quot;rows_per_page&quot;</span>
    <span class="n">SERVER_PK</span> <span class="o">=</span> <span class="s2">&quot;server_pk&quot;</span>
    <span class="n">SEX</span> <span class="o">=</span> <span class="s2">&quot;sex&quot;</span>
    <span class="n">SHORT_DESCRIPTION</span> <span class="o">=</span> <span class="s2">&quot;short_description&quot;</span>
    <span class="n">SORT</span> <span class="o">=</span> <span class="s2">&quot;sort&quot;</span>
    <span class="n">SOURCE</span> <span class="o">=</span> <span class="s2">&quot;source&quot;</span>
    <span class="n">SQLITE_METHOD</span> <span class="o">=</span> <span class="s2">&quot;sqlite_method&quot;</span>
    <span class="n">START_DATETIME</span> <span class="o">=</span> <span class="s2">&quot;start_datetime&quot;</span>
    <span class="n">SUPERUSER</span> <span class="o">=</span> <span class="s2">&quot;superuser&quot;</span>
    <span class="n">SURNAME</span> <span class="o">=</span> <span class="s2">&quot;surname&quot;</span>
    <span class="n">TABLE_NAME</span> <span class="o">=</span> <span class="s2">&quot;table_name&quot;</span>
    <span class="n">TASKS</span> <span class="o">=</span> <span class="s2">&quot;tasks&quot;</span>
    <span class="n">TEXT_CONTENTS</span> <span class="o">=</span> <span class="s2">&quot;text_contents&quot;</span>
    <span class="n">TRUNCATE</span> <span class="o">=</span> <span class="s2">&quot;truncate&quot;</span>
    <span class="n">UPLOAD_GROUP_ID</span> <span class="o">=</span> <span class="s2">&quot;upload_group_id&quot;</span>
    <span class="n">UPLOAD_POLICY</span> <span class="o">=</span> <span class="s2">&quot;upload_policy&quot;</span>
    <span class="n">USER_GROUP_MEMBERSHIP_ID</span> <span class="o">=</span> <span class="s2">&quot;user_group_membership_id&quot;</span>
    <span class="n">USER_ID</span> <span class="o">=</span> <span class="s2">&quot;user_id&quot;</span>
    <span class="n">USER_IDS</span> <span class="o">=</span> <span class="s2">&quot;user_ids&quot;</span>
    <span class="n">USERNAME</span> <span class="o">=</span> <span class="s2">&quot;username&quot;</span>
    <span class="n">VIEW_ALL_PATIENTS_WHEN_UNFILTERED</span> <span class="o">=</span> <span class="s2">&quot;view_all_patients_when_unfiltered&quot;</span>
    <span class="n">VIEWTYPE</span> <span class="o">=</span> <span class="s2">&quot;viewtype&quot;</span>
    <span class="n">WHICH_IDNUM</span> <span class="o">=</span> <span class="s2">&quot;which_idnum&quot;</span>
    <span class="n">WHAT</span> <span class="o">=</span> <span class="s2">&quot;what&quot;</span>
    <span class="n">WHEN</span> <span class="o">=</span> <span class="s2">&quot;when&quot;</span>
    <span class="n">WHO</span> <span class="o">=</span> <span class="s2">&quot;who&quot;</span></div>


<div class="viewcode-block" id="ViewArg"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_pyramid.html#camcops_server.cc_modules.cc_pyramid.ViewArg">[docs]</a><span class="k">class</span> <span class="nc">ViewArg</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    String used as view arguments, e.g.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">EVERYTHING</span> <span class="o">=</span> <span class="s2">&quot;everything&quot;</span>
    <span class="n">HTML</span> <span class="o">=</span> <span class="s2">&quot;html&quot;</span>
    <span class="n">PDF</span> <span class="o">=</span> <span class="s2">&quot;pdf&quot;</span>
    <span class="n">PDFHTML</span> <span class="o">=</span> <span class="s2">&quot;pdfhtml&quot;</span>
    <span class="n">SPECIFIC_TASKS_GROUPS</span> <span class="o">=</span> <span class="s2">&quot;specific_tasks_groups&quot;</span>
    <span class="n">SQL</span> <span class="o">=</span> <span class="s2">&quot;sql&quot;</span>
    <span class="n">SQLITE</span> <span class="o">=</span> <span class="s2">&quot;sqlite&quot;</span>
    <span class="n">TSV</span> <span class="o">=</span> <span class="s2">&quot;tsv&quot;</span>
    <span class="n">USE_SESSION_FILTER</span> <span class="o">=</span> <span class="s2">&quot;use_session_filter&quot;</span>
    <span class="n">XML</span> <span class="o">=</span> <span class="s2">&quot;xml&quot;</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Templates</span>
<span class="c1"># =============================================================================</span>
<span class="c1"># Adaptation of a small part of pyramid_mako, so we can use our own Mako</span>
<span class="c1"># TemplateLookup, and thus dogpile.cache. See</span>
<span class="c1"># https://github.com/Pylons/pyramid_mako/blob/master/pyramid_mako/__init__.py</span>

<span class="n">MAKO_LOOKUP</span> <span class="o">=</span> <span class="n">TemplateLookup</span><span class="p">(</span>
    <span class="n">directories</span><span class="o">=</span><span class="p">[</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TEMPLATE_DIR</span><span class="p">,</span> <span class="s2">&quot;base&quot;</span><span class="p">),</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TEMPLATE_DIR</span><span class="p">,</span> <span class="s2">&quot;css&quot;</span><span class="p">),</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TEMPLATE_DIR</span><span class="p">,</span> <span class="s2">&quot;menu&quot;</span><span class="p">),</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TEMPLATE_DIR</span><span class="p">,</span> <span class="s2">&quot;snippets&quot;</span><span class="p">),</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TEMPLATE_DIR</span><span class="p">,</span> <span class="s2">&quot;taskcommon&quot;</span><span class="p">),</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TEMPLATE_DIR</span><span class="p">,</span> <span class="s2">&quot;tasks&quot;</span><span class="p">),</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TEMPLATE_DIR</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">),</span>
    <span class="p">],</span>

    <span class="n">input_encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
    <span class="n">output_encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>

    <span class="n">module_directory</span><span class="o">=</span><span class="n">DEBUGGING_MAKO_DIR</span> <span class="k">if</span> <span class="n">DEBUG_TEMPLATE_SOURCE</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># TEMPLATE CACHING</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># http://dogpilecache.readthedocs.io/en/latest/api.html#module-dogpile.cache.plugins.mako_cache  # noqa</span>
    <span class="c1"># http://docs.makotemplates.org/en/latest/caching.html#cache-arguments</span>

    <span class="n">cache_impl</span><span class="o">=</span><span class="s2">&quot;dogpile.cache&quot;</span><span class="p">,</span>
    <span class="n">cache_args</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;regions&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;local&quot;</span><span class="p">:</span> <span class="n">cache_region_static</span><span class="p">},</span>
    <span class="p">},</span>

    <span class="c1"># Now, in Mako templates, use:</span>
    <span class="c1">#   cached=&quot;True&quot; cache_region=&quot;local&quot; cache_key=&quot;SOME_CACHE_KEY&quot;</span>
    <span class="c1"># on &lt;%page&gt;, &lt;%def&gt;, and &lt;%block&gt; regions.</span>
    <span class="c1"># It is VITAL that you specify &quot;name&quot;, and that it be appropriately</span>
    <span class="c1"># unique, or there&#39;ll be a cache conflict.</span>
    <span class="c1"># The easy way is:</span>
    <span class="c1">#   cached=&quot;True&quot; cache_region=&quot;local&quot; cache_key=&quot;${self.filename}&quot;</span>
    <span class="c1">#                                                 ^^^^^^^^^^^^^^^^</span>
    <span class="c1">#                                                   No!</span>
    <span class="c1"># ... with ${self.filename} you can get an inheritance deadlock:</span>
    <span class="c1"># See https://bitbucket.org/zzzeek/mako/issues/269/inheritance-related-cache-deadlock-when  # noqa</span>
    <span class="c1">#</span>
    <span class="c1"># HOWEVER, note also: it is the CONTENT that is cached. You can cause some</span>
    <span class="c1"># right disasters with this. Only stuff producing entirely STATIC content</span>
    <span class="c1"># should be cached. &quot;base.mako&quot; isn&#39;t static - it calls back to its</span>
    <span class="c1"># children; and if you cache it, one request produces results for an</span>
    <span class="c1"># entirely different request. Similarly for lots of other things like</span>
    <span class="c1"># &quot;task.mako&quot;.</span>
    <span class="c1"># SO, THERE IS NOT MUCH REASON HERE TO USE TEMPLATE CACHING.</span>
<span class="p">)</span>


<div class="viewcode-block" id="CamcopsMakoLookupTemplateRenderer"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_pyramid.html#camcops_server.cc_modules.cc_pyramid.CamcopsMakoLookupTemplateRenderer">[docs]</a><span class="k">class</span> <span class="nc">CamcopsMakoLookupTemplateRenderer</span><span class="p">(</span><span class="n">MakoLookupTemplateRenderer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    (a) load the Mako template</span>
<span class="sd">    (b) shove any other keys into its dictionary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">system</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">DEBUG_TEMPLATE_PARAMETERS</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;spec: </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;value: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;system: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">system</span><span class="p">))</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># RNC extra values:</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Note that &lt;%! ... %&gt; Python blocks are not themselves inherited.</span>
        <span class="c1"># So putting &quot;import&quot; calls in base.mako doesn&#39;t deliver the following</span>
        <span class="c1"># as ever-present variable. Instead, plumb them in like this:</span>
        <span class="c1">#</span>
        <span class="c1"># system[&#39;Routes&#39;] = Routes</span>
        <span class="c1"># system[&#39;ViewArg&#39;] = ViewArg</span>
        <span class="c1"># system[&#39;ViewParam&#39;] = ViewParam</span>
        <span class="c1">#</span>
        <span class="c1"># ... except that we&#39;re better off with an import in the template</span>

        <span class="c1"># Update the system dictionary with the values from the user</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">system</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;renderer was passed non-dictionary as value&#39;</span><span class="p">)</span>

        <span class="c1"># Check if &#39;context&#39; in the dictionary</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;context&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Rename &#39;context&#39; to &#39;_context&#39; because Mako internally already has a</span>
        <span class="c1"># variable named &#39;context&#39;</span>
        <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">system</span><span class="p">[</span><span class="s1">&#39;_context&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">context</span>

        <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">defname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">template</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">get_def</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defname</span><span class="p">)</span>
        <span class="c1"># noinspection PyBroadException</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">DEBUG_TEMPLATE_PARAMETERS</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;final dict to template: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">system</span><span class="p">))</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">render_unicode</span><span class="p">(</span><span class="o">**</span><span class="n">system</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">exc_info</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
                <span class="n">errtext</span> <span class="o">=</span> <span class="n">text_error_template</span><span class="p">()</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
                    <span class="n">error</span><span class="o">=</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">traceback</span><span class="o">=</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="n">reraise</span><span class="p">(</span><span class="n">MakoRenderingException</span><span class="p">(</span><span class="n">errtext</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="n">exc_info</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="c1"># noinspection PyUnboundLocalVariable</span>
                <span class="k">del</span> <span class="n">exc_info</span>

        <span class="c1"># noinspection PyUnboundLocalVariable</span>
        <span class="k">return</span> <span class="n">result</span></div>


<span class="k">class</span> <span class="nc">CamcopsMakoRendererFactory</span><span class="p">(</span><span class="n">MakoRendererFactory</span><span class="p">):</span>
    <span class="c1"># noinspection PyTypeChecker</span>
    <span class="n">renderer_factory</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">CamcopsMakoLookupTemplateRenderer</span><span class="p">)</span>


<div class="viewcode-block" id="camcops_add_mako_renderer"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_pyramid.html#camcops_server.cc_modules.cc_pyramid.camcops_add_mako_renderer">[docs]</a><span class="k">def</span> <span class="nf">camcops_add_mako_renderer</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">Configurator</span><span class="p">,</span> <span class="n">extension</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Replacement for add_mako_renderer from pyramid_mako, so we can use our own</span>
<span class="sd">    lookup.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">renderer_factory</span> <span class="o">=</span> <span class="n">CamcopsMakoRendererFactory</span><span class="p">()</span>
    <span class="n">renderer_factory</span><span class="o">.</span><span class="n">lookup</span> <span class="o">=</span> <span class="n">MAKO_LOOKUP</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_renderer</span><span class="p">(</span><span class="n">extension</span><span class="p">,</span> <span class="n">renderer_factory</span><span class="p">)</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># URL/route helpers</span>
<span class="c1"># =============================================================================</span>

<span class="n">RE_VALID_REPLACEMENT_MARKER</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;^[a-zA-Z_][a-zA-Z0-9_]*$&quot;</span><span class="p">)</span>
<span class="c1"># All characters must be a-z, A-Z, _, or 0-9.</span>
<span class="c1"># First character must not be a digit.</span>
<span class="c1"># https://docs.pylonsproject.org/projects/pyramid/en/latest/narr/urldispatch.html#route-pattern-syntax  # noqa</span>


<span class="k">def</span> <span class="nf">valid_replacement_marker</span><span class="p">(</span><span class="n">marker</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">RE_VALID_REPLACEMENT_MARKER</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">marker</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>


<div class="viewcode-block" id="UrlParamType"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_pyramid.html#camcops_server.cc_modules.cc_pyramid.UrlParamType">[docs]</a><span class="k">class</span> <span class="nc">UrlParamType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">STRING</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">POSITIVE_INTEGER</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">PLAIN_STRING</span> <span class="o">=</span> <span class="mi">3</span></div>


<span class="k">class</span> <span class="nc">UrlParam</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">paramtype</span><span class="p">:</span> <span class="n">UrlParamType</span> <span class="o">==</span> <span class="n">UrlParamType</span><span class="o">.</span><span class="n">PLAIN_STRING</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paramtype</span> <span class="o">=</span> <span class="n">paramtype</span>
        <span class="k">assert</span> <span class="n">valid_replacement_marker</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="p">(</span>
            <span class="s2">&quot;UrlParam: invalid replacement marker: &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">regex</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">paramtype</span> <span class="o">==</span> <span class="n">UrlParamType</span><span class="o">.</span><span class="n">STRING</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">paramtype</span> <span class="o">==</span> <span class="n">UrlParamType</span><span class="o">.</span><span class="n">POSITIVE_INTEGER</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">r</span><span class="s1">&#39;\d+&#39;</span>  <span class="c1"># digits</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">paramtype</span> <span class="o">==</span> <span class="n">UrlParamType</span><span class="o">.</span><span class="n">PLAIN_STRING</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">r</span><span class="s1">&#39;[a-zA-Z0-9_]+&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Bug in UrlParam&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">markerdef</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regex</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">marker</span> <span class="o">+=</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">r</span>
        <span class="k">return</span> <span class="s1">&#39;{&#39;</span> <span class="o">+</span> <span class="n">marker</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span>


<span class="k">def</span> <span class="nf">make_url_path</span><span class="p">(</span><span class="n">base</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">UrlParam</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[str]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">base</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
        <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="n">parts</span> <span class="o">+=</span> <span class="p">[</span><span class="n">base</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">arg</span><span class="o">.</span><span class="n">markerdef</span><span class="p">()</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
    <span class="k">return</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Routes</span>
<span class="c1"># =============================================================================</span>

<span class="c1"># Class to collect constants together</span>
<span class="c1"># See also http://xion.io/post/code/python-enums-are-ok.html</span>
<div class="viewcode-block" id="Routes"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_pyramid.html#camcops_server.cc_modules.cc_pyramid.Routes">[docs]</a><span class="k">class</span> <span class="nc">Routes</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Names of Pyramid routes.</span>

<span class="sd">    - Used by the @view_config(route_name=...) decorator.</span>
<span class="sd">    - Configured via RouteCollection / RoutePath to the Pyramid route</span>
<span class="sd">      configurator.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Hard-coded special paths</span>
    <span class="n">STATIC</span> <span class="o">=</span> <span class="s2">&quot;static&quot;</span>

    <span class="c1"># Implemented</span>
    <span class="n">ADD_GROUP</span> <span class="o">=</span> <span class="s2">&quot;add_group&quot;</span>
    <span class="n">ADD_ID_DEFINITION</span> <span class="o">=</span> <span class="s2">&quot;add_id_definition&quot;</span>
    <span class="n">ADD_SPECIAL_NOTE</span> <span class="o">=</span> <span class="s2">&quot;add_special_note&quot;</span>
    <span class="n">ADD_USER</span> <span class="o">=</span> <span class="s2">&quot;add_user&quot;</span>
    <span class="n">BUGFIX_DEFORM_MISSING_GLYPHS</span> <span class="o">=</span> <span class="s2">&quot;bugfix_deform_missing_glyphs&quot;</span>
    <span class="c1"># ... test by visiting the Task Filters page</span>
    <span class="n">CHANGE_OWN_PASSWORD</span> <span class="o">=</span> <span class="s2">&quot;change_own_password&quot;</span>
    <span class="n">CHANGE_OTHER_PASSWORD</span> <span class="o">=</span> <span class="s2">&quot;change_other_password&quot;</span>
    <span class="n">CHOOSE_CTV</span> <span class="o">=</span> <span class="s2">&quot;choose_ctv&quot;</span>
    <span class="n">CHOOSE_TRACKER</span> <span class="o">=</span> <span class="s2">&quot;choose_tracker&quot;</span>
    <span class="n">CLIENT_API</span> <span class="o">=</span> <span class="s2">&quot;client_api&quot;</span>
    <span class="n">CRASH</span> <span class="o">=</span> <span class="s2">&quot;crash&quot;</span>
    <span class="n">CTV</span> <span class="o">=</span> <span class="s2">&quot;ctv&quot;</span>
    <span class="n">DELETE_GROUP</span> <span class="o">=</span> <span class="s2">&quot;delete_group&quot;</span>
    <span class="n">DELETE_ID_DEFINITION</span> <span class="o">=</span> <span class="s2">&quot;delete_id_definition&quot;</span>
    <span class="n">DELETE_PATIENT</span> <span class="o">=</span> <span class="s2">&quot;delete_patient&quot;</span>
    <span class="n">DELETE_USER</span> <span class="o">=</span> <span class="s2">&quot;delete_user&quot;</span>
    <span class="n">DEVELOPER</span> <span class="o">=</span> <span class="s2">&quot;developer&quot;</span>
    <span class="n">EDIT_GROUP</span> <span class="o">=</span> <span class="s2">&quot;edit_group&quot;</span>
    <span class="n">EDIT_ID_DEFINITION</span> <span class="o">=</span> <span class="s2">&quot;edit_id_definition&quot;</span>
    <span class="n">EDIT_PATIENT</span> <span class="o">=</span> <span class="s2">&quot;edit_patient&quot;</span>
    <span class="n">EDIT_SERVER_SETTINGS</span> <span class="o">=</span> <span class="s2">&quot;edit_server_settings&quot;</span>
    <span class="n">EDIT_USER</span> <span class="o">=</span> <span class="s2">&quot;edit_user&quot;</span>
    <span class="n">EDIT_USER_GROUP_MEMBERSHIP</span> <span class="o">=</span> <span class="s2">&quot;edit_user_group_membership&quot;</span>
    <span class="n">ERASE_TASK</span> <span class="o">=</span> <span class="s2">&quot;erase_task&quot;</span>
    <span class="n">FORCIBLY_FINALIZE</span> <span class="o">=</span> <span class="s2">&quot;forcibly_finalize&quot;</span>
    <span class="n">HOME</span> <span class="o">=</span> <span class="s2">&quot;home&quot;</span>
    <span class="n">INTROSPECT</span> <span class="o">=</span> <span class="s2">&quot;introspect&quot;</span>
    <span class="n">LOGIN</span> <span class="o">=</span> <span class="s2">&quot;login&quot;</span>
    <span class="n">LOGOUT</span> <span class="o">=</span> <span class="s2">&quot;logout&quot;</span>
    <span class="n">OFFER_AUDIT_TRAIL</span> <span class="o">=</span> <span class="s2">&quot;offer_audit_trail&quot;</span>
    <span class="n">OFFER_HL7_MESSAGE_LOG</span> <span class="o">=</span> <span class="s2">&quot;offer_hl7_message_log&quot;</span>
    <span class="n">OFFER_HL7_RUN_LOG</span> <span class="o">=</span> <span class="s2">&quot;offer_hl7_run_log&quot;</span>
    <span class="n">OFFER_INTROSPECTION</span> <span class="o">=</span> <span class="s2">&quot;offer_introspect&quot;</span>
    <span class="n">OFFER_REGENERATE_SUMMARIES</span> <span class="o">=</span> <span class="s2">&quot;offer_regenerate_summary_tables&quot;</span>
    <span class="n">OFFER_REPORT</span> <span class="o">=</span> <span class="s2">&quot;offer_report&quot;</span>
    <span class="n">OFFER_SQL_DUMP</span> <span class="o">=</span> <span class="s2">&quot;offer_sql_dump&quot;</span>
    <span class="n">OFFER_TERMS</span> <span class="o">=</span> <span class="s2">&quot;offer_terms&quot;</span>
    <span class="n">OFFER_TSV_DUMP</span> <span class="o">=</span> <span class="s2">&quot;offer_tsv_dump&quot;</span>
    <span class="n">REPORT</span> <span class="o">=</span> <span class="s2">&quot;report&quot;</span>
    <span class="n">REPORTS_MENU</span> <span class="o">=</span> <span class="s2">&quot;reports_menu&quot;</span>
    <span class="n">SET_FILTERS</span> <span class="o">=</span> <span class="s2">&quot;set_filters&quot;</span>
    <span class="n">SET_OWN_USER_UPLOAD_GROUP</span> <span class="o">=</span> <span class="s2">&quot;set_user_upload_group&quot;</span>
    <span class="n">SET_OTHER_USER_UPLOAD_GROUP</span> <span class="o">=</span> <span class="s2">&quot;set_other_user_upload_group&quot;</span>
    <span class="n">SQL_DUMP</span> <span class="o">=</span> <span class="s2">&quot;sql_dump&quot;</span>
    <span class="n">TASK</span> <span class="o">=</span> <span class="s2">&quot;task&quot;</span>
    <span class="n">TESTPAGE_PRIVATE_1</span> <span class="o">=</span> <span class="s2">&quot;testpage_private_1&quot;</span>
    <span class="n">TESTPAGE_PRIVATE_2</span> <span class="o">=</span> <span class="s2">&quot;testpage_private_2&quot;</span>
    <span class="n">TESTPAGE_PRIVATE_3</span> <span class="o">=</span> <span class="s2">&quot;testpage_private_3&quot;</span>
    <span class="n">TESTPAGE_PUBLIC_1</span> <span class="o">=</span> <span class="s2">&quot;testpage_public_1&quot;</span>
    <span class="n">TRACKER</span> <span class="o">=</span> <span class="s2">&quot;tracker&quot;</span>
    <span class="n">TSV_DUMP</span> <span class="o">=</span> <span class="s2">&quot;tsv_dump&quot;</span>
    <span class="n">UNLOCK_USER</span> <span class="o">=</span> <span class="s2">&quot;unlock_user&quot;</span>
    <span class="n">VIEW_OWN_USER_INFO</span> <span class="o">=</span> <span class="s2">&quot;view_own_user_info&quot;</span>
    <span class="n">VIEW_DDL</span> <span class="o">=</span> <span class="s2">&quot;inspect_ddl&quot;</span>
    <span class="n">VIEW_ALL_USERS</span> <span class="o">=</span> <span class="s2">&quot;view_all_users&quot;</span>
    <span class="n">VIEW_AUDIT_TRAIL</span> <span class="o">=</span> <span class="s2">&quot;view_audit_trail&quot;</span>
    <span class="n">VIEW_GROUPS</span> <span class="o">=</span> <span class="s2">&quot;view_groups&quot;</span>
    <span class="n">VIEW_HL7_MESSAGE</span> <span class="o">=</span> <span class="s2">&quot;view_hl7_message&quot;</span>
    <span class="n">VIEW_HL7_MESSAGE_LOG</span> <span class="o">=</span> <span class="s2">&quot;view_hl7_message_log&quot;</span>
    <span class="n">VIEW_HL7_RUN</span> <span class="o">=</span> <span class="s2">&quot;view_hl7_run&quot;</span>
    <span class="n">VIEW_HL7_RUN_LOG</span> <span class="o">=</span> <span class="s2">&quot;view_hl7_run_log&quot;</span>
    <span class="n">VIEW_ID_DEFINITIONS</span> <span class="o">=</span> <span class="s2">&quot;view_id_definitions&quot;</span>
    <span class="n">VIEW_USER</span> <span class="o">=</span> <span class="s2">&quot;view_user&quot;</span>
    <span class="n">VIEW_SERVER_INFO</span> <span class="o">=</span> <span class="s2">&quot;view_server_info&quot;</span>
    <span class="n">VIEW_TASKS</span> <span class="o">=</span> <span class="s2">&quot;view_tasks&quot;</span></div>


<div class="viewcode-block" id="RoutePath"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_pyramid.html#camcops_server.cc_modules.cc_pyramid.RoutePath">[docs]</a><span class="k">class</span> <span class="nc">RoutePath</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to hold a route/path pair.</span>

<span class="sd">    - Pyramid route names are just strings used internally for convenience.</span>
<span class="sd">    - Pyramid URL paths are URL fragments, like &#39;/thing&#39;, and can contain</span>
<span class="sd">      placeholders, like &#39;/thing/{bork_id}&#39;, which will result in the</span>
<span class="sd">      request.matchdict object containing a &#39;bork_id&#39; key. Those can be</span>
<span class="sd">      further constrained by regular expressions, like &#39;/thing/{bork_id:\d+}&#39;</span>
<span class="sd">      to restrict to digits.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">route</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">ignore_in_all_routes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">route</span> <span class="o">=</span> <span class="n">route</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_in_all_routes</span> <span class="o">=</span> <span class="n">ignore_in_all_routes</span></div>


<span class="n">MASTER_ROUTE_WEBVIEW</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span>
<span class="n">MASTER_ROUTE_CLIENT_API</span> <span class="o">=</span> <span class="s2">&quot;/database&quot;</span>
<span class="n">STATIC_CAMCOPS_PACKAGE_PATH</span> <span class="o">=</span> <span class="s2">&quot;camcops_server.static:&quot;</span>
<span class="c1"># ... the &quot;static&quot; package (directory with __init__.py) within the</span>
<span class="c1"># &quot;camcops_server&quot; owning package</span>


<div class="viewcode-block" id="RouteCollection"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_pyramid.html#camcops_server.cc_modules.cc_pyramid.RouteCollection">[docs]</a><span class="k">class</span> <span class="nc">RouteCollection</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    All routes, with their paths, for CamCOPS.</span>
<span class="sd">    They will be auto-read by all_routes().</span>

<span class="sd">    To make a URL on the fly, use Request.route_url() or</span>
<span class="sd">    CamcopsRequest.route_url_params().</span>

<span class="sd">    To associate a view with a route, use the Pyramid @view_config decorator.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Hard-coded special paths</span>
    <span class="n">DEBUG_TOOLBAR</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="s1">&#39;debug_toolbar&#39;</span><span class="p">,</span> <span class="s1">&#39;/_debug_toolbar/&#39;</span><span class="p">,</span>
                              <span class="n">ignore_in_all_routes</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># hard-coded path</span>
    <span class="n">STATIC</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">STATIC</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>  <span class="c1"># path ignored</span>
                       <span class="n">ignore_in_all_routes</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Implemented</span>
    <span class="n">ADD_GROUP</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">ADD_GROUP</span><span class="p">,</span> <span class="s2">&quot;/add_group&quot;</span><span class="p">)</span>
    <span class="n">ADD_ID_DEFINITION</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">ADD_ID_DEFINITION</span><span class="p">,</span>
                                  <span class="s2">&quot;/add_id_definition&quot;</span><span class="p">)</span>
    <span class="n">ADD_SPECIAL_NOTE</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">ADD_SPECIAL_NOTE</span><span class="p">,</span> <span class="s2">&quot;/add_special_note&quot;</span><span class="p">)</span>
    <span class="n">ADD_USER</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">ADD_USER</span><span class="p">,</span> <span class="s2">&quot;/add_user&quot;</span><span class="p">)</span>
    <span class="n">TSV_DUMP</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">TSV_DUMP</span><span class="p">,</span> <span class="s2">&quot;/tsv_dump&quot;</span><span class="p">)</span>
    <span class="n">BUGFIX_DEFORM_MISSING_GLYPHS</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span>
        <span class="n">Routes</span><span class="o">.</span><span class="n">BUGFIX_DEFORM_MISSING_GLYPHS</span><span class="p">,</span>
        <span class="s2">&quot;/deform_static/fonts/glyphicons-halflings-regular.woff2&quot;</span>
    <span class="p">)</span>
    <span class="n">CHANGE_OWN_PASSWORD</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">CHANGE_OWN_PASSWORD</span><span class="p">,</span>
                                    <span class="s1">&#39;/change_own_password&#39;</span><span class="p">)</span>
    <span class="n">CHANGE_OTHER_PASSWORD</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span>
        <span class="n">Routes</span><span class="o">.</span><span class="n">CHANGE_OTHER_PASSWORD</span><span class="p">,</span>
        <span class="s2">&quot;/change_other_password&quot;</span>
        <span class="c1"># make_url_path(</span>
        <span class="c1">#     &quot;/change_other_password&quot;,</span>
        <span class="c1">#     UrlParam(ViewParam.USER_ID, UrlParamType.POSITIVE_INTEGER)</span>
        <span class="c1"># )</span>
    <span class="p">)</span>
    <span class="n">CHOOSE_CTV</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">CHOOSE_CTV</span><span class="p">,</span> <span class="s2">&quot;/choose_clinicaltextview&quot;</span><span class="p">)</span>
    <span class="n">CHOOSE_TRACKER</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">CHOOSE_TRACKER</span><span class="p">,</span> <span class="s2">&quot;/choose_tracker&quot;</span><span class="p">)</span>
    <span class="n">CRASH</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">CRASH</span><span class="p">,</span> <span class="s2">&quot;/crash&quot;</span><span class="p">)</span>
    <span class="n">CTV</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">CTV</span><span class="p">,</span> <span class="s2">&quot;/ctv&quot;</span><span class="p">)</span>
    <span class="n">CLIENT_API</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">CLIENT_API</span><span class="p">,</span> <span class="n">MASTER_ROUTE_CLIENT_API</span><span class="p">)</span>
    <span class="n">DELETE_GROUP</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">DELETE_GROUP</span><span class="p">,</span> <span class="s2">&quot;/delete_group&quot;</span><span class="p">)</span>
    <span class="n">DELETE_ID_DEFINITION</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">DELETE_ID_DEFINITION</span><span class="p">,</span>
                                     <span class="s2">&quot;/delete_id_definition&quot;</span><span class="p">)</span>
    <span class="n">DELETE_PATIENT</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">DELETE_PATIENT</span><span class="p">,</span> <span class="s2">&quot;/delete_patient&quot;</span><span class="p">)</span>
    <span class="n">DELETE_USER</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">DELETE_USER</span><span class="p">,</span> <span class="s2">&quot;/delete_user&quot;</span><span class="p">)</span>
    <span class="n">DEVELOPER</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">DEVELOPER</span><span class="p">,</span> <span class="s2">&quot;/developer&quot;</span><span class="p">)</span>
    <span class="n">EDIT_GROUP</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">EDIT_GROUP</span><span class="p">,</span> <span class="s2">&quot;/edit_group&quot;</span><span class="p">)</span>
    <span class="n">EDIT_ID_DEFINITION</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">EDIT_ID_DEFINITION</span><span class="p">,</span>
                                   <span class="s1">&#39;/edit_id_definitions&#39;</span><span class="p">)</span>
    <span class="n">EDIT_PATIENT</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">EDIT_PATIENT</span><span class="p">,</span> <span class="s1">&#39;/edit_patient&#39;</span><span class="p">)</span>
    <span class="n">EDIT_SERVER_SETTINGS</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">EDIT_SERVER_SETTINGS</span><span class="p">,</span>
                                     <span class="s1">&#39;/edit_server_settings&#39;</span><span class="p">)</span>
    <span class="n">EDIT_USER</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">EDIT_USER</span><span class="p">,</span> <span class="s2">&quot;/edit_user&quot;</span><span class="p">)</span>
    <span class="n">EDIT_USER_GROUP_MEMBERSHIP</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">EDIT_USER_GROUP_MEMBERSHIP</span><span class="p">,</span>
                                           <span class="s2">&quot;/edit_user_group_membership&quot;</span><span class="p">)</span>
    <span class="n">ERASE_TASK</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">ERASE_TASK</span><span class="p">,</span> <span class="s2">&quot;/erase_task&quot;</span><span class="p">)</span>
    <span class="n">FORCIBLY_FINALIZE</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span>
        <span class="n">Routes</span><span class="o">.</span><span class="n">FORCIBLY_FINALIZE</span><span class="p">,</span> <span class="s2">&quot;/forcibly_finalize&quot;</span>
    <span class="p">)</span>
    <span class="n">HOME</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">HOME</span><span class="p">,</span> <span class="n">MASTER_ROUTE_WEBVIEW</span><span class="p">)</span>
    <span class="n">INTROSPECT</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">INTROSPECT</span><span class="p">,</span> <span class="s1">&#39;/introspect&#39;</span><span class="p">)</span>
    <span class="c1"># ... filename via query param (sorts out escaping)</span>
    <span class="n">LOGIN</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">LOGIN</span><span class="p">,</span> <span class="s2">&quot;/login&quot;</span><span class="p">)</span>
    <span class="n">LOGOUT</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">LOGOUT</span><span class="p">,</span> <span class="s2">&quot;/logout&quot;</span><span class="p">)</span>
    <span class="n">OFFER_AUDIT_TRAIL</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">OFFER_AUDIT_TRAIL</span><span class="p">,</span>
                                  <span class="s2">&quot;/offer_audit_trail&quot;</span><span class="p">)</span>
    <span class="n">OFFER_HL7_MESSAGE_LOG</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">OFFER_HL7_MESSAGE_LOG</span><span class="p">,</span>
                                      <span class="s2">&quot;/offer_hl7_message_log&quot;</span><span class="p">)</span>
    <span class="n">OFFER_HL7_RUN_LOG</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">OFFER_HL7_RUN_LOG</span><span class="p">,</span>
                                  <span class="s2">&quot;/offer_hl7_run_log&quot;</span><span class="p">)</span>
    <span class="n">OFFER_INTROSPECTION</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">OFFER_INTROSPECTION</span><span class="p">,</span>
                                    <span class="s2">&quot;/offer_introspect&quot;</span><span class="p">)</span>
    <span class="n">OFFER_REPORT</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">OFFER_REPORT</span><span class="p">,</span> <span class="s1">&#39;/offer_report&#39;</span><span class="p">)</span>
    <span class="n">OFFER_SQL_DUMP</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">OFFER_SQL_DUMP</span><span class="p">,</span> <span class="s2">&quot;/offer_sql_dump&quot;</span><span class="p">)</span>
    <span class="n">OFFER_TERMS</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">OFFER_TERMS</span><span class="p">,</span> <span class="s1">&#39;/offer_terms&#39;</span><span class="p">)</span>
    <span class="n">OFFER_TSV_DUMP</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">OFFER_TSV_DUMP</span><span class="p">,</span> <span class="s2">&quot;/offer_tsv_dump&quot;</span><span class="p">)</span>
    <span class="n">REPORT</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">REPORT</span><span class="p">,</span> <span class="s1">&#39;/report&#39;</span><span class="p">)</span>
    <span class="n">REPORTS_MENU</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">REPORTS_MENU</span><span class="p">,</span> <span class="s2">&quot;/reports_menu&quot;</span><span class="p">)</span>
    <span class="n">SET_FILTERS</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">SET_FILTERS</span><span class="p">,</span> <span class="s1">&#39;/set_filters&#39;</span><span class="p">)</span>
    <span class="n">SET_OWN_USER_UPLOAD_GROUP</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">SET_OWN_USER_UPLOAD_GROUP</span><span class="p">,</span>
                                          <span class="s1">&#39;/set_user_upload_group&#39;</span><span class="p">)</span>
    <span class="n">SET_OTHER_USER_UPLOAD_GROUP</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">SET_OTHER_USER_UPLOAD_GROUP</span><span class="p">,</span>
                                            <span class="s1">&#39;/set_other_user_upload_group&#39;</span><span class="p">)</span>
    <span class="n">SQL_DUMP</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">SQL_DUMP</span><span class="p">,</span> <span class="s1">&#39;/sql_dump&#39;</span><span class="p">)</span>
    <span class="n">TASK</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">TASK</span><span class="p">,</span> <span class="s2">&quot;/task&quot;</span><span class="p">)</span>
    <span class="n">TESTPAGE_PRIVATE_1</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">TESTPAGE_PRIVATE_1</span><span class="p">,</span> <span class="s1">&#39;/testpriv1&#39;</span><span class="p">)</span>
    <span class="n">TESTPAGE_PRIVATE_2</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">TESTPAGE_PRIVATE_2</span><span class="p">,</span> <span class="s1">&#39;/testpriv2&#39;</span><span class="p">)</span>
    <span class="n">TESTPAGE_PRIVATE_3</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">TESTPAGE_PRIVATE_3</span><span class="p">,</span> <span class="s1">&#39;/testpriv3&#39;</span><span class="p">)</span>
    <span class="n">TESTPAGE_PUBLIC_1</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">TESTPAGE_PUBLIC_1</span><span class="p">,</span> <span class="s1">&#39;/test1&#39;</span><span class="p">)</span>
    <span class="n">TRACKER</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">TRACKER</span><span class="p">,</span> <span class="s2">&quot;/tracker&quot;</span><span class="p">)</span>
    <span class="n">UNLOCK_USER</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">UNLOCK_USER</span><span class="p">,</span> <span class="s2">&quot;/unlock_user&quot;</span><span class="p">)</span>
    <span class="n">VIEW_ALL_USERS</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_ALL_USERS</span><span class="p">,</span> <span class="s2">&quot;/view_all_users&quot;</span><span class="p">)</span>
    <span class="n">VIEW_AUDIT_TRAIL</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_AUDIT_TRAIL</span><span class="p">,</span> <span class="s2">&quot;/view_audit_trail&quot;</span><span class="p">)</span>
    <span class="n">VIEW_DDL</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_DDL</span><span class="p">,</span> <span class="s2">&quot;/view_ddl&quot;</span><span class="p">)</span>
    <span class="n">VIEW_GROUPS</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_GROUPS</span><span class="p">,</span> <span class="s2">&quot;/view_groups&quot;</span><span class="p">)</span>
    <span class="n">VIEW_HL7_MESSAGE</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_HL7_MESSAGE</span><span class="p">,</span> <span class="s2">&quot;/view_hl7_message&quot;</span><span class="p">)</span>
    <span class="n">VIEW_HL7_MESSAGE_LOG</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_HL7_MESSAGE_LOG</span><span class="p">,</span>
                                     <span class="s2">&quot;/view_hl7_message_log&quot;</span><span class="p">)</span>
    <span class="n">VIEW_HL7_RUN</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_HL7_RUN</span><span class="p">,</span> <span class="s2">&quot;/view_hl7_run&quot;</span><span class="p">)</span>
    <span class="n">VIEW_HL7_RUN_LOG</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_HL7_RUN_LOG</span><span class="p">,</span>
                                 <span class="s2">&quot;/view_hl7_run_log&quot;</span><span class="p">)</span>
    <span class="n">VIEW_ID_DEFINITIONS</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_ID_DEFINITIONS</span><span class="p">,</span>
                                    <span class="s2">&quot;/view_id_definitions&quot;</span><span class="p">)</span>
    <span class="n">VIEW_OWN_USER_INFO</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_OWN_USER_INFO</span><span class="p">,</span>
                                   <span class="s2">&quot;/view_own_user_info&quot;</span><span class="p">)</span>
    <span class="n">VIEW_SERVER_INFO</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_SERVER_INFO</span><span class="p">,</span> <span class="s2">&quot;/view_server_info&quot;</span><span class="p">)</span>
    <span class="n">VIEW_TASKS</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_TASKS</span><span class="p">,</span> <span class="s2">&quot;/view_tasks&quot;</span><span class="p">)</span>
    <span class="n">VIEW_USER</span> <span class="o">=</span> <span class="n">RoutePath</span><span class="p">(</span><span class="n">Routes</span><span class="o">.</span><span class="n">VIEW_USER</span><span class="p">,</span> <span class="s2">&quot;/view_user&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="RouteCollection.all_routes"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_pyramid.html#camcops_server.cc_modules.cc_pyramid.RouteCollection.all_routes">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">all_routes</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">RoutePath</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fetch all routes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="ow">or</span>  <span class="c1"># class hidden things</span>
                        <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;all_routes&#39;</span> <span class="ow">or</span>  <span class="c1"># this function</span>
                        <span class="n">v</span><span class="o">.</span><span class="n">ignore_in_all_routes</span><span class="p">)</span>  <span class="c1"># explicitly ignored</span>
                <span class="p">]</span></div></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Pyramid HTTP session handling</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="get_session_factory"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_pyramid.html#camcops_server.cc_modules.cc_pyramid.get_session_factory">[docs]</a><span class="k">def</span> <span class="nf">get_session_factory</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">SignedCookieSessionFactory</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    We have to give a Pyramid request a way of making an HTTP session.</span>
<span class="sd">    We must return a session factory.</span>
<span class="sd">    </span>
<span class="sd">    - An example is an instance of SignedCookieSessionFactory().</span>
<span class="sd">    - A session factory has the signature [1]:</span>
<span class="sd">    </span>
<span class="sd">      .. code-block:: none</span>
<span class="sd">      </span>
<span class="sd">            sessionfactory(req: CamcopsRequest) -&gt; session_object</span>

<span class="sd">      ... where session &quot;is a namespace&quot; [2]</span>
<span class="sd">      ... but more concretely, &quot;implements the pyramid.interfaces.ISession </span>
<span class="sd">      interface&quot;</span>

<span class="sd">    - We want to be able to make the session by reading the CamcopsConfig from</span>
<span class="sd">      the request.</span>

<span class="sd">    [1] https://docs.pylonsproject.org/projects/pyramid/en/latest/glossary.html#term-session-factory</span>
<span class="sd">    </span>
<span class="sd">    [2] https://docs.pylonsproject.org/projects/pyramid/en/latest/glossary.html#term-session</span>
<span class="sd">    &quot;&quot;&quot;</span>  <span class="c1"># noqa</span>
    <span class="k">def</span> <span class="nf">factory</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="s2">&quot;CamcopsRequest&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ISession</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        How does the session write the cookies to the response?</span>

<span class="sd">            SignedCookieSessionFactory</span>
<span class="sd">                BaseCookieSessionFactory  # pyramid/session.py</span>
<span class="sd">                    CookieSession</span>
<span class="sd">                        def changed():</span>
<span class="sd">                            if not self._dirty:</span>
<span class="sd">                                self._dirty = True</span>
<span class="sd">                                def set_cookie_callback(request, response):</span>
<span class="sd">                                    self._set_cookie(response)</span>
<span class="sd">                                    # ...</span>
<span class="sd">                                self.request.add_response_callback(set_cookie_callback)  # noqa</span>

<span class="sd">                        def _set_cookie(self, response):</span>
<span class="sd">                            # ...</span>
<span class="sd">                            response.set_cookie(...)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">config</span>
        <span class="n">secure_cookies</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">cfg</span><span class="o">.</span><span class="n">allow_insecure_cookies</span>
        <span class="n">pyramid_factory</span> <span class="o">=</span> <span class="n">SignedCookieSessionFactory</span><span class="p">(</span>
            <span class="n">secret</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">session_cookie_secret</span><span class="p">,</span>
            <span class="n">hashalg</span><span class="o">=</span><span class="s1">&#39;sha512&#39;</span><span class="p">,</span>  <span class="c1"># the default</span>
            <span class="n">salt</span><span class="o">=</span><span class="s1">&#39;camcops_pyramid_session.&#39;</span><span class="p">,</span>
            <span class="n">cookie_name</span><span class="o">=</span><span class="n">COOKIE_NAME</span><span class="p">,</span>
            <span class="n">max_age</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># browser scope; session cookie</span>
            <span class="n">path</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">,</span>  <span class="c1"># the default</span>
            <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># the default</span>
            <span class="n">secure</span><span class="o">=</span><span class="n">secure_cookies</span><span class="p">,</span>
            <span class="n">httponly</span><span class="o">=</span><span class="n">secure_cookies</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># we handle timeouts at the database level instead</span>
            <span class="n">reissue_time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># default; reissue cookie at every request</span>
            <span class="n">set_on_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># (default) cookie even if exception raised</span>
            <span class="n">serializer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># (default) use pyramid.session.PickleSerializer</span>
            <span class="c1"># As max_age and expires are left at their default of None, these</span>
            <span class="c1"># are session cookies.</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">pyramid_factory</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">factory</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Authentication; authorization (permissions)</span>
<span class="c1"># =============================================================================</span>

<span class="k">class</span> <span class="nc">Permission</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># Permissions are strings.</span>
    <span class="c1"># For &quot;logged in&quot;, use pyramid.security.Authenticated</span>
    <span class="n">GROUPADMIN</span> <span class="o">=</span> <span class="s2">&quot;groupadmin&quot;</span>
    <span class="n">HAPPY</span> <span class="o">=</span> <span class="s2">&quot;happy&quot;</span>  <span class="c1"># logged in, can use webview, no need to change p/w, agreed to terms  # noqa</span>
    <span class="n">MUST_AGREE_TERMS</span> <span class="o">=</span> <span class="s2">&quot;must_agree_terms&quot;</span>
    <span class="n">MUST_CHANGE_PASSWORD</span> <span class="o">=</span> <span class="s2">&quot;must_change_password&quot;</span>
    <span class="n">SUPERUSER</span> <span class="o">=</span> <span class="s2">&quot;superuser&quot;</span>


<span class="nd">@implementer</span><span class="p">(</span><span class="n">IAuthenticationPolicy</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">CamcopsAuthenticationPolicy</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># - https://docs.pylonsproject.org/projects/pyramid/en/latest/tutorials/wiki2/authorization.html  # noqa</span>
    <span class="c1"># - https://docs.pylonsproject.org/projects/pyramid-cookbook/en/latest/auth/custom.html  # noqa</span>
    <span class="c1"># - Don&#39;t actually inherit from IAuthenticationPolicy; it ends up in the</span>
    <span class="c1">#   zope.interface.interface.InterfaceClass metaclass and then breaks with</span>
    <span class="c1">#   &quot;zope.interface.exceptions.InvalidInterface: Concrete attribute, ...&quot;</span>
    <span class="c1"># - But @implementer does the trick.</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">authenticated_userid</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="s2">&quot;CamcopsRequest&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">user_id</span>

    <span class="c1"># noinspection PyUnusedLocal</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">unauthenticated_userid</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="s2">&quot;CamcopsRequest&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">effective_principals</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="s2">&quot;CamcopsRequest&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">principals</span> <span class="o">=</span> <span class="p">[</span><span class="n">Everyone</span><span class="p">]</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">principals</span> <span class="o">+=</span> <span class="p">[</span><span class="n">Authenticated</span><span class="p">,</span> <span class="s1">&#39;u:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">may_use_webviewer</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">must_change_password</span><span class="p">:</span>
                    <span class="n">principals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Permission</span><span class="o">.</span><span class="n">MUST_CHANGE_PASSWORD</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">user</span><span class="o">.</span><span class="n">must_agree_terms</span><span class="p">:</span>
                    <span class="n">principals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Permission</span><span class="o">.</span><span class="n">MUST_AGREE_TERMS</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">principals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Permission</span><span class="o">.</span><span class="n">HAPPY</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">superuser</span><span class="p">:</span>
                <span class="n">principals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Permission</span><span class="o">.</span><span class="n">SUPERUSER</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">authorized_as_groupadmin</span><span class="p">:</span>
                <span class="n">principals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Permission</span><span class="o">.</span><span class="n">GROUPADMIN</span><span class="p">)</span>
            <span class="c1"># principals.extend((&#39;g:%s&#39; % g.name for g in user.groups))</span>
        <span class="k">if</span> <span class="n">DEBUG_EFFECTIVE_PRINCIPALS</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;effective_principals: </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">principals</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">principals</span>

    <span class="c1"># noinspection PyUnusedLocal</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">remember</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="s2">&quot;CamcopsRequest&quot;</span><span class="p">,</span>
                 <span class="n">userid</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kw</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="c1"># noinspection PyUnusedLocal</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">forget</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="s2">&quot;CamcopsRequest&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="k">return</span> <span class="p">[]</span>


<span class="nd">@implementer</span><span class="p">(</span><span class="n">IAuthorizationPolicy</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">CamcopsAuthorizationPolicy</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># noinspection PyUnusedLocal</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">permits</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">ILocation</span><span class="p">,</span> <span class="n">principals</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">permission</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="n">PermitsResult</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">permission</span> <span class="ow">in</span> <span class="n">principals</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Allowed</span><span class="p">(</span><span class="s2">&quot;ALLOWED: permission </span><span class="si">{}</span><span class="s2"> present in principals &quot;</span>
                           <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">permission</span><span class="p">,</span> <span class="n">principals</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">Denied</span><span class="p">(</span><span class="s2">&quot;DENIED: permission </span><span class="si">{}</span><span class="s2"> not in principals &quot;</span>
                      <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">permission</span><span class="p">,</span> <span class="n">principals</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">principals_allowed_by_permission</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">ILocation</span><span class="p">,</span>
                                         <span class="n">permission</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Pagination</span>
<span class="c1"># =============================================================================</span>
<span class="c1"># WebHelpers 1.3 doesn&#39;t support Python 3.5.</span>
<span class="c1"># The successor to webhelpers.paginate appears to be paginate.</span>

<div class="viewcode-block" id="SqlalchemyOrmQueryWrapper"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_pyramid.html#camcops_server.cc_modules.cc_pyramid.SqlalchemyOrmQueryWrapper">[docs]</a><span class="k">class</span> <span class="nc">SqlalchemyOrmQueryWrapper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper class to access elements of an SQLAlchemy ORM query.</span>

<span class="sd">    See:</span>
<span class="sd">    - https://docs.pylonsproject.org/projects/pylons-webframework/en/latest/helpers.html  # noqa</span>
<span class="sd">    - https://docs.pylonsproject.org/projects/webhelpers/en/latest/modules/paginate.html  # noqa</span>
<span class="sd">    - https://github.com/Pylons/paginate</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">Query</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="n">query</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cut</span><span class="p">:</span> <span class="nb">slice</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># Return a range of objects of an sqlalchemy.orm.query.Query object</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">[</span><span class="n">cut</span><span class="p">]</span>
        <span class="c1"># ... will apply LIMIT/OFFSET to fetch only what we need</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="c1"># Count the number of objects in an sqlalchemy.orm.query.Query object</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">count</span><span class="p">()</span></div>


<span class="n">PAGER_PATTERN</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s1">&#39;(Page $page of $page_count; total $item_count records) &#39;</span>
    <span class="s1">&#39;[ $link_first $link_previous ~3~ $link_next $link_last ]&#39;</span>
<span class="p">)</span>


<div class="viewcode-block" id="CamcopsPage"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_pyramid.html#camcops_server.cc_modules.cc_pyramid.CamcopsPage">[docs]</a><span class="k">class</span> <span class="nc">CamcopsPage</span><span class="p">(</span><span class="n">Page</span><span class="p">):</span>
    <span class="c1"># noinspection PyShadowingBuiltins</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">collection</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Query</span><span class="p">,</span> <span class="n">Select</span><span class="p">],</span>
                 <span class="n">url_maker</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">str</span><span class="p">],</span>
                 <span class="n">page</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                 <span class="n">items_per_page</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
                 <span class="n">item_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">wrapper_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">ellipsis</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&amp;hellip;&quot;</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Bug in paginate: it slices its collection BEFORE it realizes that the</span>
        <span class="c1"># page number is out of range.</span>
        <span class="c1"># Also, it uses &quot;..&quot; for an ellipsis, which is just wrong.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ellipsis</span> <span class="o">=</span> <span class="n">ellipsis</span>
        <span class="n">page</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">item_count</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">wrapper_class</span><span class="p">:</span>
                <span class="n">item_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">wrapper_class</span><span class="p">(</span><span class="n">collection</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">item_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>
        <span class="n">n_pages</span> <span class="o">=</span> <span class="p">((</span><span class="n">item_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">items_per_page</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">page</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">n_pages</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">collection</span><span class="o">=</span><span class="n">collection</span><span class="p">,</span>
            <span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">,</span>
            <span class="n">items_per_page</span><span class="o">=</span><span class="n">items_per_page</span><span class="p">,</span>
            <span class="n">item_count</span><span class="o">=</span><span class="n">item_count</span><span class="p">,</span>
            <span class="n">wrapper_class</span><span class="o">=</span><span class="n">wrapper_class</span><span class="p">,</span>
            <span class="n">url_maker</span><span class="o">=</span><span class="n">url_maker</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="c1"># Original defines attributes outside __init__, so:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curpage_attr</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Dict[str, str]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">separator</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">link_attr</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Dict[str, str]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dotdot_attr</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Dict[str, str]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># noinspection PyShadowingBuiltins</span>
<div class="viewcode-block" id="CamcopsPage.pager"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_pyramid.html#camcops_server.cc_modules.cc_pyramid.CamcopsPage.pager">[docs]</a>    <span class="k">def</span> <span class="nf">pager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
              <span class="nb">format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">PAGER_PATTERN</span><span class="p">,</span>
              <span class="n">url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="n">show_if_single_page</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># see below!</span>
              <span class="n">separator</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="p">,</span>
              <span class="n">symbol_first</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&amp;lt;&amp;lt;&#39;</span><span class="p">,</span>
              <span class="n">symbol_last</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&amp;gt;&amp;gt;&#39;</span><span class="p">,</span>
              <span class="n">symbol_previous</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&amp;lt;&#39;</span><span class="p">,</span>
              <span class="n">symbol_next</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&amp;gt;&#39;</span><span class="p">,</span>
              <span class="n">link_attr</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="n">curpage_attr</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="n">dotdot_attr</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="n">link_tag</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1"># The reason for the default for &#39;show_if_single_page&#39; being True is</span>
        <span class="c1"># that it&#39;s possible otherwise to think you&#39;ve lost your tasks. For</span>
        <span class="c1"># example: (1) have 99 tasks; (2) view 50/page; (3) go to page 2;</span>
        <span class="c1"># (4) set number per page to 100. Or simply use the URL to go beyond</span>
        <span class="c1"># the end.</span>
        <span class="n">link_attr</span> <span class="o">=</span> <span class="n">link_attr</span> <span class="ow">or</span> <span class="p">{}</span>  <span class="c1"># type: Dict[str, str]</span>
        <span class="n">curpage_attr</span> <span class="o">=</span> <span class="n">curpage_attr</span> <span class="ow">or</span> <span class="p">{}</span>  <span class="c1"># type: Dict[str, str]</span>
        <span class="c1"># dotdot_attr = dotdot_attr or {}  # type: Dict[str, str]</span>
        <span class="c1"># dotdot_attr = dotdot_attr or {&#39;class&#39;: &#39;pager_dotdot&#39;}  # our default!</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">pager</span><span class="p">(</span>
            <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
            <span class="n">show_if_single_page</span><span class="o">=</span><span class="n">show_if_single_page</span><span class="p">,</span>
            <span class="n">separator</span><span class="o">=</span><span class="n">separator</span><span class="p">,</span>
            <span class="n">symbol_first</span><span class="o">=</span><span class="n">symbol_first</span><span class="p">,</span>
            <span class="n">symbol_last</span><span class="o">=</span><span class="n">symbol_last</span><span class="p">,</span>
            <span class="n">symbol_previous</span><span class="o">=</span><span class="n">symbol_previous</span><span class="p">,</span>
            <span class="n">symbol_next</span><span class="o">=</span><span class="n">symbol_next</span><span class="p">,</span>
            <span class="n">link_attr</span><span class="o">=</span><span class="n">link_attr</span><span class="p">,</span>
            <span class="n">curpage_attr</span><span class="o">=</span><span class="n">curpage_attr</span><span class="p">,</span>
            <span class="n">dotdot_attr</span><span class="o">=</span><span class="n">dotdot_attr</span><span class="p">,</span>
            <span class="n">link_tag</span><span class="o">=</span><span class="n">link_tag</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="c1"># noinspection PyShadowingBuiltins</span>
<div class="viewcode-block" id="CamcopsPage.link_map"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_pyramid.html#camcops_server.cc_modules.cc_pyramid.CamcopsPage.link_map">[docs]</a>    <span class="k">def</span> <span class="nf">link_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="nb">format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;~2~&#39;</span><span class="p">,</span>
                 <span class="n">url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">show_if_single_page</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">separator</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="p">,</span>
                 <span class="n">symbol_first</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&amp;lt;&amp;lt;&#39;</span><span class="p">,</span>
                 <span class="n">symbol_last</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span><span class="s1">&#39;&amp;gt;&amp;gt;&#39;</span><span class="p">,</span>
                 <span class="n">symbol_previous</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&amp;lt;&#39;</span><span class="p">,</span>
                 <span class="n">symbol_next</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s1">&#39;&amp;gt;&#39;</span><span class="p">,</span>
                 <span class="n">link_attr</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">curpage_attr</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">dotdot_attr</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fixes bugs (e.g. mutable default arguments) and nasties (e.g.</span>
<span class="sd">        enforcing &quot;..&quot; for the ellipsis) in the original.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curpage_attr</span> <span class="o">=</span> <span class="n">curpage_attr</span> <span class="ow">or</span> <span class="p">{}</span>  <span class="c1"># type: Dict[str, str]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">separator</span> <span class="o">=</span> <span class="n">separator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">link_attr</span> <span class="o">=</span> <span class="n">link_attr</span> <span class="ow">or</span> <span class="p">{}</span>  <span class="c1"># type: Dict[str, str]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dotdot_attr</span> <span class="o">=</span> <span class="n">dotdot_attr</span> <span class="ow">or</span> <span class="p">{}</span>  <span class="c1"># type: Dict[str, str]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>

        <span class="n">regex_res</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;~(\d+)~&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">regex_res</span><span class="p">:</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="n">regex_res</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="n">radius</span>

        <span class="c1"># Compute the first and last page number within the radius</span>
        <span class="c1"># e.g. &#39;1 .. 5 6 [7] 8 9 .. 12&#39;</span>
        <span class="c1"># -&gt; leftmost_page  = 5</span>
        <span class="c1"># -&gt; rightmost_page = 9</span>
        <span class="n">leftmost_page</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">first_page</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span> <span class="o">-</span> <span class="n">radius</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_page</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="n">rightmost_page</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_page</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">+</span><span class="n">radius</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_page</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="n">nav_items</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;first_page&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;last_page&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;previous_page&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;next_page&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;current_page&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;radius&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span>
            <span class="s2">&quot;range_pages&quot;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>  <span class="c1"># type: Dict[str, Any]</span>

        <span class="k">if</span> <span class="n">leftmost_page</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">rightmost_page</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">nav_items</span>

        <span class="n">nav_items</span><span class="p">[</span><span class="s2">&quot;first_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;first_page&quot;</span><span class="p">,</span>
            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">symbol_first</span><span class="p">,</span>
            <span class="s2">&quot;attrs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_attr</span><span class="p">,</span>
            <span class="s2">&quot;number&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_page</span><span class="p">,</span>
            <span class="s2">&quot;href&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_maker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">first_page</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="c1"># Insert dots if there are pages between the first page</span>
        <span class="c1"># and the currently displayed page range</span>
        <span class="k">if</span> <span class="n">leftmost_page</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_page</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Wrap in a SPAN tag if dotdot_attr is set</span>
            <span class="n">nav_items</span><span class="p">[</span><span class="s2">&quot;range_pages&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;span&quot;</span><span class="p">,</span>
                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ellipsis</span><span class="p">,</span>
                <span class="s2">&quot;attrs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dotdot_attr</span><span class="p">,</span>
                <span class="s2">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;number&quot;</span><span class="p">:</span> <span class="kc">None</span>
            <span class="p">})</span>

        <span class="k">for</span> <span class="n">thispage</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">leftmost_page</span><span class="p">,</span> <span class="n">rightmost_page</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># Highlight the current page number and do not use a link</span>
            <span class="k">if</span> <span class="n">thispage</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="p">:</span>
                <span class="c1"># Wrap in a SPAN tag if curpage_attr is set</span>
                <span class="n">nav_items</span><span class="p">[</span><span class="s2">&quot;range_pages&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;current_page&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">thispage</span><span class="p">),</span>
                    <span class="s2">&quot;number&quot;</span><span class="p">:</span> <span class="n">thispage</span><span class="p">,</span>
                    <span class="s2">&quot;attrs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">curpage_attr</span><span class="p">,</span>
                    <span class="s2">&quot;href&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_maker</span><span class="p">(</span><span class="n">thispage</span><span class="p">)</span>
                <span class="p">})</span>
                <span class="n">nav_items</span><span class="p">[</span><span class="s2">&quot;current_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">thispage</span><span class="p">,</span>
                    <span class="s2">&quot;attrs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">curpage_attr</span><span class="p">,</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;current_page&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;href&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_maker</span><span class="p">(</span><span class="n">thispage</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="c1"># Otherwise create just a link to that page</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nav_items</span><span class="p">[</span><span class="s2">&quot;range_pages&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;page&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">thispage</span><span class="p">),</span>
                    <span class="s2">&quot;number&quot;</span><span class="p">:</span> <span class="n">thispage</span><span class="p">,</span>
                    <span class="s2">&quot;attrs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_attr</span><span class="p">,</span>
                    <span class="s2">&quot;href&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_maker</span><span class="p">(</span><span class="n">thispage</span><span class="p">)</span>
                <span class="p">})</span>

        <span class="c1"># Insert dots if there are pages between the displayed</span>
        <span class="c1"># page numbers and the end of the page range</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_page</span> <span class="o">-</span> <span class="n">rightmost_page</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Wrap in a SPAN tag if dotdot_attr is set</span>
            <span class="n">nav_items</span><span class="p">[</span><span class="s2">&quot;range_pages&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;span&quot;</span><span class="p">,</span>
                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ellipsis</span><span class="p">,</span>
                <span class="s2">&quot;attrs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dotdot_attr</span><span class="p">,</span>
                <span class="s2">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;number&quot;</span><span class="p">:</span> <span class="kc">None</span>
            <span class="p">})</span>

        <span class="c1"># Create a link to the very last page (unless we are on the last</span>
        <span class="c1"># page or there would be no need to insert &#39;..&#39; spacers)</span>
        <span class="n">nav_items</span><span class="p">[</span><span class="s2">&quot;last_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;last_page&quot;</span><span class="p">,</span>
            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">symbol_last</span><span class="p">,</span>
            <span class="s2">&quot;attrs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_attr</span><span class="p">,</span>
            <span class="s2">&quot;href&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_maker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_page</span><span class="p">),</span>
            <span class="s2">&quot;number&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_page</span>
        <span class="p">}</span>
        <span class="n">nav_items</span><span class="p">[</span><span class="s2">&quot;previous_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;previous_page&quot;</span><span class="p">,</span>
            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">symbol_previous</span><span class="p">,</span>
            <span class="s2">&quot;attrs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_attr</span><span class="p">,</span>
            <span class="s2">&quot;number&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">previous_page</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_page</span><span class="p">,</span>
            <span class="s2">&quot;href&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_maker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_page</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_page</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">nav_items</span><span class="p">[</span><span class="s2">&quot;next_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;next_page&quot;</span><span class="p">,</span>
            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">symbol_next</span><span class="p">,</span>
            <span class="s2">&quot;attrs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_attr</span><span class="p">,</span>
            <span class="s2">&quot;number&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_page</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_page</span><span class="p">,</span>
            <span class="s2">&quot;href&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_maker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">next_page</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_page</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">nav_items</span></div></div>


<div class="viewcode-block" id="SqlalchemyOrmPage"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_pyramid.html#camcops_server.cc_modules.cc_pyramid.SqlalchemyOrmPage">[docs]</a><span class="k">class</span> <span class="nc">SqlalchemyOrmPage</span><span class="p">(</span><span class="n">CamcopsPage</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A pagination page that deals with SQLAlchemy ORM objects.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">query</span><span class="p">:</span> <span class="n">Query</span><span class="p">,</span>
                 <span class="n">url_maker</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">str</span><span class="p">],</span>
                 <span class="n">page</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                 <span class="n">items_per_page</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_ROWS_PER_PAGE</span><span class="p">,</span>
                 <span class="n">item_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Since views may accidentally throw strings our way:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">items_per_page</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item_count</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">item_count</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">collection</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
            <span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">,</span>
            <span class="n">items_per_page</span><span class="o">=</span><span class="n">items_per_page</span><span class="p">,</span>
            <span class="n">item_count</span><span class="o">=</span><span class="n">item_count</span><span class="p">,</span>
            <span class="n">wrapper_class</span><span class="o">=</span><span class="n">SqlalchemyOrmQueryWrapper</span><span class="p">,</span>
            <span class="n">url_maker</span><span class="o">=</span><span class="n">url_maker</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span></div>


<span class="c1"># From webhelpers.paginate (which is broken on Python 3.5, but good),</span>
<span class="c1"># modified a bit:</span>

<div class="viewcode-block" id="make_page_url"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_pyramid.html#camcops_server.cc_modules.cc_pyramid.make_page_url">[docs]</a><span class="k">def</span> <span class="nf">make_page_url</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">page</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                  <span class="n">partial</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">sort</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A helper function for URL generators.</span>

<span class="sd">    I assemble a URL from its parts. I assume that a link to a certain page is</span>
<span class="sd">    done by overriding the &#39;page&#39; query parameter.</span>

<span class="sd">    ``path`` is the current URL path, with or without a &quot;scheme://host&quot; prefix.</span>

<span class="sd">    ``params`` is the current query parameters as a dict or dict-like object.</span>

<span class="sd">    ``page`` is the target page number.</span>

<span class="sd">    If ``partial`` is true, set query param &#39;partial=1&#39;. This is to for AJAX</span>
<span class="sd">    calls requesting a partial page.</span>

<span class="sd">    If ``sort`` is true (default), the parameters will be sorted. Otherwise</span>
<span class="sd">    they&#39;ll be in whatever order the dict iterates them.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span>
    <span class="k">if</span> <span class="n">partial</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;partial&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>
    <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="n">qs</span> <span class="o">=</span> <span class="n">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>  <span class="c1"># was urllib.urlencode, but changed in Py3.5</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">?</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">qs</span><span class="p">)</span></div>


<div class="viewcode-block" id="PageUrl"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_pyramid.html#camcops_server.cc_modules.cc_pyramid.PageUrl">[docs]</a><span class="k">class</span> <span class="nc">PageUrl</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A page URL generator for WebOb-compatible Request objects.</span>

<span class="sd">    I derive new URLs based on the current URL but overriding the &#39;page&#39;</span>
<span class="sd">    query parameter.</span>

<span class="sd">    I&#39;m suitable for Pyramid, Pylons, and TurboGears, as well as any other</span>
<span class="sd">    framework whose Request object has &#39;application_url&#39;, &#39;path&#39;, and &#39;GET&#39;</span>
<span class="sd">    attributes that behave the same way as ``webob.Request``&#39;s.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="s2">&quot;Request&quot;</span><span class="p">,</span> <span class="n">qualified</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ``request`` is a WebOb-compatible ``Request`` object.</span>

<span class="sd">        If ``qualified`` is false (default), generated URLs will have just the</span>
<span class="sd">        path and query string. If true, the &quot;scheme://host&quot; prefix will be</span>
<span class="sd">        included. The default is false to match traditional usage, and to avoid</span>
<span class="sd">        generating unuseable URLs behind reverse proxies (e.g., Apache&#39;s</span>
<span class="sd">        mod_proxy).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qualified</span> <span class="o">=</span> <span class="n">qualified</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">page</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">partial</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate a URL for the specified page.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qualified</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">application_url</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">path</span>
        <span class="k">return</span> <span class="n">make_page_url</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">partial</span><span class="p">)</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Debugging requests and responses</span>
<span class="c1"># =============================================================================</span>

<span class="k">def</span> <span class="nf">get_body_from_request</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Attempting to read body from request -- but a previous read &quot;</span>
                <span class="s2">&quot;may have left this empty. Consider using Wireshark!&quot;</span><span class="p">)</span>
    <span class="n">wsgi_input</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">WsgiEnvVar</span><span class="o">.</span><span class="n">WSGI_INPUT</span><span class="p">]</span>
    <span class="c1"># ... under gunicorn, is an instance of gunicorn.http.body.Body</span>
    <span class="k">return</span> <span class="n">wsgi_input</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>


<div class="viewcode-block" id="HTTPFoundDebugVersion"><a class="viewcode-back" href="../../../autodoc/cc_modules/cc_pyramid.html#camcops_server.cc_modules.cc_pyramid.HTTPFoundDebugVersion">[docs]</a><span class="k">class</span> <span class="nc">HTTPFoundDebugVersion</span><span class="p">(</span><span class="n">HTTPFound</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For debugging redirections.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Redirecting to </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../../../index.html">Table Of Contents</a></h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/download.html">2. Downloading CamCOPS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../client/client_installation.html">3. Installing and configuring the client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../client/client_using.html">4. Using the client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../server/server_front_end_general.html">5. Web site: general use</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tasks/_tasks_by_category.html">6. Tasks in CamCOPS by category</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tasks/_tasks_all.html">7. All tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../client/client_troubleshooting.html">8. Troubleshooting client problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../server/server_installation.html">9. Installing CamCOPS on the server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../server/server_configuration.html">10. Configuring the server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../server/server_config_file.html">11. The CamCOPS server configuration file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../server/server_front_end_admin.html">12. Web site: admin functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../server/server_command_line.html">13. CamCOPS command-line tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../server/server_troubleshooting.html">14. Troubleshooting server problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../licences/licences.html">15. Licences</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer/index.html">16. Developer notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/tcpip_ports.html">17. Common relevant TCP/IP ports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/linux_flavours.html">18. Linux flavours</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autodoc/_index.html">19. Automatic documentation of core server source code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">20. Change log/history</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq_known_problems.html">21. FAQ and known problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../to_do.html">22. Things to do</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../wishlist.html">23. Wishlist and blue-sky thoughts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/local_info.html">24. Local configuration information</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">CamCOPS 2.2.4 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2012-2018, Rudolf Cardinal.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.5.
    </div>
  </body>
</html>